<!DOCTYPE html>
<html lang="en">

<head>
    <title>Finanzas</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="Luz Collado" content="codedthemes">


    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
        id="main-font-link">

    <link rel="stylesheet" href="tabler-icons.min.css">

    <link rel="stylesheet" href="feather.css">

    <link rel="stylesheet" href="fontawesome.css">

    <link rel="stylesheet" href="material.css">

    <link rel="stylesheet" href="style.css" id="main-style-link">
    <link rel="stylesheet" href="style-preset.css">

    <style>
        .bg-green {
            background-color: green;
        }

        .bg-red {
            background-color: rgb(167, 15, 15);
        }

        .bg-mint-green {
            background-color: #6bc8e4;
        }

        .bg-gray {
            background-color: gray;
        }

        .disabled {
            color: gray;
            cursor: default;
        }

        .notification {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .notification .fas {
            margin-right: 10px;
        }

        .notification .message-container {
            display: inline-block;
        }

        .notification .message {
            font-size: 14px;
        }

        .low-stock {
            background-color: #ffeaa7;

        }

        .expiry-warning {
            background-color: #ff7675;

        }

        .expired {
            background-color: #d63031;

        }

        .success {
            background-color: #8aeb7d;

            color: #050505;

        }

        .filter-input {
            width: 150px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        /* Estilos para el placeholder del campo de entrada */
        .filter-input::placeholder {
            color: #aaa;
        }

        /* Estilos cuando el campo de entrada está enfocado */
        .filter-input:focus {
            border-color: #5c9ed6;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .text-dark-blue {
            color: darkblue;
        }

        .btn-dark-blue {
            background-color: darkblue;
            color: white;
            border: none;
            transition: background-color 0.3s ease;

        }

        .btn-dark-red {
            background-color: rgb(180, 13, 13);
            color: white;
            border: none;
            transition: background-color 0.3s ease;

        }

        .btn-dark-red:hover {
            background-color: rgb(148, 15, 15);

        }

        .btn-dark-blue:hover {
            background-color: navy;

        }

        .btn-dark-green {
            background-color: rgb(12, 97, 9);
            color: white;
            border: none;
            transition: background-color 0.3s ease;

        }

        .btn-dark-green:hover {
            background-color: rgb(4, 97, 24);

        }

        .formulario-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            width: 600px;

            max-height: 80%;

            overflow-y: auto;

        }



        #fondoDesenfocado {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;

        }

        #formularioPago {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            width: 90%;
            /* Ajustado para pantallas más pequeñas */
            max-width: 800px;
            /* Máximo ancho para pantallas grandes */
            max-height: 80%;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 1.5rem;
            /* Ajustar tamaño del texto */
            padding: 10px;
            /* Espaciado alrededor del botón */
            background: none;
            border: none;
        }

        #formularioPagoCuentasPorPagar {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            width: 800px;
            max-height: 80%;
            overflow-y: auto;
        }

        #formularioPagoCuentasPorPagar .formulario-contenido {
            position: relative;
        }

        #formularioPagoCuentasPorPagar .close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        .table {
            width: 100%;
            margin-bottom: 1rem;
            color: #212529;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 0.75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }

        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid #dee2e6;
        }

        .table tbody+tbody {
            border-top: 2px solid #dee2e6;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .table-hover tbody tr:hover {
            color: #212529;
            background-color: rgba(0, 0, 0, 0.075);
        }

        .table-striped tbody tr:nth-of-type(even) {
            background-color: #f9f9f9;
        }




        @media only screen and (max-width: 768px) {
            table {
                font-size: 0.8em;
            }

            .form-control {
                font-size: 0.8em;
            }
        }

        @media only screen and (max-width: 480px) {
            table {
                font-size: 0.6em;
            }

            .form-control {
                font-size: 0.6em;
            }
        }

        @media (max-width: 768px) {
            .formulario-container {
                width: 100%;
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }

            .col-md-6 {
                width: 100%;
            }

            .form-floating {
                width: 100%;
            }

            .form-check {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .form-control {
                font-size: 16px;
                padding: 10px;
            }

            .form-label {
                font-size: 16px;
            }
        }

        @media (max-width: 768px) {
            .card-header form {
                flex-direction: column;
            }

            .card-header input[type="search"] {
                width: 100%;
                margin-bottom: 10px;
            }

            .card-header button[type="button"] {
                width: 100%;
                margin-bottom: 10px;
            }
        }


        @media (max-width: 768px) {
            .card-header input[type="search"] {
                font-size: 16px;
                padding: 10px;
            }

            .card-header button[type="button"] {
                font-size: 16px;
                padding: 10px;
            }
        }

        .loader {
            --r1: 154%;
            --r2: 68.5%;
            width: 40px;
            aspect-ratio: 1;
            border-radius: 50%;
            background:
                radial-gradient(var(--r1) var(--r2) at top, #0000 79.5%, #269af2 80%),
                radial-gradient(var(--r1) var(--r2) at bottom, #269af2 79.5%, #0000 80%),
                radial-gradient(var(--r1) var(--r2) at top, #0000 79.5%, #269af2 80%),
                #ccc;
            background-size: 50.5% 220%;
            background-position: -100% 0%, 0% 0%, 100% 0%;
            background-repeat: no-repeat;
            animation: l9 2s infinite linear;
        }

        @keyframes l9 {
            33% {
                background-position: 0% 33%, 100% 33%, 200% 33%;
            }

            66% {
                background-position: -100% 66%, 0% 66%, 100% 66%;
            }

            100% {
                background-position: 0% 100%, 100% 100%, 200% 100%;
            }
        }

        @media only screen and (max-width: 768px) {
            #formularioPago {
                width: 95%;
                /* Ajusta el ancho para pantallas pequeñas */
                padding: 10px;
            }

            .formulario-contenido {
                padding: 5px;
            }

            .table th,
            .table td {
                font-size: 0.8em;
                /* Ajusta el tamaño del texto en la tabla */
                padding: 0.5rem;
                /* Ajusta el padding en celdas */
            }
        }

        /* Adaptaciones para pantallas muy pequeñas */
        @media only screen and (max-width: 480px) {
            #formularioPago {
                width: 100%;
                /* Ajusta el ancho para pantallas muy pequeñas */
                padding: 5px;
            }

            .formulario-contenido {
                padding: 2px;
            }

            .table th,
            .table td {
                font-size: 0.7em;
                /* Ajusta el tamaño del texto en la tabla */
                padding: 0.25rem;
                /* Ajusta el padding en celdas */
            }
        }

        /* HTML: <div class="loader"></div> */
        .loaderr {
            width: 40px;
            padding: 8px;
            aspect-ratio: 1;
            border-radius: 50%;
            background: #25b09b;
            --_m:
                conic-gradient(#0000 10%, #000),
                linear-gradient(#000 0 0) content-box;
            -webkit-mask: var(--_m);
            mask: var(--_m);
            -webkit-mask-composite: source-out;
            mask-composite: subtract;
            animation: l3 1s infinite linear;
        }

        @keyframes l3 {
            to {
                transform: rotate(1turn)
            }
        }
        
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-style/0.8.13/xlsx-style.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.1/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

</head>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const userCreds = sessionStorage.getItem("user-creds");
        if (!userCreds && window.location.pathname.includes('finanzas')) {
            window.location.href = 'login';
        }

    });
</script>

<body>

    <div class="loader-bg">
        <div class="loader-track">
            <div class="loader-fill"></div>
        </div>
    </div>

    <nav class="pc-sidebar">
        <div class="navbar-wrapper">
            <div class="m-header">
                <a href="home" class="b-brand text-primary">
                    <img src="Designer (7).jpeg" style="width: 90px; height: 90px; border-radius: 5px;" alt="...">
                </a>
            </div>

            <div class="navbar-content">
                <ul class="pc-navbar">
                    <li class="pc-item pc-caption">
                        <label>Dashboard</label>
                        <i class="ti ti-dashboard"></i>
                    </li>
                    <li class="pc-item">
                        <a href="home" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-dashboard"></i></span>
                            <span class="pc-mtext">Sistema</span>
                        </a>
                    </li>
                    <li class="pc-item pc-caption">
                        <label>Empresa</label>
                        <i class="ti ti-dashboard"></i>
                    </li>
                    <li class="pc-item">
                        <a href="info" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-clipboard-list"></i></span>
                            <span class="pc-mtext">Datos</span>
                        </a>
                    </li>
                    <li class="pc-item">
                        <a href="employees" class="pc-link disabled" id="empleados">
                            <span class="pc-micon"><i class="ti ti-friends"></i></span>
                            <span class="pc-mtext">Empleados</span>
                        </a>
                    </li>
                    <li class="pc-item">
                        <a href="finanzas" class="pc-link disabled" id="finanzas">
                            <span class="pc-micon"><i class="ti ti-report-money"></i></span>
                            <span class="pc-mtext">Finanzas</span>
                        </a>
                    </li>

                </ul>
            </div>
        </div>
    </nav>

    <header class="pc-header">
        <div class="header-wrapper">

            <div class="ms-auto">
                <ul class="list-unstyled">
                    <li class="pc-h-item header-mobile-collapse">
                        <a href="#" class="pc-head-link head-link-secondary ms-0" id="sidebar-hide">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="pc-h-item pc-sidebar-popup">
                        <a href="#" class="pc-head-link head-link-secondary ms-0" id="mobile-collapse">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <!-- <li class="dropdown pc-h-item">
            <a class="pc-head-link head-link-secondary dropdown-toggle arrow-none me-0" data-bs-toggle="dropdown"
              href="#" role="button" aria-haspopup="false" aria-expanded="false">
              <i class="ti ti-bell"></i>
            </a>
            <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown">
              <div class="dropdown-header">
                <a href="#!" class="link-primary float-end text-decoration-underline">Mark as all read</a>
                <h5>All Notification <span class="badge bg-warning rounded-pill ms-1">01</span></h5>
              </div>
              <div class="dropdown-header px-0 text-wrap header-notification-scroll position-relative"
                style="max-height: calc(100vh - 215px)">
                <div class="list-group list-group-flush w-100">
                  <div class="list-group-item list-group-item-action">
                    <div class="d-flex">
                      <div class="flex-shrink-0">
                        <div class="user-avtar bg-light-success"><i class="ti ti-building-store"></i></div>
                      </div>
                      <div class="flex-grow-1 ms-1">
                        <span class="float-end text-muted">3 min ago</span>
                        <h5>Store Verification Done</h5>
                        <p class="text-body fs-6">We have successfully received your request.</p>
                        <div class="badge rounded-pill bg-light-danger">Unread</div>
                      </div>
                    </div>
                  </div>
                  <div class="list-group-item list-group-item-action">
                    <div class="d-flex">
                      <div class="flex-shrink-0">
                        <img src="../assets/images/user/avatar-3.jpg" alt="user-image" class="user-avtar">
                      </div>
                      <div class="flex-grow-1 ms-1">
                        <span class="float-end text-muted">10 min ago</span>
                        <h5>Joseph William</h5>
                        <p class="text-body fs-6">It is a long established fact that a reader will be distracted </p>
                        <div class="badge rounded-pill bg-light-success">Confirmation of Account</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="dropdown-divider"></div>
              <div class="text-center py-2">
                <a href="#!" class="link-primary">Mark as all read</a>
              </div>
            </div>
          </li> -->
                    <li class="dropdown pc-h-item header-user-profile">
                        <a class="pc-head-link head-link-primary dropdown-toggle arrow-none me-0"
                            data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false"
                            aria-expanded="false">
                            <img src="Designer (7).jpeg" style="width: 50px; height: 50px; border-radius: 50%;" />

                            <span>
                                <i class="ti ti-settings"></i>
                            </span>
                        </a>
                        <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown">
                            <div class="dropdown-header">
                                <h4>Hola, <span class="small text-muted" id="username"> Name</span></h4>
                                <p class="text-muted" id="role">Rol</p>
                                <hr>
                                <div class="profile-notification-scroll position-relative"
                                    style="max-height: calc(100vh - 280px)">
                                    <hr>
                                    <button id="settingsButton" type="submit" class="dropdown-item">
                                        <i class="ti ti-settings"></i>
                                        <span>Configuración</span>
                                    </button>
                                    <button id="registerButton" type="submit" class="dropdown-item">
                                        <i class="ti ti-user-plus"></i>
                                        <span>Registro</span>
                                    </button>
                                    <button class="dropdown-item" id="signoutbutton">
                                        <i class="ti ti-logout"></i>
                                        <span>Cerrar Sesión</span>
                                    </button>

                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="pc-container">
        <div class="pc-content">

            <div class="row">

                <div class="col-xl-4 col-md-12">

                    <div class="card dashnum-card dashnum-card-small text-white overflow-hidden" id="NotaDeCredito">
                        <span class="round bg-primary small"></span>
                        <span class="round bg-primary big"></span>
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avtar avtar-lg bg-light-primary">
                                    <i class="text-primary ti ti-currency-dollar"></i>
                                </div>
                                <div class="ms-2">
                                    <h4 class="mb-1">Nota de Crédito <i
                                            class="ti ti-arrow-up-right-circle opacity-50"></i></h4>
                                    <p class="mb-0 opacity-50 text-sm"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card dashnum-card dashnum-card-small overflow-hidden" id="openHistorialFacturas">
                        <span class="round bg-warning small"></span>
                        <span class="round bg-warning big"></span>
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avtar avtar-lg bg-light-warning">
                                    <i class="text-warning ti ti-currency-dollar"></i>
                                </div>
                                <div class="ms-2">
                                    <h4 class="mb-1">Facturas <i class="ti ti-arrow-up-right-circle opacity-50"></i>
                                    </h4>
                                    <p class="mb-0 opacity-50 text-sm"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card dashnum-card dashnum-card-small overflow-hidden" id="Cuentasporcobrar">
                        <span class="round bg-info small"></span>
                        <span class="round bg-info big"></span>
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avtar avtar-lg bg-light-info">
                                    <i class="text-info ti ti-currency-dollar"></i>
                                </div>
                                <div class="ms-2">
                                    <h4 class="mb-1">Cuentas por Cobrar <i
                                            class="ti ti-arrow-up-right-circle opacity-50"></i>
                                    </h4>
                                    <p class="mb-0 opacity-50 text-sm"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card dashnum-card dashnum-card-small overflow-hidden" id="CuentasporPagar">
                        <span class="round bg-danger small"></span>
                        <span class="round bg-danger big"></span>
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <div class="avtar avtar-lg bg-light-danger">
                                    <i class="text-danger ti ti-currency-dollar"></i>
                                </div>
                                <div class="ms-2">
                                    <h4 class="mb-1">Cuentas por Pagar <i
                                            class="ti ti-arrow-up-right-circle opacity-50"></i></h4>
                                    <p class="mb-0 opacity-50 text-sm"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card dashnum-card dashnum-card-small overflow-hidden" id="CatalogoCuentas">
                        <span class="round bg-success small"></span>
                        <span class="round bg-success big"></span>
                        <div class="card-body p-3" onclick="window.location.href='catalogo-de-cuentas'"
                            style="cursor: pointer;">
                            <div class="d-flex align-items-center">
                                <div class="avtar avtar-lg bg-light-success">
                                    <i class="text-success ti ti-book"></i>
                                </div>
                                <div class="ms-2">
                                    <h4 class="mb-1">Catálogo de Cuentas <i
                                            class="ti ti-arrow-up-right-circle opacity-50"></i></h4>
                                    <p class="mb-0 opacity-50 text-sm"></p>
                                </div>
                            </div>
                        </div>
                    </div>




                </div>
                <div class="col-xl-4 col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3 align-items-center">
                                <div class="col">
                                    <h4>Ganancias (40%)</h4>
                                </div>
                                <div class="col-auto">
                                    <input type="search" id="filterDate" class="form-control filter-input"
                                        placeholder="mm/yyyy" style="margin-right: 5px;" />
                                </div>
                                <div class="col-auto">
                                    <button id="generateExcelButtonI" type="button"
                                        class="btn btn-dark-green btn-sm fa-solid fa-file-excel"
                                        style="padding: 10px 20px;"></button>
                                    <div id="loaderExcel" class="loaderr" style="display: none;"></div>
                                </div>
                            </div>
                            <div class="rounded bg-light-secondary overflow-hidden mb-3">
                                <div class="px-3 pt-3">
                                    <div class="row mb-1 align-items-start">
                                        <div class="col">
                                            <h5 class="text-secondary mb-0">Total Ganancias</h5>
                                            <small class="text-muted">Ganancias del mes seleccionado</small>
                                        </div>
                                        <div class="col-auto">
                                            <h4 id="totalEarnings" class="mb-0">$0.00</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <ul class="list-group list-group-flush" id="earningsList">
                                <!-- Aquí se insertarán las ganancias -->
                            </ul>
                            <!-- <div class="text-center">
                                <a href="#!" class="b-b-primary text-primary">View all <i
                                        class="ti ti-chevron-right"></i></a>
                            </div> -->
                        </div>
                    </div>
                </div>

                <div class="col-xl-4 col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row mb-3 align-items-center">
                                <div class="col">
                                    <h4>Gastos</h4>
                                </div>
                                <div class="col-auto">
                                    <input type="search" id="filterDateE" class="filter-input" placeholder="mm/yyyy" />
                                </div>
                                <div class="col-auto">
                                    <button id="generateExcelButtonE" type="button"
                                        class="btn btn-dark-green btn-sm fa-solid fa-file-excel"
                                        style="padding: 10px 20px;"></button>
                                    <div id="loaderExcel2" class="loaderr" style="display: none;"></div>
                                </div>
                            </div>
                            <div class="rounded bg-light-secondary overflow-hidden mb-3">
                                <div class="px-3 pt-3">
                                    <div class="row mb-1 align-items-start">
                                        <div class="col">
                                            <h5 class="text-secondary mb-0">Total Gastos</h5>
                                            <small class="text-muted">Gastos del mes seleccionado</small>
                                        </div>
                                        <div class="col-auto">
                                            <h4 id="totalExpenses" class="mb-0">$0.00</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <ul class="list-group list-group-flush" id="expensesList">
                                <!-- Aquí se insertarán los egresos -->
                            </ul>
                            <!-- <div class="text-center">
                                <a href="#!" class="b-b-primary text-primary">View all <i
                                        class="ti ti-chevron-right"></i></a>
                            </div> -->
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>
    </div>

    <div id="HistorialFacturasG" class="formulario-container" style="display: none; width: 60%; margin: 0 auto;">
        <h3 class="mb-3">Historial General de Facturas</h3>
        <div class="card-header">
            <form id="MainFormSEG" class="d-flex" style="max-width: 400px;">
                <input id="searchInputG" class="form-control me-sm-2" type="search" placeholder="Buscar No. Factura"
                    style="flex: 1 0 auto;">

                <div class="col-auto">
                    <button id="generateExcelButtonF" type="button"
                        class="btn btn-dark-green btn-sm fa-solid fa-file-excel" style="padding: 10px 20px;"></button>
                    <div id="loaderExcel1" class="loaderr" style="display: none;"></div>
                </div>
            </form>
        </div>
        <div id="listaFacturasG" class="lista-facturas"></div>
        <div>
            <ul class="pagination" id="paginationG">
                <li class="page-item" id="previousPageG"><a class="page-link" href="#">&laquo;</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">4</a></li>
                <li class="page-item"><a class="page-link" href="#">5</a></li>
                <li class="page-item" id="nextPageG"><a class="page-link" href="#">&raquo;</a></li>
            </ul>
        </div>
        <div class="d-grid mt-2">
            <button type="button" class="btn btn-danger" id="closeHistorialButtonG">Cerrar</button>
        </div>
    </div>

    <div id="HistorialCuentasPorCobrar" class="formulario-container" style="display: none; width: 60%; margin: 0 auto;">
        <h3 class="mb-3">Historial General de Cuentas por Cobrar</h3>
        <div class="card-header">
            <form id="MainFormCuentasPorCobrar" class="d-flex" style="max-width: 400px;">
                <input id="searchInputCuentasPorCobrar" class="form-control me-sm-2" type="search"
                    placeholder="Buscar No. Factura" style="flex: 1 0 auto;">
                <div class="col-auto">
                    <!-- <button id="generateExcelButtonCuentasPorCobrar" type="button"
                        class="btn btn-dark-green btn-sm fa-solid fa-file-excel" style="padding: 10px 20px;"></button> -->
                </div>
            </form>
        </div>
        <div id="listaCuentasPorCobrar" class="lista-facturas"></div>
        <div>
            <ul class="pagination" id="paginationCuentasPorCobrar">
                <li class="page-item" id="previousPageCuentasPorCobrar"><a class="page-link" href="#">&laquo;</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">4</a></li>
                <li class="page-item"><a class="page-link" href="#">5</a></li>
                <li class="page-item" id="nextPageCuentasPorCobrar"><a class="page-link" href="#">&raquo;</a></li>
            </ul>
        </div>
        <div class="d-grid mt-2">
            <button type="button" class="btn btn-danger" id="closeHistorialButtonCuentasPorCobrar">Cerrar</button>
        </div>
    </div>

    <div id="formularioPago" style="display:none;">
        <div class="formulario-contenido">
            <span id="closeFormularioPago" class="close">&times;</span>
            <h2>Detalles de la Factura</h2>
            <p>Cliente: <span id="facturaCliente"></span></p>
            <p>Estatus: <span id="facturaEstatus"></span></p>
            <p>Fecha: <span id="facturaFecha"></span></p>
            <p>Total: <span id="facturaTotal"></span></p>
            <p>Items: <span id="facturaItems"></span></p>
            <p>Número de Factura: <span id="facturaNumero"></span></p>
            <h3>Pagos</h3>
            <table id="listaPagos" class="table table-striped">
                <tbody>
                    <!-- Aquí se llenarán las filas de pagos -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="HistorialCuentasPorPagar" class="formulario-container" style="display: none; width: 60%; margin: 0 auto;">
        <h3 class="mb-3">Historial General de Cuentas por Pagar</h3>
        <div class="card-header">
            <form id="MainFormCuentasPorPagar" class="d-flex" style="max-width: 400px;">
                <input id="searchInputCuentasPorPagar" class="form-control me-sm-2" type="search"
                    placeholder="Buscar No. Factura" style="flex: 1 0 auto;">
                <div class="col-auto">
                    <!-- <button id="generateExcelButtonCuentasPorPagar" type="button"
                        class="btn btn-dark-green btn-sm fa-solid fa-file-excel" style="padding: 10px 20px;"></button> -->
                </div>
            </form>
        </div>
        <div id="listaCuentasPorPagar" class="lista-facturas" style="max-height: 300px; overflow-y: auto;"></div>
        <div>
            <ul class="pagination" id="paginationCuentasPorPagar">
                <li class="page-item" id="previousPageCuentasPorPagar"><a class="page-link" href="#">&laquo;</a></li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item"><a class="page-link" href="#">4</a></li>
                <li class="page-item"><a class="page-link" href="#">5</a></li>
                <li class="page-item" id="nextPageCuentasPorPagar"><a class="page-link" href="#">&raquo;</a></li>
            </ul>
        </div>
        <div class="d-grid mt-2">
            <button type="button" class="btn btn-danger" id="closeHistorialButtonCuentasPorPagar">Cerrar</button>
        </div>
    </div>

    <div id="formularioPagoCuentasPorPagar" style="display:none;">
        <div class="formulario-contenido">
            <span id="closeFormularioPagoCuentasPorPagar" class="close">&times;</span>
            <h2>Detalles de la Compra</h2>
            <p>Suplidor: <span id="facturaSuplidor"></span></p>
            <p>Estatus: <span id="facturaEstatusP"></span></p>
            <p>Fecha: <span id="facturaFechaP"></span></p>
            <p>Total: <span id="facturaTotalP"></span></p>
            <!-- <p>Items: <span id="facturaItemsP"></span></p> -->
            <p>Número de Factura: <span id="facturaNumeroP"></span></p>
            <h3>Pagos</h3>
            <table id="listaPagosCuentasPorPagar" class="table table-striped">
                <tbody>
                    <!-- Aquí se llenarán las filas de pagos -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="formularioNotaCredito" class="formulario-container" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5>Generar Nota de Crédito</h5>
            </div>
            <div class="card-body">
                <form id="notaCreditoForm">
                    <div class="form-floating mb-3">
                        <select class="form-select" id="facturaSelect" aria-label="Seleccionar Factura">
                            <option selected>Elegir Factura</option>
                            <!-- Las facturas se cargarán aquí -->
                        </select>
                        <label for="facturaSelect">*Elegir Factura</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="comprobanteFiscalFactura"
                            placeholder="Comprobante Fiscal de la Factura" readonly>
                        <label for="comprobanteFiscalFactura">*Comprobante Fiscal de la Factura</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="cliente" placeholder="Concepto">
                        <label for="cliente">*Cliente</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="number" class="form-control" id="monto" placeholder="Monto">
                        <label for="monto">*Monto</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="text" class="form-control" id="concepto" placeholder="Concepto">
                        <label for="concepto">*Concepto</label>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-success" id="generarNotaCreditoButton">Generar Nota de
                            Crédito</button>
                    </div>
                    <div class="d-grid mt-2">
                        <button type="button" class="btn btn-danger" id="closeNotaCreditoButton">Cerrar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    </div>
    </div>



    <div id="progress-container" style="display:none;">
        <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75"
                aria-valuemin="0" aria-valuemax="100" style="width: 75%;"></div>
        </div>
    </div>




    <div id="fondoDesenfocado"></div>
    <footer class="pc-footer">
        <div class="footer-wrapper container-fluid">
            <div class="row">
                <div class="col-sm-6 my-1">
                    <p class="m-0">By: Luz Collado<a target="_blank"></a></p>
                </div>
            </div>
        </div>
    </footer>

    <script type="module">




        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
        import { getDatabase, set, ref, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, orderBy, addDoc, query, limit, getDocs, getDoc, doc, setDoc, serverTimestamp, deleteDoc, Timestamp, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, uploadBytesResumable, listAll } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCknSaxVHB10B_v-4yD9UtNj1dmZZKVRe4",
            authDomain: "billing-system-fbfb3.firebaseapp.com",
            projectId: "billing-system-fbfb3",
            storageBucket: "billing-system-fbfb3.appspot.com",
            messagingSenderId: "906484441227",
            appId: "1:906484441227:web:7b486131ad930a7b03b48e"
        };


        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const auth = getAuth();
        const dba = getFirestore();
        const storage = getStorage(app);

        const usernameElement = document.getElementById('username');
        const roleElement = document.getElementById('role');
        const registerButton = document.getElementById('registerButton');
        const settingsButton = document.getElementById('settingsButton');
        const empleados = document.getElementById('empleados');

        function showUserData(userId) {
            const dbRef = ref(db);
            get(child(dbRef, `UsersAuthList/${userId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    usernameElement.textContent = `${userData.firstname} ${userData.lastname}`;
                    roleElement.textContent = userData.roleselect;

                    if (userData.roleselect === 'Asistente') {
                        registerButton.disabled = true;
                        document.getElementById('empleados').classList.add('disabled');
                        document.getElementById('empleados').addEventListener('click', function (event) {
                            event.preventDefault();
                        });

                        const pacientesLink = document.getElementById('pacientesLink');
                        pacientesLink.removeAttribute('href');
                        pacientesLink.style.pointerEvents = 'none';
                        pacientesLink.style.opacity = '0.5';

                        const productosLink = document.getElementById('productosLink');
                        productosLink.removeAttribute('href');
                        productosLink.style.pointerEvents = 'none';
                        productosLink.style.opacity = '0.5';

                        const suplidorLink = document.getElementById('suplidorLink');
                        suplidorLink.removeAttribute('href');
                        suplidorLink.style.pointerEvents = 'none';
                        suplidorLink.style.opacity = '0.5';
                    }
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        function showUserData2(userId) {
            const dbRef = ref(db);
            get(child(dbRef, `UsersAuthList/${userId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    usernameElement.textContent = `${userData.firstname} ${userData.lastname}`;
                    roleElement.textContent = userData.roleselect;

                    if (userData.roleselect === 'Administrador de Almacén') {
                        registerButton.disabled = true;
                        document.getElementById('empleados').addEventListener('click', function (event) {
                            event.preventDefault();
                        });
                        const pacientesLink = document.getElementById('pacientesLink');
                        pacientesLink.removeAttribute('href');
                        pacientesLink.style.pointerEvents = 'none';
                        pacientesLink.style.opacity = '0.5';

                        const facturarLink = document.getElementById('facturarLink');
                        facturarLink.removeAttribute('href');
                        facturarLink.style.pointerEvents = 'none';
                        facturarLink.style.opacity = '0.5';

                    }
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        // function showUserData3(userId) {
        //   const dbRef = ref(db);
        //   get(child(dbRef, `UsersAuthList/${userId}`))
        //     .then((snapshot) => {
        //       if (snapshot.exists()) {
        //         const userData = snapshot.val();
        //         usernameElement.textContent = `${userData.firstname} ${userData.lastname}`;
        //         roleElement.textContent = userData.roleselect;


        //         if (userData.roleselect === 'Administrador de Almacén') {

        //           document.getElementById('almacenCard').addEventListener('click', function (event) {
        //             event.preventDefault();
        //             window.location.href = 'almacen'; 
        //           });
        //         } else {

        //           document.getElementById('almacenCard').addEventListener('click', function (event) {
        //             event.preventDefault();
        //             window.location.href = 'solicitudes'; 
        //           });
        //         }
        //       } else {
        //         console.log("No data available");
        //       }
        //     })
        //     .catch((error) => {
        //       console.error(error);
        //     });
        // }



        onAuthStateChanged(auth, (user) => {
            if (user) {
                showUserData(user.uid);
                showUserData2(user.uid);
                // showUserData3(user.uid);
            } else {
                console.log("User is not signed in");
            }
        });

        let UserCreds = JSON.parse(sessionStorage.getItem("user-creds"));
        let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));
        let UserName = JSON.parse(sessionStorage.getItem("username"));
        let Role = JSON.parse(sessionStorage.getItem("role"));

        let SignoutBtn = document.getElementById('signoutbutton');

        let Signout = () => {
            sessionStorage.removeItem("user-creds");
            sessionStorage.removeItem("user-info");

            window.location.href = 'login';
        }

        let CheckCred = () => {
            if (!sessionStorage.getItem("user-creds"))
                window.location.href = 'login';
            else {
                UserName.innerText = ` ${UserName.firstname}`
                Role.innerText = ` ${UserName.roleselect}`
            }
        }

        document.getElementById('registerButton').addEventListener('click', () => {
            window.location.href = 'register';
        });

        document.getElementById('settingsButton').addEventListener('click', () => {
            window.location.href = 'settings';
        });

        SignoutBtn.addEventListener('click', Signout);



        document.addEventListener("DOMContentLoaded", () => {
            const filterInput = document.getElementById('filterDate');
            filterInput.addEventListener('input', loadEarnings);

            // Set default date to current month
            const currentDate = new Date();
            const currentMonth = `${String(currentDate.getMonth() + 1).padStart(2, '0')}/${currentDate.getFullYear()}`; // Formato mm/yyyy
            filterInput.value = currentMonth;

            // Cargar las ganancias por defecto al inicio
            loadEarnings();

            const filterInputE = document.getElementById('filterDateE');
            filterInputE.addEventListener('input', loadExpenses);

            // Set default date to current month
            const currentMonthE = `${String(currentDate.getMonth() + 1).padStart(2, '0')}/${currentDate.getFullYear()}`; // Formato mm/yyyy
            filterInputE.value = currentMonth;

            // Cargar los egresos por defecto al inicio
            loadExpenses();
        });

        async function loadEarnings() {
            const filterDate = document.getElementById('filterDate').value.trim();
            const [month, year] = filterDate.split('/');

            const q = query(
                collection(dba, "facturas"),
                where("fecha", ">=", `01/${month}/${year}`),
                where("fecha", "<=", `31/${month}/${year}`)
            );

            try {
                const querySnapshot = await getDocs(q);
                let totalEarnings = 0;
                const earningsList = document.getElementById('earningsList');
                earningsList.innerHTML = '';

                let gananciasEncontradas = false;

                for (const doc of querySnapshot.docs) {
                    const data = doc.data();
                    const amount = parseFloat(data.ganancia || 0);
                    const docMonth = data.fecha.split('/')[1];
                    const docYear = data.fecha.split('/')[2];

                    if (docMonth === month && docYear === year) {
                        if (data.estatus === 'Cerrada' && amount > 0) {
                            gananciasEncontradas = true;
                            totalEarnings += amount;

                            const listItem = document.createElement('li');
                            listItem.classList.add('list-group-item', 'px-0');
                            listItem.innerHTML = `
                <div class="row align-items-start">
                    <div class="col">
                        <h5 class="mb-0">No. Factura ${data.numeroFactura}</h5>
                        <small class="text-success">${data.fecha}</small>
                    </div>
                    <div class="col-auto">
                        <h4 class="mb-0">$${amount.toFixed(2)}<span class="ms-2 align-top avtar avtar-xxs bg-light-success"><i class="ti ti-chevron-up text-success"></i></span></h4>
                    </div>
                </div>
            `;
                            earningsList.appendChild(listItem);
                        } else if (data.estatus === 'Abierta') {
                            const pagosSnapshot = await getDocs(collection(dba, `facturas/${doc.id}/pagos`));
                            pagosSnapshot.forEach((pagoDoc) => {
                                const pagoData = pagoDoc.data();
                                if (pagoData.estatus === 'Pagado') {
                                    const pagoAmount = parseFloat(pagoData.ganancia || 0);
                                    if (pagoAmount > 0) {
                                        gananciasEncontradas = true;
                                        totalEarnings += pagoAmount;

                                        const listItem = document.createElement('li');
                                        listItem.classList.add('list-group-item', 'px-0');
                                        listItem.innerHTML = `
                            <div class="row align-items-start">
                                <div class="col">
                                    <h5 class="mb-0">No. Factura ${data.numeroFactura} - Pago ${pagoData.numeroPago}</h5>
                                    <small class="text-success">${pagoData.fechapago}</small>
                                </div>
                                <div class="col-auto">
                                    <h4 class="mb-0">$${pagoAmount.toFixed(2)}<span class="ms-2 align-top avtar avtar-xxs bg-light-success"><i class="ti ti-chevron-up text-success"></i></span></h4>
                                </div>
                            </div>
                        `;
                                        earningsList.appendChild(listItem);
                                    }
                                }
                            });
                        }
                    }
                }

                if (!gananciasEncontradas) {
                    const noEarningsMessage = document.createElement('li');
                    noEarningsMessage.classList.add('list-group-item', 'px-0');
                    noEarningsMessage.textContent = 'No hay ganancias para el mes seleccionado';
                    earningsList.appendChild(noEarningsMessage);
                }

                document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
            } catch (error) {
                console.error("Error al cargar las ganancias:", error);
            }
        }


        async function loadExpenses() {
            const filterDate = document.getElementById('filterDateE').value.trim();
            const [month, year] = filterDate.split('/');

            const q = query(
                collection(dba, "RegistroDeCompras"),
                where("fecha", ">=", `01/${month}/${year}`),
                where("fecha", "<=", `31/${month}/${year}`)
            );

            try {
                const querySnapshot = await getDocs(q);
                let totalExpenses = 0;
                const expensesList = document.getElementById('expensesList');
                expensesList.innerHTML = '';

                // Verificar si no hay egresos para este mes y año
                let egresosEncontrados = false;

                for (const doc of querySnapshot.docs) {
                    const data = doc.data();
                    const amount = parseFloat(data.montoFactura || 0);
                    const docMonth = data.fecha.split('/')[1];
                    const docYear = data.fecha.split('/')[2];

                    if (docMonth === month && docYear === year) {
                        if (data.estatus === 'Cerrada' && amount > 0) {
                            // Procesar factura cerrada
                            egresosEncontrados = true;
                            totalExpenses += parseFloat(data.montoApagar);

                            const listItem = document.createElement('li');
                            listItem.classList.add('list-group-item', 'px-0');
                            listItem.innerHTML = `
                        <div class="row align-items-start">
                            <div class="col">
                                <h5 class="mb-0">${data.suplidorNombre}</h5>
                                <small class="text-danger">${data.fecha}</small>
                            </div>
                            <div class="col-auto">
                                <h4 class="mb-0">$${parseFloat(data.montoFactura).toFixed(2)}<span class="ms-2 align-top avtar avtar-xxs bg-light-danger"><i class="ti ti-chevron-down text-danger"></i></span></h4>
                            </div>
                        </div>
                    `;
                            expensesList.appendChild(listItem);
                        } else if (data.estatus === 'Abierta') {
                            // Procesar pagos de factura abierta
                            const pagos = data.pagos || [];
                            if (data.montoApagar > 0) {
                                egresosEncontrados = true;
                                totalExpenses += parseFloat(data.montoApagar);

                                const listItem = document.createElement('li');
                                listItem.classList.add('list-group-item', 'px-0');
                                listItem.innerHTML = `
                            <div class="row align-items-start">
                                <div class="col">
                                    <h5 class="mb-0">${data.suplidorNombre}</h5>
                                    <small class="text-danger">${data.fecha}</small>
                                </div>
                                <div class="col-auto">
                                    <h4 class="mb-0">$${parseFloat(data.montoApagar).toFixed(2)}<span class="ms-2 align-top avtar avtar-xxs bg-light-danger"><i class="ti ti-chevron-down text-danger"></i></span></h4>
                                </div>
                            </div>
                        `;
                                expensesList.appendChild(listItem);
                            }

                            pagos.forEach((pago) => {
                                if (pago.estatus === 'Pagado') {
                                    const pagoAmount = parseFloat(pago.monto || 0);
                                    if (pagoAmount > 0) {
                                        egresosEncontrados = true;
                                        totalExpenses += pagoAmount;

                                        const listItem = document.createElement('li');
                                        listItem.classList.add('list-group-item', 'px-0');
                                        listItem.innerHTML = `
                                    <div class="row align-items-start">
                                        <div class="col">
                                            <h5 class="mb-0">${data.suplidorNombre} - Pago ${pago.numeroPago}</h5>
                                            <small class="text-danger">${pago.fechapago}</small>
                                        </div>
                                        <div class="col-auto">
                                            <h4 class="mb-0">$${pagoAmount.toFixed(2)}<span class="ms-2 align-top avtar avtar-xxs bg-light-danger"><i class="ti ti-chevron-down text-danger"></i></span></h4>
                                        </div>
                                    </div>
                                `;
                                        expensesList.appendChild(listItem);
                                    }
                                }
                            });
                        }
                    }
                }

                // Si no se encontraron egresos para el mes y año seleccionados, mostrar mensaje
                if (!egresosEncontrados) {
                    const noExpensesMessage = document.createElement('li');
                    noExpensesMessage.classList.add('list-group-item', 'px-0');
                    noExpensesMessage.textContent = 'No hay egresos para el mes seleccionado';
                    expensesList.appendChild(noExpensesMessage);
                }

                document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
            } catch (error) {
                console.error("Error al cargar los egresos:", error);
                // Manejar el error aquí según sea necesario
            }
        }



        const openHistorialFacturas = document.getElementById('openHistorialFacturas');
        const historialFacturasG = document.getElementById('HistorialFacturasG');
        const listaFacturasG = document.getElementById('listaFacturasG');

        // Función para mostrar/ocultar el formulario de facturas
        function toggleFormularioG() {
            const fondoDesenfocado = document.getElementById('fondoDesenfocado');
            if (historialFacturasG.style.display === 'none' || historialFacturasG.style.display === '') {
                historialFacturasG.style.display = 'block';
                fondoDesenfocado.style.display = 'block';
            } else {
                historialFacturasG.style.display = 'none';
                fondoDesenfocado.style.display = 'none';
            }
        }

        // Evento para cerrar el formulario de facturas
        document.getElementById('closeHistorialButtonG').addEventListener('click', () => {
            toggleFormularioG();
        });

        // Función para listar facturas con estatus "Abierta"
        async function listarFacturas(pageSize = 10, page = 1) {
            listaFacturasG.innerHTML = '';

            try {
                const facturasRef = collection(dba, 'facturas');
                const snapshot = await getDocs(facturasRef);

                if (snapshot.empty) {
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'No se encontraron facturas.';
                    listaFacturasG.appendChild(noDataMessage);
                    return;
                }

                const totalDocs = snapshot.docs.length;
                const totalPages = Math.ceil(totalDocs / pageSize);
                const startIndex = (page - 1) * pageSize;
                const endIndex = startIndex + pageSize;

                const docsToShow = snapshot.docs.slice(startIndex, endIndex);

                const table = document.createElement('table');
                table.classList.add('table', 'table-striped');

                // Crear encabezados de tabla
                const tableHeader = document.createElement('thead');
                tableHeader.innerHTML = `
        <tr>
            <th>Cliente</th>
            <th>Estatus</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Items</th>
            <th>Número de Factura</th>
            <th>Factura</th>
        </tr>`;
                table.appendChild(tableHeader);

                const tableBody = document.createElement('tbody');

                // Iterar sobre cada factura y crear filas de tabla
                docsToShow.forEach(doc => {
                    const data = doc.data();
                    const { doctor, estatus, fecha, total, items, numeroFactura, urlFactura, paciente } = data;

                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>${paciente}</td>
            <td>${estatus}</td>
            <td>${fecha}</td>
            <td>${total}</td>
            <td>${items.length}</td>
            <td>${numeroFactura}</td>
            <td><a href="${urlFactura}" target="_blank">Ver factura</a></td>`;

                    tableBody.appendChild(row);
                });

                table.appendChild(tableBody);
                listaFacturasG.appendChild(table);

                // Actualizar la paginación
                actualizarPaginacion(totalPages, page, 'paginationG');

            } catch (error) {
                console.error('Error al cargar el historial de facturas:', error);
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Hubo un error al cargar el historial de facturas. Por favor, inténtelo de nuevo más tarde.';
                listaFacturasG.appendChild(errorMessage);
            }
        }

        // Función para actualizar la paginación
        function actualizarPaginacion(totalPages, currentPage, paginationId) {
            const paginationContainer = document.getElementById(paginationId);
            paginationContainer.innerHTML = '';

            // Botón anterior
            const prevButton = document.createElement('li');
            prevButton.classList.add('page-item', 'prev-button');
            if (currentPage === 1) {
                prevButton.classList.add('disabled');
            }
            const prevLink = document.createElement('a');
            prevLink.classList.add('page-link');
            prevLink.href = '#';
            prevLink.textContent = '«';
            prevLink.addEventListener('click', () => {
                if (currentPage > 1) {
                    listarFacturas(5, currentPage - 1);
                }
            });
            prevButton.appendChild(prevLink);
            paginationContainer.appendChild(prevButton);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('li');
                pageButton.classList.add('page-item');
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                const pageLink = document.createElement('a');
                pageLink.classList.add('page-link');
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', () => {
                    listarFacturas(5, i);
                });
                pageButton.appendChild(pageLink);
                paginationContainer.appendChild(pageButton);
            }

            // Botón siguiente
            const nextButton = document.createElement('li');
            nextButton.classList.add('page-item', 'next-button');
            if (currentPage === totalPages) {
                nextButton.classList.add('disabled');
            }
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.href = '#';
            nextLink.textContent = '»';
            nextLink.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    listarFacturas(5, currentPage + 1);
                }
            });
            nextButton.appendChild(nextLink);
            paginationContainer.appendChild(nextButton);
        }

        // Función para filtrar la tabla de facturas por texto de búsqueda
        async function filterTableG() {
            const searchTerm = searchInputG.value.toLowerCase();

            try {
                const facturasRef = collection(dba, 'facturas');
                const snapshot = await getDocs(facturasRef);

                if (snapshot.empty) {
                    console.log('No hay facturas encontradas.');
                    return;
                }

                const filteredData = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.numeroFactura.toString().includes(searchTerm);
                });

                actualizarTabla(filteredData); // Actualiza la tabla con los datos filtrados

            } catch (error) {
                console.error('Error al filtrar datos:', error);
            }
        }

        // Función para actualizar la tabla con datos filtrados
        function actualizarTabla(filteredData) {
            listaFacturasG.innerHTML = '';

            if (filteredData.length === 0) {
                const noDataMessage = document.createElement('p');
                noDataMessage.textContent = 'No se encontraron registros que coincidan con la búsqueda.';
                listaFacturasG.appendChild(noDataMessage);
                return;
            }

            const table = document.createElement('table');
            table.classList.add('table', 'table-striped');

            // Crear encabezados de tabla
            const tableHeader = document.createElement('thead');
            tableHeader.innerHTML = `
    <tr>
        <th>Cliente</th>
        <th>Estatus</th>
        <th>Fecha</th>
        <th>Total</th>
        <th>Items</th>
        <th>Número de Factura</th>
        <th>Factura</th>
    </tr>`;
            table.appendChild(tableHeader);

            const tableBody = document.createElement('tbody');

            // Iterar sobre cada factura filtrada y crear filas de tabla
            filteredData.forEach(doc => {
                const data = doc.data();
                const { doctor, estatus, fecha, total, items, numeroFactura, urlFactura, paciente } = data;

                const row = document.createElement('tr');
                row.innerHTML = `
        <td>${paciente}</td>
        <td>${estatus}</td>
        <td>${fecha}</td>
        <td>${total}</td>
        <td>${items.length}</td>
        <td>${numeroFactura}</td>
        <td><a href="${urlFactura}" target="_blank">Ver factura</a></td>`;

                tableBody.appendChild(row);
            });

            table.appendChild(tableBody);
            listaFacturasG.appendChild(table);
        }

        // Escuchar el evento de entrada en el campo de búsqueda para filtrar las facturas
        document.getElementById('searchInputG').addEventListener('input', filterTableG);

        // Llamar a la función para cargar el historial de facturas al hacer clic en el enlace
        openHistorialFacturas.addEventListener('click', async () => {
            toggleFormularioG(); // Mostrar el formulario antes de cargar las facturas

            await listarFacturas(5, 1); // Llama a la función para cargar las facturas con los parámetros deseados
        });


        const openHistorialCuentasPorCobrar = document.getElementById('Cuentasporcobrar');
        const historialCuentasPorCobrar = document.getElementById('HistorialCuentasPorCobrar');
        const listaCuentasPorCobrar = document.getElementById('listaCuentasPorCobrar');

        // Función para mostrar/ocultar el formulario de cuentas por cobrar
        function toggleFormularioCuentasPorCobrar() {
            const fondoDesenfocado = document.getElementById('fondoDesenfocado');
            if (historialCuentasPorCobrar.style.display === 'none' || historialCuentasPorCobrar.style.display === '') {
                historialCuentasPorCobrar.style.display = 'block';
                fondoDesenfocado.style.display = 'block';
            } else {
                historialCuentasPorCobrar.style.display = 'none';
                fondoDesenfocado.style.display = 'none';
            }
        }

        // Evento para cerrar el formulario de cuentas por cobrar
        document.getElementById('closeHistorialButtonCuentasPorCobrar').addEventListener('click', () => {
            toggleFormularioCuentasPorCobrar();
        });

        // Función para listar facturas con estatus "Abierta"
        async function listarCuentasPorCobrar(pageSize = 10, page = 1) {
            listaCuentasPorCobrar.innerHTML = '';

            try {
                const facturasRef = collection(dba, 'facturas');
                const snapshot = await getDocs(query(facturasRef, where('estatus', '==', 'Abierta')));

                if (snapshot.empty) {
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'No se encontraron facturas abiertas.';
                    listaCuentasPorCobrar.appendChild(noDataMessage);
                    return;
                }

                const totalDocs = snapshot.docs.length;
                const totalPages = Math.ceil(totalDocs / pageSize);
                const startIndex = (page - 1) * pageSize;
                const endIndex = startIndex + pageSize;

                const docsToShow = snapshot.docs.slice(startIndex, endIndex);

                const table = document.createElement('table');
                table.classList.add('table', 'table-striped');

                // Crear encabezados de tabla
                const tableHeader = document.createElement('thead');
                tableHeader.innerHTML = `
        <tr>
            <th>Cliente</th>
            <th>Estatus</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Items</th>
            <th>Número de Factura</th>
            <th>Factura</th>
        </tr>`;
                table.appendChild(tableHeader);

                const tableBody = document.createElement('tbody');

                // Iterar sobre cada factura y crear filas de tabla
                docsToShow.forEach(doc => {
                    const data = doc.data();
                    const { doctor, estatus, fecha, total, items, numeroFactura, urlFactura, paciente } = data;

                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td>${paciente}</td>
            <td>${estatus}</td>
            <td>${fecha}</td>
            <td>${total}</td>
            <td>${items.length}</td>
            <td>${numeroFactura}</td>
            <td><a href="${urlFactura}" target="_blank">Ver factura</a></td>
            <td><button class="btn btn-sm btn-primary" onclick="aplicarPago('${doc.id}')">Aplicar Pago</button></td>`;

                    tableBody.appendChild(row);
                });

                table.appendChild(tableBody);
                listaCuentasPorCobrar.appendChild(table);

                // Actualizar la paginación
                actualizarPaginacionC(totalPages, page, 'paginationCuentasPorCobrar');

            } catch (error) {
                console.error('Error al cargar el historial de cuentas por cobrar:', error);
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Hubo un error al cargar el historial de cuentas por cobrar. Por favor, inténtelo de nuevo más tarde.';
                listaCuentasPorCobrar.appendChild(errorMessage);
            }
        }

        // Función para actualizar la paginación
        function actualizarPaginacionC(totalPages, currentPage, paginationId) {
            const paginationContainer = document.getElementById(paginationId);
            paginationContainer.innerHTML = '';

            // Botón anterior
            const prevButton = document.createElement('li');
            prevButton.classList.add('page-item', 'prev-button');
            if (currentPage === 1) {
                prevButton.classList.add('disabled');
            }
            const prevLink = document.createElement('a');
            prevLink.classList.add('page-link');
            prevLink.href = '#';
            prevLink.textContent = '«';
            prevLink.addEventListener('click', () => {
                if (currentPage > 1) {
                    listarCuentasPorCobrar(5, currentPage - 1);
                }
            });
            prevButton.appendChild(prevLink);
            paginationContainer.appendChild(prevButton);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('li');
                pageButton.classList.add('page-item');
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                const pageLink = document.createElement('a');
                pageLink.classList.add('page-link');
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', () => {
                    listarCuentasPorCobrar(5, i);
                });
                pageButton.appendChild(pageLink);
                paginationContainer.appendChild(pageButton);
            }

            // Botón siguiente
            const nextButton = document.createElement('li');
            nextButton.classList.add('page-item', 'next-button');
            if (currentPage === totalPages) {
                nextButton.classList.add('disabled');
            }
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.href = '#';
            nextLink.textContent = '»';
            nextLink.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    listarCuentasPorCobrar(5, currentPage + 1);
                }
            });
            nextButton.appendChild(nextLink);
            paginationContainer.appendChild(nextButton);
        }

        // Función para filtrar la tabla de facturas por texto de búsqueda
        async function filterTableCuentasPorCobrar() {
            const searchTerm = searchInputCuentasPorCobrar.value.toLowerCase();

            try {
                const facturasRef = collection(dba, 'facturas');
                const snapshot = await getDocs(query(facturasRef, where('estatus', '==', 'Abierta')));

                if (snapshot.empty) {
                    console.log('No hay facturas abiertas encontradas.');
                    return;
                }

                const filteredData = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.numeroFactura.toString().includes(searchTerm);
                });

                actualizarTablaC(filteredData); // Actualiza la tabla con los datos filtrados

            } catch (error) {
                console.error('Error al filtrar datos:', error);
            }
        }

        // Función para actualizar la tabla con datos filtrados
        function actualizarTablaC(filteredData) {
            listaCuentasPorCobrar.innerHTML = '';

            if (filteredData.length === 0) {
                const noDataMessage = document.createElement('p');
                noDataMessage.textContent = 'No se encontraron registros que coincidan con la búsqueda.';
                listaCuentasPorCobrar.appendChild(noDataMessage);
                return;
            }

            const table = document.createElement('table');
            table.classList.add('table', 'table-striped');

            // Crear encabezados de tabla
            const tableHeader = document.createElement('thead');
            tableHeader.innerHTML = `
    <tr>
        <th>Cliente</th>
        <th>Estatus</th>
        <th>Fecha</th>
        <th>Total</th>
        <th>Items</th>
        <th>Número de Factura</th>
        <th>Factura</th>
    </tr>`;
            table.appendChild(tableHeader);

            const tableBody = document.createElement('tbody');

            // Iterar sobre cada factura filtrada y crear filas de tabla
            filteredData.forEach(doc => {
                const data = doc.data();
                const { doctor, estatus, fecha, total, items, numeroFactura, urlFactura, paciente } = data;

                const row = document.createElement('tr');
                row.innerHTML = `
        <td>${paciente}</td>
        <td>${estatus}</td>
        <td>${fecha}</td>
        <td>${total}</td>
        <td>${items.length}</td>
        <td>${numeroFactura}</td>
        <td><a href="${urlFactura}" target="_blank">Ver factura</a></td>
        <td><button class="btn btn-sm btn-primary" onclick="aplicarPago('${doc.id}')">Aplicar Pago</button></td>`;

                tableBody.appendChild(row);
            });

            table.appendChild(tableBody);
            listaCuentasPorCobrar.appendChild(table);
        }

        window.aplicarPago = async function (docId) {
            toggleFormularioPago();

            const listaPagos = document.getElementById('listaPagos');
            listaPagos.innerHTML = '';

            try {
                // Obtener los datos de la factura desde Firestore
                const facturaRef = doc(dba, 'facturas', docId);
                const facturaSnap = await getDoc(facturaRef);

                if (!facturaSnap.exists()) {
                    console.error('La factura no existe.');
                    return;
                }

                const facturaData = facturaSnap.data();
                const { doctor, estatus, fecha, total, items, numeroFactura, condicionPago, paciente, moneda } = facturaData;

                // Llenar los datos de la factura en el formulario
                document.getElementById('facturaCliente').textContent = paciente;
                document.getElementById('facturaEstatus').textContent = estatus;
                document.getElementById('facturaFecha').textContent = fecha;
                document.getElementById('facturaTotal').textContent = total;
                document.getElementById('facturaItems').textContent = items.length;
                document.getElementById('facturaNumero').textContent = numeroFactura;

                // Obtener y listar los pagos de la subcolección 'pagos'
                const pagosRef = collection(dba, `facturas/${docId}/pagos`);
                const pagosSnapshot = await getDocs(pagosRef);
                const pagos = pagosSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.numeroPago - b.numeroPago); // Orden ascendente

                const totalF = total;

                let tableContent = `
            <thead>
                <tr>
                    <th>Pago</th>
                    <th>Monto en Factura</th>
                    <th>A Pagar</th>
                    <th>Fecha</th>
                    <th>Estatus</th>
                </tr>
            </thead>
            <tbody>
        `;

                pagos.forEach((pago, index) => {
                    const { estatus, fechapago, monto = 0, numeroPago, total } = pago;

                    tableContent += `
                <tr>
                    <td>Pago ${numeroPago}</td>
                    <td>${totalF}</td>
                    <td>${total}</td>
                    <td>${fechapago || 'Pendiente'}</td>
                    <td>${estatus}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="pagar('${pago.id}', '${docId}', ${monto})" ${estatus === 'Pagado' ? 'disabled' : ''}>Pagar</button>
                    </td>
                </tr>
            `;
                });

                tableContent += '</tbody>';
                listaPagos.innerHTML = tableContent;

            } catch (error) {
                console.error('Error al aplicar pago:', error);
            }
        }

        window.pagar = async function (pagoId, facturaId, total) {
            try {
                const pagoRef = doc(dba, `facturas/${facturaId}/pagos`, pagoId);
                const pagoSnap = await getDoc(pagoRef);

                if (!pagoSnap.exists()) {
                    console.error('El pago no existe.');
                    return;
                }

                const fechaActual = obtenerFechaActual();

                const pagoData = pagoSnap.data();
                const totalPago = pagoData.total;

                await updateDoc(pagoRef, {
                    estatus: 'Pagado',
                    fechapago: fechaActual
                });

                // Verificar si todos los pagos están pagados
                const pagosRef = collection(dba, `facturas/${facturaId}/pagos`);
                const pagosSnapshot = await getDocs(pagosRef);
                let todosPagados = true;
                pagosSnapshot.forEach(doc => {
                    if (doc.data().estatus !== 'Pagado') {
                        todosPagados = false;
                    }
                });

                if (todosPagados) {
                    const facturaRef = doc(dba, 'facturas', facturaId);
                    await updateDoc(facturaRef, {
                        estatus: 'Cerrada'
                    });
                }

                const facturaSnap = await getDoc(doc(dba, 'facturas', facturaId));
                const facturaData = facturaSnap.data();
                const { doctor, paciente, numeroFactura } = facturaData; // Asegúrate de que `paciente` está en los datos de la factura

                // Generar recibo PDF
                await generatePDFHorizontal(facturaId, doctor, paciente, numeroFactura, totalPago);

                // Actualizar la lista de pagos en el formulario
                aplicarPago(facturaId);

            } catch (error) {
                console.error('Error al pagar:', error);
            }
        }
        // Función para mostrar/ocultar el formulario de pagos
        function toggleFormularioPago() {
            const formularioPago = document.getElementById('formularioPago');

            if (formularioPago.style.display === 'none' || formularioPago.style.display === '') {
                formularioPago.style.display = 'block';
            } else {
                formularioPago.style.display = 'none';
            }
        }

        // Añadir el evento para cerrar el formulario de pagos
        document.getElementById('closeFormularioPago').addEventListener('click', () => {
            toggleFormularioPago();
        });


        // Escuchar el evento de entrada en el campo de búsqueda para filtrar las facturas
        document.getElementById('searchInputCuentasPorCobrar').addEventListener('input', filterTableCuentasPorCobrar);

        // Llamar a la función para cargar el historial de facturas abiertas al hacer clic en el enlace
        openHistorialCuentasPorCobrar.addEventListener('click', async () => {
            toggleFormularioCuentasPorCobrar(); // Mostrar el formulario antes de cargar las facturas

            await listarCuentasPorCobrar(5, 1); // Llama a la función para cargar las facturas con los parámetros deseados
        });

        function obtenerFechaActual() {
            const fecha = new Date();
            const dia = String(fecha.getDate()).padStart(2, '0'); // Obtener el día, y asegurarse de que tenga 2 dígitos
            const mes = String(fecha.getMonth() + 1).padStart(2, '0'); // Obtener el mes (los meses van de 0 a 11 en JavaScript)
            const año = fecha.getFullYear(); // Obtener el año

            return `${dia}/${mes}/${año}`;
        }


        const openHistorialCuentasPorPagar = document.getElementById('CuentasporPagar');
        const historialCuentasPorPagar = document.getElementById('HistorialCuentasPorPagar');
        const listaCuentasPorPagar = document.getElementById('listaCuentasPorPagar');

        // Función para mostrar/ocultar el formulario de cuentas por pagar
        function toggleFormularioCuentasPorPagar() {
            const fondoDesenfocado = document.getElementById('fondoDesenfocado');
            if (historialCuentasPorPagar.style.display === 'none' || historialCuentasPorPagar.style.display === '') {
                historialCuentasPorPagar.style.display = 'block';
                fondoDesenfocado.style.display = 'block';
            } else {
                historialCuentasPorPagar.style.display = 'none';
                fondoDesenfocado.style.display = 'none';
            }
        }

        // Evento para cerrar el formulario de cuentas por pagar
        document.getElementById('closeHistorialButtonCuentasPorPagar').addEventListener('click', () => {
            toggleFormularioCuentasPorPagar();
        });

        // Función para listar facturas con estatus "Abierta"
        async function listarCuentasPorPagar(pageSize = 10, page = 1) {
            listaCuentasPorPagar.innerHTML = '';

            try {
                const facturasRef = collection(dba, 'RegistroDeCompras');
                const snapshot = await getDocs(query(facturasRef, where('estatus', '==', 'Abierta')));

                if (snapshot.empty) {
                    const noDataMessage = document.createElement('p');
                    noDataMessage.textContent = 'No se encontraron facturas abiertas.';
                    listaCuentasPorPagar.appendChild(noDataMessage);
                    return;
                }

                const totalDocs = snapshot.docs.length;
                const totalPages = Math.ceil(totalDocs / pageSize);
                const startIndex = (page - 1) * pageSize;
                const endIndex = startIndex + pageSize;

                const docsToShow = snapshot.docs.slice(startIndex, endIndex);

                const table = document.createElement('table');
                table.classList.add('table', 'table-striped');

                // Crear encabezados de tabla
                const tableHeader = document.createElement('thead');
                tableHeader.innerHTML = `
            <tr>
                <th>Suplidor</th>
                <th>Estatus</th>
                <th>Fecha</th>
                <th>Monto pagado en el momento de la compra</th>
                <th>Total</th>
                <th>Número de comprobante fiscal</th>
                <th>Número de Factura</th>
                <th>Factura</th>
            </tr>`;
                table.appendChild(tableHeader);

                const tableBody = document.createElement('tbody');

                // Iterar sobre cada factura y crear filas de tabla
                docsToShow.forEach(doc => {
                    const data = doc.data();
                    const { suplidorNombre, estatus, fecha, montoFactura, nombreFactura, numeroComprobante, facturaURL, pagos, montoApagar } = data;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${suplidorNombre}</td>
                <td>${estatus}</td>
                <td>${fecha}</td>
                <td>${montoApagar}</td>
                <td>${montoFactura}</td>
                <td>${numeroComprobante}</td>
                <td>${nombreFactura}</td>
                <td><a href="${facturaURL}" target="_blank">Ver factura</a></td>
                <td><button class="btn btn-sm btn-primary" onclick="aplicarPagoCuentasPorPagar('${doc.id}')">Aplicar Pago</button></td>`;

                    tableBody.appendChild(row);
                });

                table.appendChild(tableBody);
                listaCuentasPorPagar.appendChild(table);

                // Actualizar la paginación
                actualizarPaginacionCuentasPorPagar(totalPages, page, 'paginationCuentasPorPagar');

            } catch (error) {
                console.error('Error al cargar el historial de cuentas por pagar:', error);
                const errorMessage = document.createElement('p');
                errorMessage.textContent = 'Hubo un error al cargar el historial de cuentas por pagar. Por favor, inténtelo de nuevo más tarde.';
                listaCuentasPorPagar.appendChild(errorMessage);
            }
        }

        // Función para actualizar la paginación
        function actualizarPaginacionCuentasPorPagar(totalPages, currentPage, paginationId) {
            const paginationContainer = document.getElementById(paginationId);
            paginationContainer.innerHTML = '';

            // Botón anterior
            const prevButton = document.createElement('li');
            prevButton.classList.add('page-item', 'prev-button');
            if (currentPage === 1) {
                prevButton.classList.add('disabled');
            }
            const prevLink = document.createElement('a');
            prevLink.classList.add('page-link');
            prevLink.href = '#';
            prevLink.textContent = '«';
            prevLink.addEventListener('click', () => {
                if (currentPage > 1) {
                    listarCuentasPorPagar(5, currentPage - 1);
                }
            });
            prevButton.appendChild(prevLink);
            paginationContainer.appendChild(prevButton);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('li');
                pageButton.classList.add('page-item');
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                const pageLink = document.createElement('a');
                pageLink.classList.add('page-link');
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', () => {
                    listarCuentasPorPagar(5, i);
                });
                pageButton.appendChild(pageLink);
                paginationContainer.appendChild(pageButton);
            }

            // Botón siguiente
            const nextButton = document.createElement('li');
            nextButton.classList.add('page-item', 'next-button');
            if (currentPage === totalPages) {
                nextButton.classList.add('disabled');
            }
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.href = '#';
            nextLink.textContent = '»';
            nextLink.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    listarCuentasPorPagar(5, currentPage + 1);
                }
            });
            nextButton.appendChild(nextLink);
            paginationContainer.appendChild(nextButton);
        }

        // Función para filtrar la tabla de facturas por texto de búsqueda
        async function filterTableCuentasPorPagar() {
            const searchTerm = searchInputCuentasPorPagar.value.toLowerCase();

            try {
                const facturasRef = collection(dba, 'RegistroDeCompras');
                const snapshot = await getDocs(query(facturasRef, where('estatus', '==', 'Abierta')));

                if (snapshot.empty) {
                    console.log('No hay facturas abiertas encontradas.');
                    return;
                }

                const filteredData = snapshot.docs.filter(doc => {
                    const data = doc.data();
                    return data.numeroComprobante.toString().includes(searchTerm);
                });

                actualizarTablaCuentasPorPagar(filteredData); // Actualiza la tabla con los datos filtrados

            } catch (error) {
                console.error('Error al filtrar datos:', error);
            }
        }

        // Función para actualizar la tabla con datos filtrados
        function actualizarTablaCuentasPorPagar(filteredData) {
            listaCuentasPorPagar.innerHTML = '';

            if (filteredData.length === 0) {
                const noDataMessage = document.createElement('p');
                noDataMessage.textContent = 'No se encontraron registros que coincidan con la búsqueda.';
                listaCuentasPorPagar.appendChild(noDataMessage);
                return;
            }

            const table = document.createElement('table');
            table.classList.add('table', 'table-striped');

            // Crear encabezados de tabla
            const tableHeader = document.createElement('thead');
            tableHeader.innerHTML = `
    <tr>
        <th>Suplidor</th>
        <th>Estatus</th>
        <th>Fecha</th>
        <th>Total</th>
        <th>Número de Factura</th>
        <th>Factura</th>
    </tr>`;
            table.appendChild(tableHeader);

            const tableBody = document.createElement('tbody');

            // Iterar sobre cada factura filtrada y crear filas de tabla
            filteredData.forEach(doc => {
                const data = doc.data();
                const { suplidorNombre, estatus, fecha, montoFactura, nombreFactura, numeroComprobante, facturaURL, pagos } = data;

                const row = document.createElement('tr');
                row.innerHTML = `
        <td>${suplidorNombre}</td>
        <td>${estatus}</td>
        <td>${fecha}</td>
        <td>${montoFactura}</td>
        <td>${numeroComprobante}</td>
        <td><a href="${facturaURL}" target="_blank">Ver factura</a></td>
        <td><button class="btn btn-sm btn-primary" onclick="aplicarPagoCuentasPorPagar('${doc.id}')">Aplicar Pago</button></td>`;

                tableBody.appendChild(row);
            });

            table.appendChild(tableBody);
            listaCuentasPorPagar.appendChild(table);
        }

        window.aplicarPagoCuentasPorPagar = async function (docId) {
            toggleFormularioPagoCuentasPorPagar();

            const listaPagos = document.getElementById('listaPagosCuentasPorPagar');
            listaPagos.innerHTML = '';

            try {
                const facturaRef = doc(dba, 'RegistroDeCompras', docId);
                const facturaSnap = await getDoc(facturaRef);

                if (!facturaSnap.exists()) {
                    console.error('La factura no existe.');
                    return;
                }

                const facturaData = facturaSnap.data();
                const { suplidorNombre, estatus, fecha, montoFactura, pagos, numeroComprobante, nombreFactura, moneda } = facturaData;

                document.getElementById('facturaSuplidor').textContent = suplidorNombre;
                document.getElementById('facturaEstatusP').textContent = estatus;
                document.getElementById('facturaFechaP').textContent = fecha;
                document.getElementById('facturaTotalP').textContent = montoFactura;
                // document.getElementById('facturaItemsP').textContent = pagos.length;
                document.getElementById('facturaNumeroP').textContent = nombreFactura;

                const totalF = montoFactura;

                let tableContent = `
            <thead>
                <tr>
                    <th>Pago</th>
                    <th>Monto en Factura</th>
                    <th>A Pagar</th>
                    <th>Fecha</th>
                    <th>Estatus</th>
                    <th>Pagar</th>
                    <th>Subir Recibo</th>
                    <th>Guardar Recibo</th>
                </tr>
            </thead>
            <tbody>
        `;

                pagos.forEach((pago, index) => {
                    const { estatus, fechapago, monto = '0.00 DOP', numeroPago } = pago;

                    tableContent += `
                <tr>
                    <td>Pago ${numeroPago}</td>
                    <td>${totalF}</td>
                    <td>${monto}</td>
                    <td>${fechapago || 'Pendiente'}</td>
                    <td>${estatus}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" id="pagarBtn-${docId}-${index}" onclick="pagarCuentasPorPagar('${docId}', ${index}, '${monto}')" ${estatus === 'Pagado' ? 'disabled' : ''} disabled>Pagar</button>
                    </td>
                    <td>
                        <input type="file" id="reciboFile-${docId}-${index}" class="form-control" onchange="mostrarNombreArchivo('${docId}', ${index})" />
                        <span id="nombreArchivo-${docId}-${index}"></span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-success" id="aplicarBtn-${docId}-${index}" onclick="guardarRecibo('${docId}', ${index})" ${estatus === 'Pagado' ? 'disabled' : ''}>Aplicar</button>
                    </td>
                </tr>
            `;
                });

                tableContent += '</tbody>';
                listaPagos.innerHTML = tableContent;

            } catch (error) {
                console.error('Error al aplicar pago:', error);
            }
        }

        window.mostrarNombreArchivo = function (facturaId, pagoIndex) {
            const reciboFileInput = document.getElementById(`reciboFile-${facturaId}-${pagoIndex}`);
            const nombreArchivoSpan = document.getElementById(`nombreArchivo-${facturaId}-${pagoIndex}`);

            if (reciboFileInput.files.length > 0) {
                nombreArchivoSpan.textContent = reciboFileInput.files[0].name;
            } else {
                nombreArchivoSpan.textContent = '';
            }
        }

        window.guardarRecibo = async function (facturaId, pagoIndex) {
            const reciboFileInput = document.getElementById(`reciboFile-${facturaId}-${pagoIndex}`);
            const reciboFile = reciboFileInput.files[0];

            if (!reciboFile) {
                showAlert('Por favor, seleccione un archivo.', 'alert-warning');
                return;
            }

            const aplicarBtn = document.getElementById(`aplicarBtn-${facturaId}-${pagoIndex}`);
            aplicarBtn.style.display = 'none'; // Ocultar el botón "Aplicar"

            const loaderDiv = document.createElement('div');
            loaderDiv.classList.add('loader');
            aplicarBtn.parentNode.appendChild(loaderDiv); // Mostrar la animación de carga

            try {
                const facturaRef = doc(dba, 'RegistroDeCompras', facturaId);
                const facturaSnap = await getDoc(facturaRef);

                if (!facturaSnap.exists()) {
                    console.error('La factura no existe.');
                    return;
                }

                const facturaData = facturaSnap.data();
                const pagos = facturaData.pagos;
                const fechaActualF = obtenerFechaActualF();

                if (!pagos || !pagos[pagoIndex]) {
                    console.error('El pago no existe.');
                    return;
                }

                const storage = getStorage(app);
                const reciboFolderRef = storageRef(storage, `recibos/${facturaId}/`);
                let reciboStorageRef = storageRef(reciboFolderRef, `${fechaActualF}-${pagoIndex}.pdf`);

                let i = 1;
                while (await getDownloadURL(reciboStorageRef).then(() => true).catch(() => false)) {
                    reciboStorageRef = storageRef(reciboFolderRef, `${fechaActualF}-${pagoIndex} (${i}).pdf`);
                    i++;
                }

                await uploadBytes(reciboStorageRef, reciboFile);
                const reciboURL = await getDownloadURL(reciboStorageRef);

                pagos[pagoIndex].reciboURL = reciboURL;

                await updateDoc(facturaRef, {
                    pagos: pagos
                });

                showAlert('Recibo subido y guardado con éxito.', 'alert-success');

                const payButton = document.getElementById(`pagarBtn-${facturaId}-${pagoIndex}`);
                payButton.disabled = false;
                aplicarBtn.disabled = true;

                loaderDiv.remove(); // Eliminar la animación de carga
                aplicarBtn.style.display = 'block'; // Mantener el botón "Aplicar" oculto

            } catch (error) {
                console.error('Error al subir el recibo:', error);
                showAlert('Hubo un error al subir el recibo. Inténtelo de nuevo.', 'alert-danger');

                loaderDiv.remove(); // Eliminar la animación de carga
                aplicarBtn.style.display = 'block'; // Mostrar el botón "Aplicar"
            }
        }


        window.pagarCuentasPorPagar = async function (facturaId, pagoIndex, monto) {
            try {
                const facturaRef = doc(dba, 'RegistroDeCompras', facturaId);
                const facturaSnap = await getDoc(facturaRef);

                if (!facturaSnap.exists()) {
                    console.error('La factura no existe.');
                    return;
                }

                const facturaData = facturaSnap.data();
                const pagos = facturaData.pagos;

                if (!pagos || !pagos[pagoIndex]) {
                    console.error('El pago no existe.');
                    return;
                }

                const fechaActual = obtenerFechaActual();

                pagos[pagoIndex].estatus = 'Pagado';
                pagos[pagoIndex].fechapago = fechaActual;

                await updateDoc(facturaRef, {
                    pagos: pagos
                });

                const todosPagados = pagos.every(pago => pago.estatus === 'Pagado');

                if (todosPagados) {
                    await updateDoc(facturaRef, {
                        estatus: 'Cerrada'
                    });
                }

                aplicarPagoCuentasPorPagar(facturaId);

            } catch (error) {
                console.error('Error al pagar:', error);
            }
        }





        // Función para mostrar/ocultar el formulario de pagos
        function toggleFormularioPagoCuentasPorPagar() {
            const formularioPagoCuentasPorPagar = document.getElementById('formularioPagoCuentasPorPagar');

            if (formularioPagoCuentasPorPagar.style.display === 'none') {
                formularioPagoCuentasPorPagar.style.display = 'block';
            } else {
                formularioPagoCuentasPorPagar.style.display = 'none';
            }
        }

        // Añadir el evento para cerrar el formulario de pagos
        document.getElementById('closeFormularioPagoCuentasPorPagar').addEventListener('click', () => {
            toggleFormularioPagoCuentasPorPagar();
        });

        // Escuchar el evento de entrada en el campo de búsqueda para filtrar las facturas
        document.getElementById('searchInputCuentasPorPagar').addEventListener('input', filterTableCuentasPorPagar);

        // Llamar a la función para cargar el historial de facturas abiertas al hacer clic en el enlace
        openHistorialCuentasPorPagar.addEventListener('click', async () => {
            toggleFormularioCuentasPorPagar(); // Mostrar el formulario antes de cargar las facturas

            await listarCuentasPorPagar(5, 1); // Llama a la función para cargar las facturas con los parámetros deseados
        });


        function toggleFormularioNotaCredito() {
            const fondoDesenfocado = document.getElementById('fondoDesenfocado');
            const formularioNotaCredito = document.getElementById('formularioNotaCredito');

            if (formularioNotaCredito.style.display === 'none' || formularioNotaCredito.style.display === '') {
                formularioNotaCredito.style.display = 'block';
                fondoDesenfocado.style.display = 'block';
                loadFacturas();
            } else {
                formularioNotaCredito.style.display = 'none';
                fondoDesenfocado.style.display = 'none';
            }
        }

        document.getElementById('NotaDeCredito').addEventListener('click', toggleFormularioNotaCredito);

        document.getElementById('closeNotaCreditoButton').addEventListener('click', toggleFormularioNotaCredito);

        document.getElementById('generarNotaCreditoButton').addEventListener('click', async (event) => {
            event.preventDefault();
            await generarNotaCredito();
            toggleFormularioNotaCredito();
        });


        async function loadFacturas() {
            const facturaSelect = document.getElementById('facturaSelect');
            facturaSelect.innerHTML = '<option selected>Elegir Factura</option>';

            try {
                const q = query(collection(dba, "facturas"), where("comprobante", "!=", null));
                const querySnapshot = await getDocs(q);

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.text = `Factura ${data.numeroFactura} - ${data.fecha}`;
                    facturaSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar las facturas:', error);
            }
        }

        document.getElementById('facturaSelect').addEventListener('change', async function () {
            const selectedOption = this.options[this.selectedIndex];
            const facturaId = selectedOption.value;

            try {
                const facturaDoc = await getDoc(doc(dba, "facturas", facturaId));
                if (facturaDoc.exists()) {
                    const facturaData = facturaDoc.data();
                    document.getElementById('comprobanteFiscalFactura').value = facturaData.comprobante;
                    document.getElementById('cliente').value = facturaData.paciente;
                }
            } catch (error) {
                console.error('Error al obtener los detalles de la factura:', error);
            }
        });

        async function generarNotaCredito() {
            const comprobanteFiscalFactura = document.getElementById('comprobanteFiscalFactura').value.trim();
            const monto = parseFloat(document.getElementById('monto').value.trim());
            const concepto = document.getElementById('concepto').value.trim();
            const cliente = document.getElementById('cliente').value.trim();

            if (comprobanteFiscalFactura === '' || isNaN(monto) || monto <= 0 || concepto === '' || cliente === '') {
                showAlert('Por favor, complete todos los campos obligatorios con valores válidos.', 'alert-warning');
                return;
            }

            let numeroNotaCredito = '';
            let fechaVencimiento = '';

            try {
                const comprobantesSnapshot = await get(ref(db, 'comprobantesNotaCredito/'));
                if (comprobantesSnapshot.exists()) {
                    const comprobantesData = comprobantesSnapshot.val();
                    const desde = comprobantesData.desde || '';
                    const hasta = comprobantesData.hasta || '';
                    fechaVencimiento = comprobantesData.fechaVencimiento || '';

                    let lastNotaCreditoNumber = await getLastNotaCreditoNumber();
                    let nextNotaCreditoNumber = lastNotaCreditoNumber + 1;

                    if (nextNotaCreditoNumber > parseInt(hasta.substring(1))) {
                        showAlert('Se ha alcanzado el límite máximo de notas de crédito para este comprobante.', 'alert-warning');
                        return;
                    }

                    numeroNotaCredito = `${desde.substring(0, 1)}${nextNotaCreditoNumber.toString().padStart(hasta.length - 1, '0')}`;
                    await updateLastNotaCreditoNumber(nextNotaCreditoNumber);
                } else {
                    showAlert('No se encontraron datos de comprobantes válidos.', 'alert-danger');
                    return;
                }
            } catch (error) {
                console.error('Error al obtener datos de comprobantes:', error);
                showAlert('Error al obtener datos de comprobantes.', 'alert-danger');
                return;
            }

            const notaCreditoData = {
                comprobanteFiscalFactura,
                monto,
                concepto,
                numeroNotaCredito,
                fechaVencimiento,
                fecha: obtenerFechaActual(),
                cliente
            };

            try {
                await addDoc(collection(dba, 'notasDeCredito'), notaCreditoData);
                showAlert('Nota de Crédito generada exitosamente.', 'alert-success');
                document.getElementById('notaCreditoForm').reset();
                document.getElementById('formularioNotaCredito').style.display = 'none';
                await generateNotaCreditoPDF(notaCreditoData);

            } catch (error) {
                console.error('Error al guardar la Nota de Crédito en Firestore:', error);
                showAlert('Error al guardar la Nota de Crédito.', 'alert-danger');
            }
        }

        async function getLastNotaCreditoNumber() {
            const lastNumberSnap = await get(ref(db, 'notaCreditoNumber/lastNumber'));
            return lastNumberSnap.exists() ? lastNumberSnap.val() : 0;
        }

        async function updateLastNotaCreditoNumber(newNumber) {
            try {
                const notaCreditoRef = ref(db, 'notaCreditoNumber/lastNumber');
                await set(notaCreditoRef, newNumber);
                console.log('Número de nota de crédito actualizado correctamente:', newNumber);
            } catch (error) {
                console.error('Error al actualizar el número de nota de crédito:', error);
            }
        }

        async function generateNotaCreditoPDF(notaCreditoData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const progressContainer = document.getElementById('progress-container');

            let { comprobanteFiscalFactura, monto, concepto, numeroNotaCredito, fecha, cliente } = notaCreditoData;

            doc.setFontSize(12);

            progressContainer.style.display = 'block';

            const logoImage = new Image();
            logoImage.src = 'unoin.png';

            logoImage.onload = async () => {
                const logoWidth = 30;
                const logoHeight = (logoWidth / logoImage.width) * logoImage.height;
                const marginRight = 15;
                const marginTop = 5;
                doc.addImage(logoImage, 'PNG', doc.internal.pageSize.width - logoWidth - marginRight, marginTop, logoWidth, logoHeight);

                doc.setFontSize(18);
                doc.text("NOTA DE CRÉDITO", 14, 15);

                doc.setFontSize(12);
                const empresaSnapshot = await get(ref(db, 'datos/'));
                const empresaData = empresaSnapshot.val();

                if (empresaData) {
                    doc.text(`${empresaData.name}`, 15, 25);
                    doc.text(`RNC: ${empresaData.rnc}`, 15, 30);
                    doc.text(`Teléfono: ${empresaData.number}`, 15, 35);

                    const location = empresaData.location;
                    if (location.length > 15) {
                        const firstLine = location.substring(0, 23);
                        let secondLine = location.substring(23);
                        if (secondLine.length > 35) {
                            const secondLineFirstPart = secondLine.substring(0, 35);
                            const secondLineSecondPart = secondLine.substring(35);
                            secondLine = secondLineFirstPart + '\n' + secondLineSecondPart;
                        }
                        doc.text(`Dirección: ${firstLine}`, 15, 40);
                        doc.text(`${secondLine}`, 15, 45);
                    } else {
                        doc.text(`Dirección: ${empresaData.location}`, 17, 40);
                    }
                }

                const marginLeft = 15;
                doc.text(`NCF Nota de Crédito: ${numeroNotaCredito}`, marginLeft, 60);

                const fechaActual = obtenerFechaActual();
                const fechaActualF = obtenerFechaActualF();
                const fechaX = marginLeft;
                doc.text(`Fecha: ${fecha}`, fechaX, 65);

                const nombreDoctorX = marginLeft;
                doc.text("NCF Factura:", nombreDoctorX, 75);
                doc.text(`${comprobanteFiscalFactura}`, nombreDoctorX, 80);

                doc.text(`Cliente: ${cliente}`, nombreDoctorX, 90);

                doc.line(14, 100, 200, 100);

                doc.autoTable({
                    head: [['Concepto']],
                    body: [[concepto]],
                    startY: 105
                });

                const totalY = doc.lastAutoTable.finalY + 10;
                doc.text(`Cantidad: $${monto.toFixed(2)}`, 14, totalY);

                const finalY = doc.internal.pageSize.height - 10;
                const lineaWidth = (doc.internal.pageSize.width - 100) / 2;
                const lineaX1 = (doc.internal.pageSize.width / 2) - (lineaWidth / 2);
                const lineaX2 = lineaX1 + lineaWidth;
                doc.setLineWidth(0.5);
                doc.line(lineaX1, finalY, lineaX2, finalY);

                const textoFirmaCelloX = doc.internal.pageSize.width / 2;
                const textoFirmaCelloY = finalY + 5;
                doc.setFontSize(10);
                doc.text("Firma y Sello", textoFirmaCelloX, textoFirmaCelloY, { align: "center" });

                const pdfBlob = doc.output('blob');

                try {
                    const storage = getStorage(app);

                    // Guardar en Storage usando el ID de la nota de crédito como carpeta
                    const notaCreditoFolderRef = storageRef(storage, `notasDeCredito/${numeroNotaCredito}/`);
                    let notaCreditoStorageRef = storageRef(notaCreditoFolderRef, `${fechaActualF}.pdf`);

                    // Verificar si ya existe un archivo con el mismo nombre
                    let i = 1;
                    while (await getDownloadURL(notaCreditoStorageRef).then(() => true).catch(() => false)) {
                        notaCreditoStorageRef = storageRef(notaCreditoFolderRef, `${fechaActualF} (${i}).pdf`);
                        i++;
                    }

                    await uploadBytes(notaCreditoStorageRef, pdfBlob);

                    const notaCreditoURL = await getDownloadURL(notaCreditoStorageRef);

                    // Definir correctamente la referencia al documento de la Nota de Crédito en Firestore
                    const notaCreditoDocRef = doc(dba, 'notasDeCredito', notaCreditoData.id);
                    await updateDoc(notaCreditoDocRef, { urlNotaCredito: notaCreditoURL });

                } catch (error) {
                    console.error('Error al guardar la Nota de Crédito en Storage:', error);
                } finally {
                    progressContainer.style.display = 'none';
                }

                showAlert('Nota de Crédito generada exitosamente.', 'alert-success');
                doc.save('nota_credito.pdf');
            };
        }


        document.getElementById('generateExcelButtonI').addEventListener('click', async (event) => {
            event.preventDefault();
            const excelButton = document.getElementById('generateExcelButtonI');
            const loader = document.getElementById('loaderExcel');

            // Ocultar el botón y mostrar el loader
            excelButton.style.display = 'none';
            loader.style.display = 'block';

            try {
                // Consulta para obtener todas las facturas sin filtrar por mes y año
                const q = collection(dba, "facturas");

                const querySnapshot = await getDocs(q);
                let totalEarnings = 0;

                // Crear una nueva instancia de workbook (libro de Excel)
                const workbook = new ExcelJS.Workbook();

                // Agregar una nueva hoja al libro
                const worksheet = workbook.addWorksheet('Registro de Ingresos');

                // Encabezados de la tabla de ingresos
                const headers = [
                    'Número de Factura',
                    'Fecha',
                    'Estatus',
                    'Ganancia Total',
                    'Pagos'
                ];

                // Agregar encabezados a la hoja de Excel
                worksheet.addRow(headers);

                // Iterar sobre todas las facturas encontradas
                for (const doc of querySnapshot.docs) {
                    const data = doc.data();
                    const { numeroFactura, fecha, estatus } = data;
                    let { ganancia } = data;
                    let pagosInfo = 'N/A';

                    // Extraer y convertir el valor de la ganancia a número
                    const gananciaValor = parseFloat(ganancia.split(' ')[0]);

                    // Verificar si la factura tiene pagos
                    const pagosSnapshot = await getDocs(collection(dba, `facturas/${doc.id}/pagos`));
                    if (!pagosSnapshot.empty) {
                        pagosInfo = '';
                        pagosSnapshot.forEach((pagoDoc) => {
                            const pagoData = pagoDoc.data();
                            const pagoGananciaStr = pagoData.ganancia || "0.00 DOP";
                            const pagoGanancia = parseFloat(String(pagoGananciaStr).split(' ')[0]);
                            const fechaPago = pagoData.fechapago ? pagoData.fechapago : 'Pendiente';
                            pagosInfo += `Pago ${pagoData.numeroPago} (Fecha: ${fechaPago}): $${pagoGanancia}, `;
                        });
                        pagosInfo = pagosInfo.slice(0, -2); // Eliminar la última coma y espacio
                    }

                    // Filtrar facturas con ganancia válida (mayor que 0 y no estatus Pendiente)
                    if (gananciaValor > 0 && !(estatus === 'Abierta' && ganancia === 'Pendiente')) {
                        // Agregar fila a la hoja de Excel
                        worksheet.addRow([numeroFactura, fecha, estatus, ganancia, pagosInfo]);

                        // Sumar la ganancia total
                        totalEarnings += gananciaValor;
                    }
                }

                // Establecer estilos para el encabezado
                const headerRow = worksheet.getRow(1);
                headerRow.eachCell((cell) => {
                    cell.font = { bold: true };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '0074D9' } };
                });

                // Ajustar el ancho de las columnas automáticamente
                worksheet.columns.forEach((column) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell) => {
                        const cellValue = cell.value ? cell.value.toString() : '';
                        maxLength = Math.max(maxLength, cellValue.length);
                    });
                    column.width = maxLength + 2;
                });

                // Guardar el archivo Excel
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Descargar el archivo Excel
                saveAs(blob, 'ganancias.xlsx');

                // Mostrar mensaje de éxito
                showAlertExcel('Archivo de Excel generado correctamente.', 'alert-success');

                // Actualizar el total de ganancias en la interfaz
                document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
            } catch (error) {
                console.error('Error al generar el archivo de Excel:', error);
                showAlertExcel(`Error al generar el archivo de Excel: ${error.message}`, 'alert-danger');
            } finally {
                // Restaurar el botón y ocultar el loader
                loader.style.display = 'none';
                excelButton.style.display = 'block';
            }
        });




        document.getElementById('generateExcelButtonE').addEventListener('click', async (event) => {
            event.preventDefault();

            const excelButton = document.getElementById('generateExcelButtonE');
            const loader = document.getElementById('loaderExcel2');

            // Ocultar el botón y mostrar el loaderSS
            excelButton.style.display = 'none';
            loader.style.display = 'block';

            try {
                // Consulta para obtener todas las facturas de RegistroDeCompras sin filtrar por mes y año
                const q = collection(dba, "RegistroDeCompras");

                const querySnapshot = await getDocs(q);
                let totalExpenses = 0;

                // Crear una nueva instancia de workbook (libro de Excel)
                const workbook = new ExcelJS.Workbook();

                // Agregar una nueva hoja al libro
                const worksheet = workbook.addWorksheet('Registro de Gastos');

                // Encabezados de la tabla de egresos
                const headers = [
                    'Suplidor Nombre',
                    'Número de Comprobante',
                    'Fecha',
                    'Estatus',
                    'Monto Pagado al momento del Registro',
                    'Monto Factura',
                    'Nombre Factura',
                    'Condición de Pago',
                    'Pagos'
                ];

                // Agregar encabezados a la hoja de Excel
                worksheet.addRow(headers);

                // Iterar sobre todas las facturas encontradas
                for (const doc of querySnapshot.docs) {
                    const data = doc.data();
                    const { suplidorNombre, numeroComprobante, fecha, estatus, montoApagar, montoFactura, nombreFactura, condicionpago } = data;
                    let pagosInfo = 'N/A';

                    // Verificar si la factura tiene pagos
                    const pagos = data.pagos || [];
                    if (pagos.length > 0) {
                        pagosInfo = '';
                        pagos.forEach((pago) => {
                            if (pago.estatus === 'Pagado') {
                                pagosInfo += `Pago ${pago.numeroPago} (Fecha: ${pago.fechapago || 'Pendiente'}): $${pago.monto}, `;
                                totalExpenses += parseFloat(pago.monto);
                            }
                        });
                        pagosInfo = pagosInfo.slice(0, -2); // Eliminar la última coma y espacio
                    }

                    if (estatus === 'Cerrada') {
                        // Agregar fila a la hoja de Excel para facturas cerradas
                        worksheet.addRow([suplidorNombre, numeroComprobante, fecha, estatus, montoApagar, montoFactura, nombreFactura, condicionpago, pagosInfo]);
                        totalExpenses += parseFloat(montoApagar);
                    } else if (estatus === 'Abierta' && montoApagar > 0) {
                        // Agregar fila a la hoja de Excel para facturas abiertas
                        worksheet.addRow([suplidorNombre, numeroComprobante, fecha, estatus, montoApagar, montoFactura, nombreFactura, condicionpago, pagosInfo]);
                        totalExpenses += parseFloat(montoApagar);
                    }
                }

                // Establecer estilos para el encabezado
                const headerRow = worksheet.getRow(1);
                headerRow.eachCell((cell) => {
                    cell.font = { bold: true };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '0074D9' } };
                });

                // Ajustar el ancho de las columnas automáticamente
                worksheet.columns.forEach((column) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell) => {
                        const cellValue = cell.value ? cell.value.toString() : '';
                        maxLength = Math.max(maxLength, cellValue.length);
                    });
                    column.width = maxLength + 2;
                });

                // Guardar el archivo Excel
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                // Descargar el archivo Excel
                saveAs(blob, 'gastos.xlsx');

                // Mostrar mensaje de éxito
                showAlertExcel('Archivo de Excel generado correctamente.', 'alert-success');

                // Actualizar el total de egresos en la interfaz
                document.getElementById('totalExpenses').textContent = `$${totalExpenses.toFixed(2)}`;
            } catch (error) {
                console.error('Error al generar el archivo de Excel:', error);
                showAlertExcel(`Error al generar el archivo de Excel: ${error.message}`, 'alert-danger');
            } finally {
                // Restaurar el botón y ocultar el loader
                loader.style.display = 'none';
                excelButton.style.display = 'block';
            }
        });


        document.getElementById('generateExcelButtonF').addEventListener('click', async (event) => {
            event.preventDefault();

            const excelButton = document.getElementById('generateExcelButtonF');
            const loader = document.getElementById('loaderExcel1');

            // Ocultar el botón y mostrar el loaderS
            excelButton.style.display = 'none';
            loader.style.display = 'block';

            try {
                // Consulta para obtener todas las facturas
                const facturasSnapshot = await getDocs(collection(dba, "facturas"));
                const recibosSnapshot = await getDocs(collection(dba, "recibos")); // Consulta para obtener todos los recibos
                let totalEarnings = 0;

                // Crear una nueva instancia de workbook (libro de Excel)
                const workbook = new ExcelJS.Workbook();

                // Agregar una hoja para las facturas
                const facturaSheet = workbook.addWorksheet('Facturas');

                // Encabezados de la tabla de facturas, agregando la columna "Items"
                const facturaHeaders = [
                    'Número de Factura', 'Fecha', 'Estatus', 'Ganancia', 'Comprobante', 'Doctor', 'Paciente', 'Total', 'Pagos', 'Forma de Pago', 'Items'
                ];

                facturaSheet.addRow(facturaHeaders);

                // Iterar sobre todas las facturas
                for (const doc of facturasSnapshot.docs) {
                    const data = doc.data();
                    const {
                        numeroFactura, fecha, estatus, ganancia, comprobante, doctor, paciente, total, formaDePago, items = []
                    } = data;
                    let pagosInfo = 'N/A';

                    // Verificar si la factura tiene pagos
                    const pagosSnapshot = await getDocs(collection(dba, `facturas/${doc.id}/pagos`));
                    if (!pagosSnapshot.empty) {
                        pagosInfo = ''; // Reiniciar pagosInfo si hay pagos
                        pagosSnapshot.forEach((pagoDoc) => {
                            const pagoData = pagoDoc.data();
                            const pagoGanancia = pagoData.total || 0;
                            const fechapago = pagoData.fechapago || 'Pendiente';
                            pagosInfo += `Pago ${pagoData.numeroPago} (Fecha: ${fechapago}): $${pagoGanancia}, `;
                        });
                        pagosInfo = pagosInfo.slice(0, -2); // Eliminar la última coma y espacio
                    }

                    // Formatear los ítems en un solo string para la columna de "Items"
                    let itemsInfo = 'N/A';
                    if (items.length > 0) {
                        itemsInfo = items.map(item => `${item.cantidad}x ${item.descripcion}`).join(', ');
                    }

                    if (!(estatus === 'Abierta' && ganancia === 'Pendiente')) {
                        facturaSheet.addRow([
                            numeroFactura, fecha, estatus, ganancia, comprobante ? comprobante : 'N/A', doctor, paciente, total, pagosInfo, formaDePago ? formaDePago : 'N/A', itemsInfo
                        ]);
                        totalEarnings += parseFloat(ganancia);
                    }
                }

                // Establecer estilos para el encabezado de facturas
                const facturaHeaderRow = facturaSheet.getRow(1);
                facturaHeaderRow.eachCell((cell) => {
                    cell.font = { bold: true };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '0074D9' } };
                });

                facturaSheet.columns.forEach((column) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell) => {
                        const cellValue = cell.value ? cell.value.toString() : '';
                        maxLength = Math.max(maxLength, cellValue.length);
                    });
                    column.width = maxLength + 2;
                });

                // Agregar una hoja para los recibos con color verde
                const reciboSheet = workbook.addWorksheet('Recibos', {
                    properties: { tabColor: { argb: '00FF00' } } // Color verde para la hoja
                });

                // Encabezados de la tabla de recibos
                const reciboHeaders = [
                    'Doctor', 'Fecha', 'Número de Factura', 'Número de Recibo', 'Paciente', 'Total Pago', 'Forma de Pago', 'Items', 'URL Recibo'
                ];

                reciboSheet.addRow(reciboHeaders);

                // Iterar sobre todos los recibos
                for (const doc of recibosSnapshot.docs) {
                    const data = doc.data();
                    const {
                        doctor = 'N/A', fecha = 'N/A', numeroFactura = 'N/A', numeroRecibo = 'N/A', paciente = 'N/A',
                        totalPago = 'N/A', formaDePago = 'N/A', items = [], urlRecibo = 'N/A', total = 'N/A'
                    } = data;

                    // Usar `total` si `totalPago` no está disponible
                    const totalPagoValue = totalPago !== 'N/A' ? totalPago : total;

                    let itemsInfo = 'N/A';
                    if (items.length > 0) {
                        itemsInfo = items.map(item => `${item.cantidad}x ${item.descripcion}`).join(', ');
                    }

                    reciboSheet.addRow([
                        doctor, fecha, numeroFactura, numeroRecibo, paciente, totalPagoValue, formaDePago, itemsInfo, urlRecibo
                    ]);
                }

                // Establecer estilos para el encabezado de recibos
                const reciboHeaderRow = reciboSheet.getRow(1);
                reciboHeaderRow.eachCell((cell) => {
                    cell.font = { bold: true };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '28A745' } }; // Verde oscuro para el encabezado
                });

                reciboSheet.columns.forEach((column) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell) => {
                        const cellValue = cell.value ? cell.value.toString() : '';
                        maxLength = Math.max(maxLength, cellValue.length);
                    });
                    column.width = maxLength + 2;
                });

                // Guardar el archivo Excel
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                saveAs(blob, 'facturas-recibos.xlsx');

                showAlertExcel('Archivo de Excel generado correctamente.', 'alert-success');
                document.getElementById('totalEarnings').textContent = `$${totalEarnings.toFixed(2)}`;
            } catch (error) {
                console.error('Error al generar el archivo de Excel:', error);
                showAlertExcel(`Error al generar el archivo de Excel: ${error.message}`, 'alert-danger');
            } finally {
                // Restaurar el botón y ocultar el loader
                loader.style.display = 'none';
                excelButton.style.display = 'block';
            }
        });


        async function generatePDFHorizontal(facturaId, doctorSeleccionado, pacienteSeleccionado, numeroFactura, totalPago) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); // Crear documento PDF en formato horizontal
            const progressContainer = document.getElementById('progress-container');
            const fondoDesenfocado = document.getElementById('fondoDesenfocado');

            doc.setFontSize(12);

            progressContainer.style.display = 'block';
            fondoDesenfocado.style.display = 'block';

            const logoImage = new Image();
            logoImage.src = 'unoin.png';

            logoImage.onload = async () => {
                const logoWidth = 30;
                const logoHeight = (logoWidth / logoImage.width) * logoImage.height;
                const marginRight = 15;
                const marginTop = 5;
                doc.addImage(logoImage, 'PNG', doc.internal.pageSize.width - logoWidth - marginRight, marginTop, logoWidth, logoHeight);

                doc.setFontSize(18);
                doc.text("RECIBO DE PAGO ", 14, 15);

                doc.setFontSize(12);
                const empresaSnapshot = await get(ref(db, 'datos/'));
                const empresaData = empresaSnapshot.val();

                if (empresaData) {
                    doc.text(`${empresaData.name}`, 15, 25);
                    doc.text(`RNC: ${empresaData.rnc}`, 15, 30);
                    doc.text(`Teléfono: ${empresaData.number}`, 15, 35);

                    const location = empresaData.location;
                    if (location.length > 15) {
                        const firstLine = location.substring(0, 23);
                        let secondLine = location.substring(23);
                        if (secondLine.length > 35) {
                            const secondLineFirstPart = secondLine.substring(0, 35);
                            const secondLineSecondPart = secondLine.substring(35);
                            secondLine = secondLineFirstPart + '\n' + secondLineSecondPart;
                        }
                        doc.text(`Dirección: ${firstLine}`, 15, 40);
                        doc.text(`${secondLine}`, 15, 45);
                    } else {
                        doc.text(`Dirección: ${empresaData.location}`, 17, 40);
                    }
                }

                const marginLeft = 15;
                const numeroRecibo = await obtenerNumeroRecibo();
                const fechaActual = obtenerFechaActual();
                const fechaActualF = obtenerFechaActualF();

                doc.text(`No. Recibo: ${numeroRecibo}`, marginLeft, 60);

                doc.text(`Fecha: ${fechaActual}`, marginLeft, 70);
                doc.text(`Doctor: ${doctorSeleccionado}`, marginLeft, 80);
                doc.text(`Facturado a: ${pacienteSeleccionado}`, marginLeft, 90);

                doc.line(14, 100, 280, 100); // Ajusta la longitud de la línea horizontal

                doc.autoTable({
                    head: [['Concepto']],
                    body: [[`Pago parcial a la Factura No. ${numeroFactura}`]],
                    startY: 100
                });

                doc.text(`Cantidad: $ ${totalPago}`, 14, doc.lastAutoTable.finalY + 10);

                const finalY = doc.internal.pageSize.height - 10; // Posición Y para la línea y texto
                const lineaWidth = (doc.internal.pageSize.width - 100) / 2; // Longitud de la línea reducida a la mitad
                const lineaX1 = (doc.internal.pageSize.width / 2) - (lineaWidth / 2); // Coordenada X inicial de la línea
                const lineaX2 = lineaX1 + lineaWidth; // Coordenada X final de la línea
                doc.setLineWidth(0.5);
                doc.line(lineaX1, finalY, lineaX2, finalY);

                // Texto "Firma y Cello"
                const textoFirmaCelloX = doc.internal.pageSize.width / 2;
                const textoFirmaCelloY = finalY + 5; // Ajusta la posición vertical según necesites
                doc.setFontSize(10);
                doc.text("Firma", textoFirmaCelloX, textoFirmaCelloY, { align: "center" });

                const pdfBlob = doc.output('blob');

                try {
                    const storage = getStorage(app);

                    // Obtener el ID del paciente seleccionado
                    const pacienteId = await getPacienteIdFromDatabase(pacienteSeleccionado);

                    if (!pacienteId) {
                        showAlert('Paciente no encontrado en la base de datos. Verifique el nombre e inténtelo nuevamente.', 'alert-danger');
                        return;
                    }

                    // Guardar en Storage usando el ID del paciente como carpeta
                    const pacienteFolderRef = storageRef(storage, `recibos/${pacienteId}/`);
                    let reciboStorageRef = storageRef(pacienteFolderRef, `${fechaActualF}.pdf`);

                    // Verificar si ya existe un archivo con el mismo nombre
                    let i = 1;
                    while (await getDownloadURL(reciboStorageRef).then(() => true).catch(() => false)) {
                        reciboStorageRef = storageRef(pacienteFolderRef, `${fechaActualF} (${i}).pdf`);
                        i++;
                    }

                    await uploadBytes(reciboStorageRef, pdfBlob);

                    const reciboURL = await getDownloadURL(reciboStorageRef);

                    const reciboData = {
                        paciente: pacienteSeleccionado,
                        pacienteUID: pacienteId,
                        doctor: doctorSeleccionado,
                        numeroRecibo: numeroRecibo,
                        numeroFactura: numeroFactura,
                        fecha: fechaActual,
                        totalPago: totalPago,
                        urlRecibo: reciboURL
                    };

                    await addDoc(collection(dba, 'recibos'), reciboData)


                } catch (error) {
                    console.error('Error al guardar el recibo en Storage:', error);
                } finally {
                    progressContainer.style.display = 'none';
                }

                doc.save('recibo.pdf');
            };
        }

        async function getPacienteIdFromDatabase(pacienteName) {
            const pacientesSnapshot = await getDocs(collection(getFirestore(), 'pacientes'));

            const nombreNormalizado = pacienteName.trim().toLowerCase();

            const pacienteDoc = pacientesSnapshot.docs.find(doc => {
                const { fname, lname } = doc.data();
                const nombreCompleto = `${fname} ${lname}`.toLowerCase().trim();
                return nombreCompleto === nombreNormalizado;
            });

            if (pacienteDoc) {
                return pacienteDoc.id;
            } else {
                console.error(`Paciente no encontrado en la base de datos: ${pacienteName}`);
                return null;
            }
        }


        function obtenerFechaActualF() {
            const fecha = new Date();
            const dia = fecha.getDate();
            const mes = fecha.getMonth() + 1;
            const año = fecha.getFullYear();
            return `${dia}-${mes}-${año}`;
        }


        async function obtenerNumeroRecibo() {
            try {
                const reciboRef = ref(db, 'numerosRecibo/ultimoNumero'); // Referencia al documento que contiene el último número de recibo
                const reciboSnapshot = await get(reciboRef); // Obtener el snapshot del documento

                let ultimoNumero = 0;
                if (reciboSnapshot.exists()) {
                    ultimoNumero = reciboSnapshot.val(); // Obtener el último número de recibo
                }

                const nuevoNumero = ultimoNumero + 1; // Generar el nuevo número de recibo

                await set(reciboRef, nuevoNumero); // Actualizar el número de recibo en Firestore

                return nuevoNumero; // Devolver el nuevo número de recibo generado
            } catch (error) {
                console.error('Error al obtener o actualizar el número de recibo:', error);
                return null; // Manejar errores retornando null o un valor predeterminado
            }
        }


        function showSuccessAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.classList.add('alert', 'alert-dismissible', 'alert-success', 'position-fixed', 'top-50', 'start-50', 'translate-middle');
            alertDiv.style.zIndex = '1050';  // Asegurar que el z-index sea alto para estar encima de otros elementos
            alertDiv.innerHTML = `
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <strong>¡Bien hecho!</strong> ${message}
    `;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }


        function showAlertExcel(message, alertType) {
            const alertBox = document.createElement('div');
            alertBox.className = `alert ${alertType} position-fixed top-50 start-50 translate-middle`;
            alertBox.style.zIndex = '1050'; // Asegurar que el z-index sea alto para estar encima de otros elementos
            alertBox.innerHTML = `
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <strong>¡Bien hecho!</strong> ${message}
    `;
            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        }

        function showAlert(message, alertType) {
            const alertBox = document.createElement('div');
            alertBox.className = `alert ${alertType} position-fixed top-50 start-50 translate-middle`;
            alertBox.style.zIndex = '1050'; // Asegurar que el z-index sea alto para estar encima de otros elementos

            let heading;
            if (alertType === 'alert-success') {
                heading = '¡Bien hecho!';
            } else if (alertType === 'alert-danger') {
                heading = '¡Advertencia!';
            } else {
                heading = '¡Atención!';
            }

            alertBox.innerHTML = `
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <strong>${heading}</strong> ${message}
    `;

            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        }





    </script>


    <script src="popper.min.js"></script>
    <script src="simplebar.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="custom-font.js"></script>
    <script src="pcoded.js"></script>
    <script src="feather.min.js"></script>





    <script>layout_change('light');</script>




    <script>font_change("Roboto");</script>


    <script>change_box_container('false');</script>


    <script>layout_caption_change('true');</script>




    <script>layout_rtl_change('false');</script>


    <script>preset_change("preset-1");</script>




</html>