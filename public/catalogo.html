<!DOCTYPE html>
<html lang="es">

<head>
    <title>Catálogo de Cuentas</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
        id="main-font-link">
    <link rel="stylesheet" href="tabler-icons.min.css">
    <link rel="stylesheet" href="feather.css">
    <link rel="stylesheet" href="fontawesome.css">
    <link rel="stylesheet" href="material.css">
    <link rel="stylesheet" href="style.css" id="main-style-link">
    <link rel="stylesheet" href="style-preset.css">
    <style>
        .text-dark-blue {
            color: darkblue;
        }

        .btn-dark-blue {
            background-color: darkblue;
            color: white;
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-dark-red {
            background-color: rgb(180, 13, 13);
            color: white;
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-dark-red:hover {
            background-color: rgb(148, 15, 15);
        }

        .btn-dark-blue:hover {
            background-color: navy;
        }

        .btn-dark-alert {
            background-color: rgb(243, 191, 22);
            color: white;
            border: none;
            transition: background-color 0.3s ease;
        }

        .btn-dark-alert:hover {
            background-color: rgb(197, 165, 20);
        }

        .formulario-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }

        @media only screen and (max-width: 768px) {
            table {
                font-size: 0.8em;
            }

            .form-control {
                font-size: 0.8em;
            }
        }

        @media only screen and (max-width: 480px) {
            table {
                font-size: 0.6em;
            }

            .form-control {
                font-size: 0.6em;
            }
        }

        @media (max-width: 768px) {
            .formulario-container {
                width: 100%;
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }

            .col-md-6 {
                width: 100%;
            }

            .form-floating {
                width: 100%;
            }

            .form-check {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .form-control {
                font-size: 16px;
                padding: 10px;
            }

            .form-label {
                font-size: 16px;
            }
        }

        @media (max-width: 768px) {
            .card-header form {
                flex-direction: column;
            }

            .card-header input[type="search"] {
                width: 100%;
                margin-bottom: 10px;
            }

            .card-header button[type="button"] {
                width: 100%;
                margin-bottom: 10px;
            }
        }

        @media (max-width: 768px) {
            .card-header input[type="search"] {
                font-size: 16px;
                padding: 10px;
            }

            .card-header button[type="button"] {
                font-size: 16px;
                padding: 10px;
            }
        }

        .subcuenta {
            padding-left: 20px;
        }

        .loader {
            width: 120px;
            height: 22px;
            border-radius: 20px;
            color: #008cff;
            /* Color azul */
            border: 2px solid;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .loader::before {
            content: "";
            position: absolute;
            margin: 2px;
            inset: 0 100% 0 0;
            border-radius: inherit;
            background: currentColor;
            animation: l6 2s infinite;
        }

        @keyframes l6 {
            100% {
                inset: 0;
            }
        }

        /* Fondo desenfocado */
        #fondoDesenfocado {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.5);
            /* Fondo blanco semi-transparente */
            backdrop-filter: blur(5px);
            display: none;
            /* Inicialmente oculto */
            z-index: 9998;
            /* Asegurar que esté detrás del loader */
        }

        #fondoDesenfocado2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;

        }

        #fondoDesenfocado3 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;

        }

        /* Contenedor del loader */
        #loaderContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            /* Asegurar que esté encima de todo */
            display: none;
            /* Inicialmente oculto */
        }

        #historialTableContainer {
            display: none;
        }

        /* HTML: <div class="loader"></div> */
        .loaderR {
            width: 40px;
            padding: 8px;
            aspect-ratio: 1;
            border-radius: 50%;
            background: #20c4ab;
            --_m:
                conic-gradient(#0000 10%, #000),
                linear-gradient(#000 0 0) content-box;
            -webkit-mask: var(--_m);
            mask: var(--_m);
            -webkit-mask-composite: source-out;
            mask-composite: subtract;
            animation: l3 1s infinite linear;
        }

        @keyframes l3 {
            to {
                transform: rotate(1turn)
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx-style/0.8.13/xlsx-style.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.1/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

</head>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const userCreds = sessionStorage.getItem("user-creds");
        if (!userCreds && window.location.pathname.includes('catalogo-de-cuentas')) {
            window.location.href = 'login';
        }

    });
</script>


<body data-pc-preset="preset-1" data-pc-sidebar-theme="light" data-pc-sidebar-caption="true" data-pc-direction="ltr"
    data-pc-theme="light">
    <div class="loader-bg">
        <div class="loader-track">
            <div class="loader-fill"></div>
        </div>
    </div>
    <nav class="pc-sidebar">
        <div class="navbar-wrapper">
            <div class="m-header">
                <a href="home" class="b-brand text-primary">
                    <img src="Designer (7).jpeg" style="width: 90px; height: 90px; border-radius: 5px;" alt="...">
                </a>
            </div>
            <div class="navbar-content">
                <ul class="pc-navbar">
                    <li class="pc-item pc-caption">
                        <label>Dashboard</label>
                        <i class="ti ti-dashboard"></i>
                    </li>
                    <li class="pc-item">
                        <a href="home" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-dashboard"></i></span>
                            <span class="pc-mtext">Sistema</span>
                        </a>
                    </li>
                    <li class="pc-item pc-caption">
                        <label>Empresa</label>
                        <i class="ti ti-dashboard"></i>
                    </li>
                    <li class="pc-item">
                        <a href="info" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-clipboard-list"></i></span>
                            <span class="pc-mtext">Datos</span>
                        </a>
                    </li>
                    <li class="pc-item">
                        <a href="employees" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-friends"></i></span>
                            <span class="pc-mtext">Empleados</span>
                        </a>
                    </li>
                    <li class="pc-item">
                        <a href="finanzas" class="pc-link disabled" id="finanzas">
                            <span class="pc-micon"><i class="ti ti-report-money"></i></span>
                            <span class="pc-mtext">Finanzas</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <header class="pc-header">
        <div class="header-wrapper">
            <div class="ms-auto">
                <ul class="list-unstyled">
                    <li class="pc-h-item header-mobile-collapse">
                        <a href="#" class="pc-head-link head-link-secondary ms-0" id="sidebar-hide">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="pc-h-item pc-sidebar-popup">
                        <a href="#" class="pc-head-link head-link-secondary ms-0" id="mobile-collapse">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="dropdown pc-h-item header-user-profile">
                        <a class="pc-head-link head-link-primary dropdown-toggle arrow-none me-0"
                            data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false"
                            aria-expanded="false">
                            <img src="Designer (7).jpeg" style="width: 50px; height: 50px; border-radius: 50%;" />
                            <span><i class="ti ti-settings"></i></span>
                        </a>
                        <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown">
                            <div class="dropdown-header">
                                <h4>Hola, <span class="small text-muted" id="username"> Name</span></h4>
                                <p class="text-muted" id="role">Rol</p>
                                <hr>
                                <div class="profile-notification-scroll position-relative"
                                    style="max-height: calc(100vh - 280px)">
                                    <hr>
                                    <button id="settingsButton" type="submit" class="dropdown-item">
                                        <i class="ti ti-settings"></i>
                                        <span>Configuración</span>
                                    </button>
                                    <button id="registerButton" type="submit" class="dropdown-item">
                                        <i class="ti ti-user-plus"></i>
                                        <span>Registro</span>
                                    </button>
                                    <button class="dropdown-item" id="signoutbutton">
                                        <i class="ti ti-logout"></i>
                                        <span>Cerrar Sesión</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </header>
    <div class="pc-container">
        <div class="pc-content">
            <div class="row">
                <div class="col">
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="home">Sistema</a></li>
                        <li class="breadcrumb-item"><a href="finanzas">Finanzas</a></li>
                        <li class="breadcrumb-item" aria-current="page">Catálogo de Cuentas</li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Catálogo de Cuentas Contables</h5>
                            <div class="card-header">
                                <a href="#" class="pc-link" id="nuevo" style="margin-right: 10px;">
                                    <span class="pc-micon"><i class="ti ti-crosshair"></i></span>
                                    <span class="pc-mtext">Nueva Cuenta</span>
                                </a>
                                <a href="#" class="pc-link" id="transferir" style="margin-left: 10px;">
                                    <span class="pc-micon"><i class="ti ti-arrow-right"></i></span>
                                    <span class="pc-mtext">Transferir Monto</span>
                                </a>
                            </div>
                            <!-- <div class="card-header">
                                <form id="MainFormSE" class="d-flex" style="max-width: 400px;">
                                    <input id="searchInput" class="form-control me-sm-2" type="search" placeholder="Buscar" style="flex: 1 0 auto;">
                                    <button id="generatePDFbutton" type="button" class="btn btn-dark-red fa-solid fa-file-pdf"></button>
                                </form>
                            </div> -->
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" style="overflow-x: auto;">
                                    <thead>
                                        <tr>
                                            <th scope="col">Código</th>
                                            <th scope="col">Nombre</th>
                                            <th scope="col">Origen</th>
                                            <th scope="col">Monto</th>
                                        </tr>
                                    </thead>
                                    <tbody id="catalogoCuentas">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="HistorialTransacciones" class="formulario-container"
            style="display: none; width: 50%; max-width: 1400px; margin: auto;">
            <h3 class="mb-3">Historial de Transacciones</h3>

            <!-- Filtro por Mes -->
            <div class="filter-container d-flex align-items-center mb-4 p-3"
                style="background-color: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">

                <label for="filterMonth" class="form-label mb-0 me-2">Filtrar por mes:</label>
                <input type="month" id="filterMonth" class="form-control me-2" style="max-width: 200px;">
                <button id="applyFilter" class="btn btn-primary">Aplicar Filtro</button>
            </div>

            <!-- Generar Reporte en Excel -->
            <div class="report-container p-3"
                style="background-color: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">

                <h5 class="mb-3">Generar Reporte en Excel</h5>

                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center me-3">
                        <label for="startMonth" class="form-label mb-0 me-2">Mes de inicio:</label>
                        <input type="month" id="startMonth" class="form-control" style="max-width: 200px;">
                    </div>
                    <div class="d-flex align-items-center me-3">
                        <label for="endMonth" class="form-label mb-0 me-2">Mes de fin:</label>
                        <input type="month" id="endMonth" class="form-control" style="max-width: 200px;">
                    </div>
                    <button id="generateExcel" class="btn btn-success" style="max-width: 100px;">Generar
                        Reporte</button>
                </div>
            </div>


            <!-- Lista de Transacciones -->
            <div id="listaTransacciones" class="lista-transacciones mt-3">
                <table class="table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Desde</th>
                            <th>Hacia</th>
                            <th>Concepto</th>
                            <th>Monto</th>
                            <th>Documento de referencia</th>
                            <th>Tipo</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="historialTable">
                        <!-- Transacciones se mostrarán aquí -->
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <div>
                <ul class="pagination" id="paginationTransacciones">
                    <!-- Botones de paginación dinámicos -->
                </ul>
            </div>

            <!-- Botón de Cerrar -->
            <div class="d-grid mt-2">
                <button type="button" class="btn btn-danger" id="closeHistorialButton">Cerrar</button>
            </div>
        </div>




        <div id="nuevoFormulario" class="formulario-container" style="display: none;">
            <h3 class="mb-3" id="formularioTitulo">Crear Nueva Cuenta</h3>
            <form id="MainForm">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="codigoCuenta" placeholder="Código">
                    <label for="codigoCuenta">*Código</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="nombreCuenta" placeholder="Nombre">
                    <label for="nombreCuenta">*Nombre</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="origenCuenta" placeholder="Origen de cuenta">
                    <label for="origenCuenta">*Origen de cuenta</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="montoCuenta" placeholder="Monto">
                    <label for="montoCuenta">*Monto</label>
                </div>
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-success" id="saveButton">Guardar</button>
                </div>
                <div class="d-grid mt-2">
                    <button type="button" class="btn btn-danger" id="closeButton">Cerrar</button>
                </div>
            </form>
        </div>
        <div id="transferenciaContainer" class="formulario-container" style="display: none;">
            <h3>Transferir Monto entre Cuentas</h3>
            <form id="transferenciaForm">
                <div class="form-floating mb-3">
                    <select id="cuentaOrigen" class="form-control">
                        <option value="">Seleccionar cuenta de origen</option>
                        <!-- Las cuentas contables se agregarán dinámicamente -->
                    </select>
                    <label for="cuentaOrigen">*Cuenta Origen</label>
                </div>

                <div class="form-floating mb-3">
                    <select id="cuentaDestino" class="form-control">
                        <option value="">Seleccionar cuenta de destino</option>
                        <!-- Las cuentas contables se agregarán dinámicamente -->
                    </select>
                    <label for="cuentaDestino">*Cuenta Destino</label>
                </div>

                <div class="form-floating mb-3">
                    <input type="number" class="form-control" id="montoTransferencia" placeholder="Monto a transferir">
                    <label for="montoTransferencia">*Monto</label>
                </div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-success">Transferir</button>
                </div>

                <div class="d-grid mt-2">
                    <button type="button" class="btn btn-danger" id="closeTransferenciaButton">Cancelar</button>
                </div>
            </form>
        </div>

        <div id="fondoDesenfocado2"></div>
        <div id="fondoDesenfocado3"></div>
        <div id="fondoDesenfocado"></div>
        <div id="loaderContainer">
            <div class="loader"></div>
        </div>
    </div>
    <footer class="pc-footer">
        <div class="footer-wrapper container-fluid">
            <div class="row">
                <div class="col-sm-6 my-1">
                    <p class="m-0">By: Luz Collado<a target="_blank"></a></p>
                </div>
            </div>
        </div>
    </footer>
    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
        import { getFirestore, collection, orderBy, addDoc, query, limit, getDocs, getDoc, doc, deleteDoc, updateDoc, where, runTransaction, writeBatch, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, uploadBytesResumable, listAll } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";
        import { getDatabase, set, ref, get, child } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCknSaxVHB10B_v-4yD9UtNj1dmZZKVRe4",
            authDomain: "billing-system-fbfb3.firebaseapp.com",
            projectId: "billing-system-fbfb3",
            storageBucket: "billing-system-fbfb3.appspot.com",
            messagingSenderId: "906484441227",
            appId: "1:906484441227:web:7b486131ad930a7b03b48e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();
        const dba = getDatabase();

        let isEditing = false;
        let currentEditingId = null;
        let currentEditingSubIndex = null;
        let isAddingSubcuenta = false;


        const usernameElement = document.getElementById('username');
        const roleElement = document.getElementById('role');
        const registerButton = document.getElementById('registerButton');
        const settingsButton = document.getElementById('settingsButton');
        const empleados = document.getElementById('empleados');
        document.getElementById('montoCuenta').disabled = true;
        document.getElementById('montoCuenta').disabled = true;

        function showUserData(userId) {
            const dbRef = ref(dba);
            get(child(dbRef, `UsersAuthList/${userId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    usernameElement.textContent = `${userData.firstname} ${userData.lastname}`;
                    roleElement.textContent = userData.roleselect;

                    if (userData.roleselect === 'Asistente') {
                        registerButton.disabled = true;
                        document.getElementById('empleados').classList.add('disabled');
                        document.getElementById('empleados').addEventListener('click', function (event) {
                            event.preventDefault();
                        });

                        const pacientesLink = document.getElementById('pacientesLink');
                        pacientesLink.removeAttribute('href');
                        pacientesLink.style.pointerEvents = 'none';
                        pacientesLink.style.opacity = '0.5';

                        const productosLink = document.getElementById('productosLink');
                        productosLink.removeAttribute('href');
                        productosLink.style.pointerEvents = 'none';
                        productosLink.style.opacity = '0.5';

                        const suplidorLink = document.getElementById('suplidorLink');
                        suplidorLink.removeAttribute('href');
                        suplidorLink.style.pointerEvents = 'none';
                        suplidorLink.style.opacity = '0.5';
                    }
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        function showUserData2(userId) {
            const dbRef = ref(dba);
            get(child(dbRef, `UsersAuthList/${userId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    usernameElement.textContent = `${userData.firstname} ${userData.lastname}`;
                    roleElement.textContent = userData.roleselect;

                    if (userData.roleselect === 'Administrador de Almacén') {
                        registerButton.disabled = true;
                        document.getElementById('empleados').addEventListener('click', function (event) {
                            event.preventDefault();
                        });
                        const pacientesLink = document.getElementById('pacientesLink');
                        pacientesLink.removeAttribute('href');
                        pacientesLink.style.pointerEvents = 'none';
                        pacientesLink.style.opacity = '0.5';

                        const facturarLink = document.getElementById('facturarLink');
                        facturarLink.removeAttribute('href');
                        facturarLink.style.pointerEvents = 'none';
                        facturarLink.style.opacity = '0.5';

                    }
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                showUserData(user.uid);
                showUserData2(user.uid);
                // showUserData3(user.uid);
            } else {
                console.log("User is not signed in");
            }
        });

        let UserCreds = JSON.parse(sessionStorage.getItem("user-creds"));
        let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));
        let UserName = JSON.parse(sessionStorage.getItem("username"));
        let Role = JSON.parse(sessionStorage.getItem("role"));

        let SignoutBtn = document.getElementById('signoutbutton');

        let Signout = () => {
            sessionStorage.removeItem("user-creds");
            sessionStorage.removeItem("user-info");

            window.location.href = 'login';
        }

        let CheckCred = () => {
            if (!sessionStorage.getItem("user-creds"))
                window.location.href = 'login';
            else {
                UserName.innerText = ` ${UserName.firstname}`
                Role.innerText = ` ${UserName.roleselect}`
            }
        }

        document.getElementById('registerButton').addEventListener('click', () => {
            window.location.href = 'register';
        });

        document.getElementById('settingsButton').addEventListener('click', () => {
            window.location.href = 'settings';
        });

        SignoutBtn.addEventListener('click', Signout);

        document.getElementById('nuevo').addEventListener('click', () => {
            abrirFormulario('Crear Nueva Cuenta');
        });

        document.getElementById('closeButton').addEventListener('click', () => {
            cerrarFormulario();
        });

        document.getElementById('MainForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const codigoCuenta = document.getElementById('codigoCuenta').value;
            const nombreCuenta = document.getElementById('nombreCuenta').value;
            const origenCuenta = document.getElementById('origenCuenta').value;
            let montoCuenta = 0; // Establecer monto en 0 para la creación inicial
            document.getElementById('montoCuenta').disabled = true; // Deshabilitar campo durante la creación

            if (!codigoCuenta || !nombreCuenta || !origenCuenta) {
                showAlert('Por favor, complete todos los campos.', 'alert-warning');
                return;
            }

            try {
                if (isEditing && !isAddingSubcuenta) {
                    // Actualizar cuenta existente
                    if (currentEditingSubIndex === null) {
                        await updateDoc(doc(db, 'CatalogoCuentas', currentEditingId), {
                            codigo: codigoCuenta,
                            nombre: nombreCuenta,
                            origen: origenCuenta,
                            monto: parseFloat(montoCuenta)
                        });
                        showAlert('Cuenta actualizada exitosamente.', 'alert-success');
                    } else {
                        // Actualizar subcuenta existente
                        const cuentaRef = doc(db, 'CatalogoCuentas', currentEditingId);
                        const cuentaDoc = await getDoc(cuentaRef);

                        if (cuentaDoc.exists()) {
                            const cuentaData = cuentaDoc.data();
                            cuentaData.subcuentas[currentEditingSubIndex] = {
                                codigo: codigoCuenta,
                                nombre: nombreCuenta,
                                origen: origenCuenta,
                                monto: parseFloat(montoCuenta)
                            };

                            await updateDoc(cuentaRef, {
                                subcuentas: cuentaData.subcuentas
                            });

                            showAlert('Subcuenta actualizada exitosamente.', 'alert-success');
                        }
                    }
                } else if (isAddingSubcuenta) {
                    // Agregar nueva subcuenta
                    const cuentaRef = doc(db, 'CatalogoCuentas', currentEditingId);
                    const cuentaDoc = await getDoc(cuentaRef);

                    if (cuentaDoc.exists()) {
                        const cuentaData = cuentaDoc.data();
                        cuentaData.subcuentas.push({
                            codigo: codigoCuenta,
                            nombre: nombreCuenta,
                            origen: origenCuenta,
                            monto: 0 // Establecer monto en 0 para la nueva subcuenta
                        });

                        await updateDoc(cuentaRef, {
                            subcuentas: cuentaData.subcuentas
                        });

                        showAlert('Subcuenta agregada exitosamente.', 'alert-success');
                    }
                } else {
                    // Crear nueva cuenta
                    await addDoc(collection(db, 'CatalogoCuentas'), {
                        codigo: codigoCuenta,
                        nombre: nombreCuenta,
                        origen: origenCuenta,
                        monto: 0, // Establecer monto en 0 para la nueva cuenta
                        subcuentas: []
                    });
                    showAlert('Cuenta creada exitosamente.', 'alert-success');
                }

                cerrarFormulario();
                cargarCatalogoCuentas();
            } catch (error) {
                console.error('Error al guardar la cuenta:', error);
            }
        });


        async function cargarCatalogoCuentas() {
            const catalogoCuentas = document.getElementById('catalogoCuentas');
            const fondoDesenfocado = document.getElementById('fondoDesenfocado');
            const loaderContainer = document.getElementById('loaderContainer');

            catalogoCuentas.innerHTML = '';

            // Mostrar el loader y desenfocar el fondo
            fondoDesenfocado.style.display = 'block';
            loaderContainer.style.display = 'block';

            try {

                const querySnapshot = await getDocs(collection(db, 'CatalogoCuentas'));
                const transaccionesSnapshot = await getDocs(collection(db, 'transacciones'));
                const transacciones = transaccionesSnapshot.docs.map(doc => doc.data());

                for (const doc of querySnapshot.docs) {
                    const data = doc.data();
                    let montoTotal = 0; // Iniciar el montoTotal en 0 para calcular desde cero


                    // Si hay más de 30 pacientes, dividir en grupos
                    if (data.pacientes && data.pacientes.length > 30) {
                        const gruposPacientes = [];
                        for (let i = 0; i < data.pacientes.length; i += 30) {
                            gruposPacientes.push(data.pacientes.slice(i, i + 30));
                        }

                        // Procesar cada grupo de pacientes
                        for (const grupo of gruposPacientes) {
                            montoTotal += await calcularMontoCuenta(doc.id, grupo);
                        }
                    } else {
                        montoTotal += await calcularMontoCuenta(doc.id, data.pacientes);
                    }

                    for (const transaccion of transacciones) {
                        if (transaccion.cuentaOrigen === doc.id) {
                            montoTotal -= transaccion.monto;
                        }
                        if (transaccion.cuentaDestino === doc.id) {
                            montoTotal += transaccion.monto;
                        }
                    }


                    // Guardar el monto total recalculado en Firestore
                    await updateDoc(doc.ref, { monto: montoTotal });

                    const row = document.createElement('tr');
                    row.ondblclick = () => editarCuenta(doc.id);
                    row.innerHTML = `
                <td>${data.codigo}</td>
                <td>${data.nombre}</td>
                <td>${data.origen}</td>
                <td>${montoTotal.toFixed(2)}</td>
<td>
    <div style="display: flex; gap: 10px; align-items: center;">
        <button class="btn btn-sm btn-warning" onclick="agregarSubcuenta('${doc.id}')">
            <i class="ti ti-circle-plus" style="font-size: 1.2rem;"></i>
        </button>

        <div id="transaccionesContainer-${doc.id}" style="position: relative;">
            <button class="btn btn-sm btn-info" id="transaccionesButton-${doc.id}" onclick="mostrarTransacciones('${doc.id}', 'loaderContainerR-${doc.id}')">
                <i class="ti ti-list" style="font-size: 1.2rem;"></i> Transacciones
            </button>
            <div id="loaderContainerR-${doc.id}" class="loaderR" style="display: none;"></div>
        </div>

        <button class="btn btn-sm btn-danger" onclick="eliminarCuenta('${doc.id}')">
            <i class="ti ti-trash" style="font-size: 1.2rem;"></i>
        </button>
    </div>
</td>


            `;
                    catalogoCuentas.appendChild(row);

                    // Procesar las subcuentas, si existen
                    for (const [index, subcuenta] of data.subcuentas.entries()) {
                        let montoSubcuenta = 0; // Iniciar el montoSubcuenta en 0 para calcular desde cero

                        montoSubcuenta += await calcularMontoCuenta(doc.id, subcuenta.pacientes, subcuenta.codigo);

                        for (const transaccion of transacciones) {
                            if (transaccion.cuentaOrigen === `${doc.id}-${index}`) {
                                montoSubcuenta -= transaccion.monto;
                            }
                            if (transaccion.cuentaDestino === `${doc.id}-${index}`) {
                                montoSubcuenta += transaccion.monto;
                            }
                        }

                        const cuentaQuerySnapshot = await getDocs(collection(db, 'CatalogoCuentas'));
                        const cuentaDoc = cuentaQuerySnapshot.docs.find(doc => doc.id === doc.id);
                        if (cuentaDoc) {
                            const cuentaData = cuentaDoc.data();
                            cuentaData.subcuentas[index].monto = montoSubcuenta;
                            await updateDoc(cuentaDoc.ref, { subcuentas: cuentaData.subcuentas });
                        }

                        const subRow = document.createElement('tr');
                        subRow.classList.add('subcuenta');
                        subRow.ondblclick = () => editarSubcuenta(doc.id, index);
                        subRow.innerHTML = `
                    <td style="padding-left: 20px;">${subcuenta.codigo}</td>
                    <td>${subcuenta.nombre}</td>
                    <td>${subcuenta.origen}</td>
                    <td>${montoSubcuenta.toFixed(2)}</td>
<td>
    <div style="display: flex; gap: 10px; align-items: center;">
        <!-- Contenedor para el botón de transacciones y el loader -->
        <div id="transaccionesContainer-${doc.id}-${subcuenta.codigo}" style="position: relative;">
            <!-- Botón de transacciones -->
            <button class="btn btn-sm btn-info" id="transaccionesButton-${doc.id}-${subcuenta.codigo}" onclick="mostrarTransaccionesSubcuenta('${doc.id}', '${subcuenta.codigo}', 'loaderContainerR-${doc.id}-${subcuenta.codigo}')">
                <i class="ti ti-list" style="font-size: 1.2rem;"></i> Transacciones
            </button>

            <!-- Loader que aparece durante la carga de las transacciones -->
            <div id="loaderContainerR-${doc.id}-${subcuenta.codigo}" class="loaderR" style="display: none;"></div>
        </div>

        <!-- Botón para eliminar la subcuenta, ahora ubicado a la derecha -->
        <button class="btn btn-sm btn-danger" onclick="eliminarSubcuenta('${doc.id}', ${index})">
            <i class="ti ti-trash" style="font-size: 1.2rem;"></i>
        </button>
    </div>
</td>


                `;
                        catalogoCuentas.appendChild(subRow);
                    }
                }
            } catch (error) {
                console.error('Error al cargar el catálogo de cuentas:', error);
            } finally {
                // Ocultar el loader y restaurar el fondo
                fondoDesenfocado.style.display = 'none';
                loaderContainer.style.display = 'none';
            }
        }



        async function calcularMontoCuenta(cuentaId, pacientes, subcuentaCodigo = null) {
            let montoTotal = 0;
            let montoSubcuentas = 0;

            if (pacientes && pacientes.length > 0) {
                const facturasRef = collection(db, 'facturas');
                const facturasQuery = query(facturasRef, where('paciente', 'in', pacientes));
                const facturasSnapshot = await getDocs(facturasQuery);

                for (const facturaDoc of facturasSnapshot.docs) {
                    const factura = facturaDoc.data();
                    if (factura.estatus === 'Cerrada') {
                        if (!factura.pagos) {
                            montoTotal += parseFloat(String(factura.total).replace(' DOP', ''));
                        } else {
                            const pagosRef = collection(db, `facturas/${facturaDoc.id}/pagos`);
                            const pagosSnapshot = await getDocs(pagosRef);
                            for (const pagoDoc of pagosSnapshot.docs) {
                                const pago = pagoDoc.data();
                                if (pago.estatus === 'Pagado') {
                                    montoTotal += parseFloat(String(pago.total).replace(' DOP', ''));
                                }
                            }
                        }
                    } else if (factura.estatus === 'Abierta') {
                        const pagosRef = collection(db, `facturas/${facturaDoc.id}/pagos`);
                        const pagosSnapshot = await getDocs(pagosRef);
                        for (const pagoDoc of pagosSnapshot.docs) {
                            const pago = pagoDoc.data();
                            if (pago.estatus === 'Pagado') {
                                montoTotal += parseFloat(String(pago.total).replace(' DOP', ''));
                            }
                        }
                    }
                }
            }

            // Sumar montos de subcuentas
            const cuentaRef = doc(db, 'CatalogoCuentas', cuentaId);
            const cuentaDoc = await getDoc(cuentaRef);

            if (cuentaDoc.exists() && !subcuentaCodigo) {
                const cuentaData = cuentaDoc.data();
                for (const subcuenta of cuentaData.subcuentas) {
                    montoSubcuentas += subcuenta.monto;
                }
                montoTotal += montoSubcuentas;
            }

            // Restar montos de registro de compras
            montoTotal -= await calcularMontoRegistroCompras(cuentaId, subcuentaCodigo);

            // Actualizar el monto en Firestore
            if (cuentaDoc.exists()) {
                const cuentaData = cuentaDoc.data();
                if (subcuentaCodigo) {
                    const subcuentaIndex = cuentaData.subcuentas.findIndex(sub => sub.codigo === subcuentaCodigo);
                    if (subcuentaIndex !== -1) {
                        cuentaData.subcuentas[subcuentaIndex].monto = montoTotal;
                    }
                } else {
                    cuentaData.monto = montoTotal;
                }
                await updateDoc(cuentaRef, cuentaData);
            }

            return montoTotal;
        }


        async function calcularMontoRegistroCompras(cuentaId, subcuentaCodigo = null) {
            let montoTotal = 0;

            const cuentaRef = doc(db, 'CatalogoCuentas', cuentaId);
            const cuentaDoc = await getDoc(cuentaRef);

            if (cuentaDoc.exists()) {
                const cuentaData = cuentaDoc.data();
                let compras = cuentaData.compras;

                if (subcuentaCodigo) {
                    const subcuenta = cuentaData.subcuentas.find(sub => sub.codigo === subcuentaCodigo);
                    compras = subcuenta ? subcuenta.compras : [];
                }

                if (compras && compras.length > 0) {
                    for (const compraId of compras) {
                        const compraRef = doc(db, 'RegistroDeCompras', compraId);
                        const compraDoc = await getDoc(compraRef);

                        if (compraDoc.exists()) {
                            const compra = compraDoc.data();

                            if (compra.estatus === 'Cerrada') {
                                if (!compra.pagos || compra.pagos.length === 0) {
                                    montoTotal += parseFloat(compra.montoFactura.replace(' DOP', ''));
                                } else {
                                    for (const pago of compra.pagos) {
                                        if (pago.estatus === 'Pagado') {
                                            montoTotal += parseFloat(String(pago.monto).replace(' DOP', ''));
                                        }

                                    }
                                }
                            } else if (compra.estatus === 'Abierta' && compra.pagos) {
                                for (const pago of compra.pagos) {
                                    if (pago.estatus === 'Pagado') {
                                        montoTotal += parseFloat(String(pago.monto).replace(' DOP', ''));
                                    }

                                }
                            }
                        }
                    }
                }
            }

            return montoTotal;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarCatalogoCuentas();
        });

        window.agregarSubcuenta = async function (cuentaId) {
            abrirFormulario('Agregar Subcuenta');
            currentEditingId = cuentaId;
            currentEditingSubIndex = null;
            isEditing = false;
            isAddingSubcuenta = true;
        }

        window.editarCuenta = async function (cuentaId) {
            const cuentaRef = doc(db, 'CatalogoCuentas', cuentaId);
            const cuentaDoc = await getDoc(cuentaRef);

            if (cuentaDoc.exists()) {
                const cuentaData = cuentaDoc.data();
                abrirFormulario('Editar Cuenta');
                document.getElementById('codigoCuenta').value = cuentaData.codigo;
                document.getElementById('nombreCuenta').value = cuentaData.nombre;
                document.getElementById('origenCuenta').value = cuentaData.origen;
                document.getElementById('montoCuenta').value = parseFloat(cuentaData.monto).toFixed(2);
                document.getElementById('montoCuenta').disabled = true;

                currentEditingId = cuentaId;
                currentEditingSubIndex = null;
                isEditing = true;
                isAddingSubcuenta = false;
            }
        }

        window.editarSubcuenta = async function (cuentaId, subIndex) {
            const cuentaRef = doc(db, 'CatalogoCuentas', cuentaId);
            const cuentaDoc = await getDoc(cuentaRef);

            if (cuentaDoc.exists()) {
                const cuentaData = cuentaDoc.data();
                const subcuentaData = cuentaData.subcuentas[subIndex];
                abrirFormulario('Editar Subcuenta');
                document.getElementById('codigoCuenta').value = subcuentaData.codigo;
                document.getElementById('nombreCuenta').value = subcuentaData.nombre;
                document.getElementById('origenCuenta').value = subcuentaData.origen;
                document.getElementById('montoCuenta').value = subcuentaData.monto;
                document.getElementById('montoCuenta').disabled = true;

                currentEditingId = cuentaId;
                currentEditingSubIndex = subIndex;
                isEditing = true;
                isAddingSubcuenta = false;
            }
        }

        function showAlert(message, alertType, isConfirmation = false, onConfirm = null) {
            const alertDiv = document.createElement('div');
            alertDiv.classList.add('alert', 'alert-dismissible', alertType, 'position-fixed', 'top-50', 'start-50', 'translate-middle');

            if (isConfirmation) {
                alertDiv.innerHTML = `
                    <h4 class="alert-heading">¡Advertencia!</h4>
                    <p class="mb-0">${message}</p>
                    <div class="mt-2 d-flex justify-content-end">
                        <button type="button" class="btn btn-dark-alert me-2" id="confirmYes">Sí</button>
                        <button type="button" class="btn btn-dark-alert" id="confirmNo">No</button>
                    </div>
                `;
                document.body.appendChild(alertDiv);

                const confirmYes = document.getElementById('confirmYes');
                const confirmNo = document.getElementById('confirmNo');

                confirmYes.addEventListener('click', () => {
                    if (onConfirm) onConfirm();
                    alertDiv.remove();
                });

                confirmNo.addEventListener('click', () => {
                    alertDiv.remove();
                });
            } else {
                alertDiv.innerHTML = `
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    <h4 class="alert-heading">¡Advertencia!</h4>
                    <p class="mb-0">${message}</p>
                `;

                document.body.appendChild(alertDiv);

                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }

        window.eliminarCuenta = async function (cuentaId) {
            showAlert('¿Estás seguro de que deseas eliminar esta cuenta?', 'alert-warning', true, async () => {
                try {
                    await deleteDoc(doc(db, 'CatalogoCuentas', cuentaId));
                    showAlert('Cuenta eliminada correctamente', 'alert-success');
                    cargarCatalogoCuentas();
                } catch (error) {
                    console.error('Error al eliminar la cuenta:', error);
                }
            });
        }

        window.eliminarSubcuenta = async function (cuentaId, subIndex) {
            showAlert('¿Estás seguro de que deseas eliminar esta subcuenta?', 'alert-warning', true, async () => {
                try {
                    const cuentaRef = doc(db, 'CatalogoCuentas', cuentaId);
                    const cuentaDoc = await getDoc(cuentaRef);

                    if (cuentaDoc.exists()) {
                        const cuentaData = cuentaDoc.data();
                        cuentaData.subcuentas.splice(subIndex, 1);

                        await updateDoc(cuentaRef, {
                            subcuentas: cuentaData.subcuentas
                        });

                        showAlert('Subcuenta eliminada correctamente', 'alert-success');
                        cargarCatalogoCuentas();
                    }
                } catch (error) {
                    console.error('Error al eliminar la subcuenta:', error);
                }
            });
        }


        function abrirFormulario(titulo) {
            document.getElementById('formularioTitulo').textContent = titulo;
            document.getElementById('nuevoFormulario').style.display = 'block';
            document.getElementById('fondoDesenfocado2').style.display = 'block';
        }

        function cerrarFormulario() {
            document.getElementById('nuevoFormulario').style.display = 'none';
            document.getElementById('fondoDesenfocado2').style.display = 'none';
            document.getElementById('MainForm').reset();
            isEditing = false;
            currentEditingId = null;
            currentEditingSubIndex = null;
            isAddingSubcuenta = false;
        }

        async function obtenerCuentaContable(compraId) {
            const catalogoCuentasSnapshot = await getDocs(collection(db, "CatalogoCuentas"));

            let nombreCuenta = 'Cuenta desconocida'; // Valor por defecto en caso de que no se encuentre

            catalogoCuentasSnapshot.forEach((doc) => {
                const cuenta = doc.data();
                const compras = cuenta.compras || [];

                // Verificar si la compraId está dentro del array 'compras' de la cuenta
                if (compras.includes(compraId)) {
                    nombreCuenta = cuenta.nombre; // Asignar el nombre de la cuenta contable
                }
            });

            return nombreCuenta;
        }

        async function obtenerCuentaPorPaciente(pacienteNombre) {
            const catalogoCuentasSnapshot = await getDocs(collection(db, "CatalogoCuentas"));

            let nombreCuenta = 'Cuenta desconocida'; // Valor por defecto en caso de que no se encuentre el paciente

            catalogoCuentasSnapshot.forEach((doc) => {
                const cuenta = doc.data();
                const pacientes = cuenta.pacientes || [];

                // Verificar si el nombre del paciente está en el array 'pacientes' de la cuenta
                if (pacientes.includes(pacienteNombre)) {
                    nombreCuenta = cuenta.nombre; // Asignar el nombre de la cuenta contable asociada al paciente
                }
            });

            return nombreCuenta;
        }

        let transacciones = [];

        window.mostrarTransacciones = async function (cuentaId, loaderId) {
            document.getElementById(`transaccionesButton-${cuentaId}`).style.display = 'none';
            document.getElementById(loaderId).style.display = 'block';


            transacciones = [];

            try {
                const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
                if (!cuentaDoc.exists()) {
                    throw new Error("Cuenta no encontrada");
                }

                const cuentaData = cuentaDoc.data();
                const pacientes = cuentaData.pacientes || [];

                const generateExcelButton = document.getElementById('generateExcel');
                generateExcelButton.setAttribute('data-cuenta-id', cuentaId); // Atributo de datos

                async function obtenerNombreCuenta(cuentaId) {
                    if (cuentaId.includes('-')) {
                        const [cuentaPrincipalId, subcuentaIndex] = cuentaId.split('-');
                        const cuentaPrincipalDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaPrincipalId));
                        if (cuentaPrincipalDoc.exists()) {
                            const subcuentas = cuentaPrincipalDoc.data().subcuentas || [];
                            return subcuentas[subcuentaIndex]?.nombre || 'Subcuenta desconocida';
                        }
                    } else {
                        const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
                        return cuentaDoc.exists() ? cuentaDoc.data().nombre : 'Cuenta desconocida';
                    }
                }



                if (pacientes.length > 0) {
                    // Obtener facturas relacionadas con los pacientes de esta cuenta contable
                    const facturasSnapshot = await getDocs(query(collection(db, "facturas"), where("paciente", "in", pacientes)));
                    for (const doc of facturasSnapshot.docs) {
                        const factura = doc.data();
                        if (factura.estatus === 'Cerrada') {
                            const pagosSnapshot = await getDocs(collection(db, `facturas/${doc.id}/pagos`));
                            if (pagosSnapshot.empty) {
                                transacciones.push({
                                    desde: factura.paciente,
                                    hacia: cuentaData.nombre,
                                    concepto: `Pago total a la Factura No. ${factura.numeroFactura}`,
                                    monto: factura.total,
                                    documento: factura.numeroFactura,
                                    tipo: 'Ingreso',
                                    fecha: factura.fecha
                                });
                            }
                        }
                    }

                    // Obtener recibos relacionados con los pacientes de esta cuenta contable
                    const recibosSnapshot = await getDocs(query(collection(db, "recibos"), where("paciente", "in", pacientes)));
                    for (const doc of recibosSnapshot.docs) {
                        const recibo = doc.data();
                        if (!recibo.items || recibo.items.length === 0) {
                            transacciones.push({
                                desde: recibo.paciente,
                                hacia: cuentaData.nombre,
                                concepto: `Pago parcial a la Factura No. ${recibo.numeroFactura}`,
                                monto: recibo.totalPago,
                                documento: recibo.numeroFactura,
                                tipo: 'Ingreso',
                                fecha: recibo.fecha
                            });
                        }
                    }
                }

                // Obtener compras relacionadas con esta cuenta contable
                const comprasSnapshot = await getDocs(query(collection(db, "RegistroDeCompras"), where("cuenta", "==", cuentaId)));
                for (const doc of comprasSnapshot.docs) {
                    const compra = doc.data();
                    const pagos = compra.pagos || [];

                    if (pagos.length === 0) {
                        transacciones.push({
                            desde: cuentaData.nombre,
                            hacia: compra.suplidorNombre,
                            concepto: compra.tipoGasto,
                            monto: compra.montoApagar,
                            documento: compra.nombreFactura,
                            tipo: 'Gasto',
                            fecha: compra.fecha
                        });
                    } else if (compra.estatus === 'Abierta' && pagos.length > 0) {
                        pagos.forEach(pago => {
                            if (pago.estatus === 'Pagado') {
                                transacciones.push({
                                    desde: cuentaData.nombre,
                                    hacia: compra.suplidorNombre,
                                    concepto: `${compra.tipoGasto} - Pago No. ${pago.numeroPago}`,
                                    monto: pago.monto,
                                    documento: compra.nombreFactura,
                                    tipo: 'Gasto',
                                    fecha: pago.fechapago
                                });
                            }
                        });
                    }
                }

                const transaccionesSnapshot = await getDocs(query(collection(db, "transacciones"),
                    where("cuentaOrigen", "==", cuentaId)));
                for (const doc of transaccionesSnapshot.docs) {
                    const transaccion = doc.data();
                    const nombreCuentaDestino = await obtenerNombreCuenta(transaccion.cuentaDestino);
                    transacciones.push({
                        desde: cuentaData.nombre,
                        hacia: nombreCuentaDestino,
                        concepto: `Transferencia a ${nombreCuentaDestino}`,
                        monto: transaccion.monto,
                        documento: 'N/A',
                        tipo: 'Gasto',
                        fecha: transaccion.fecha
                    });
                }

                // Obtener transacciones de transferencia donde la cuenta es destino
                const transaccionesDestinoSnapshot = await getDocs(query(collection(db, "transacciones"),
                    where("cuentaDestino", "==", cuentaId)));
                for (const doc of transaccionesDestinoSnapshot.docs) {
                    const transaccion = doc.data();
                    const nombreCuentaOrigen = await obtenerNombreCuenta(transaccion.cuentaOrigen);
                    transacciones.push({
                        desde: nombreCuentaOrigen,
                        hacia: cuentaData.nombre,
                        concepto: `Transferencia desde ${nombreCuentaOrigen}`,
                        monto: transaccion.monto,
                        documento: 'N/A',
                        tipo: 'Ingreso',
                        fecha: transaccion.fecha
                    });
                }

                filtrarTransaccionesPorMes();

            } catch (error) {
                console.error("Error al cargar transacciones:", error);
            } finally {
                // Ocultar el loader y mostrar el botón de "Transacciones" nuevamente
                document.getElementById(loaderId).style.display = 'none';
                document.getElementById(`transaccionesButton-${cuentaId}`).style.display = 'inline-block';
            }

            // Mostrar el historial de transacciones
            document.getElementById('HistorialTransacciones').style.display = 'block';
            document.getElementById('fondoDesenfocado3').style.display = 'block';
        };

        window.mostrarTransaccionesSubcuenta = async function (cuentaId, subcuentaCodigo, loaderId) {
            document.getElementById(`transaccionesButton-${cuentaId}-${subcuentaCodigo}`).style.display = 'none';
            document.getElementById(loaderId).style.display = 'block';
            const tableBody = document.getElementById('historialTable');


            tableBody.innerHTML = '';

            transacciones = [];

            try {
                const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
                if (!cuentaDoc.exists()) {
                    throw new Error("Cuenta no encontrada");
                }

                const cuentaData = cuentaDoc.data();
                const subcuentaIndex = cuentaData.subcuentas.findIndex(s => s.codigo === subcuentaCodigo);
                if (subcuentaIndex === -1) {
                    throw new Error("Subcuenta no encontrada");
                }
                const subcuenta = cuentaData.subcuentas[subcuentaIndex];

                const pacientes = subcuenta.pacientes || [];

                const generateExcelButton = document.getElementById('generateExcel');
                generateExcelButton.setAttribute('data-cuenta-id', cuentaId);
                generateExcelButton.setAttribute('data-subcuenta-codigo', subcuentaCodigo);


                async function obtenerNombreCuenta(cuentaId) {
                    if (cuentaId.includes('-')) {
                        const [cuentaPrincipalId, subcuentaIndex] = cuentaId.split('-');
                        const cuentaPrincipalDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaPrincipalId));
                        if (cuentaPrincipalDoc.exists()) {
                            const subcuentas = cuentaPrincipalDoc.data().subcuentas || [];
                            return subcuentas[parseInt(subcuentaIndex)]?.nombre || 'Subcuenta desconocida';
                        }
                    } else {
                        const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
                        return cuentaDoc.exists() ? cuentaDoc.data().nombre : 'Cuenta desconocida';
                    }
                }

                if (pacientes.length > 0) {
                    // Obtener facturas relacionadas con los pacientes de esta subcuenta
                    const facturasSnapshot = await getDocs(query(collection(db, "facturas"), where("paciente", "in", pacientes)));
                    for (const doc of facturasSnapshot.docs) {
                        const factura = doc.data();
                        if (factura.estatus === 'Cerrada') {
                            const pagosSnapshot = await getDocs(collection(db, `facturas/${doc.id}/pagos`));
                            if (pagosSnapshot.empty) {
                                transacciones.push({
                                    desde: factura.paciente,
                                    hacia: subcuenta.nombre,
                                    concepto: `Pago total a la Factura No. ${factura.numeroFactura}`,
                                    monto: factura.total,
                                    documento: factura.numeroFactura,
                                    tipo: 'Ingreso',
                                    fecha: factura.fecha
                                });
                            }
                        }
                    }

                    // Obtener recibos relacionados con los pacientes de esta subcuenta
                    const recibosSnapshot = await getDocs(query(collection(db, "recibos"), where("paciente", "in", pacientes)));
                    for (const doc of recibosSnapshot.docs) {
                        const recibo = doc.data();
                        if (!recibo.items || recibo.items.length === 0) {
                            transacciones.push({
                                desde: recibo.paciente,
                                hacia: subcuenta.nombre,
                                concepto: `Pago parcial a la Factura No. ${recibo.numeroFactura}`,
                                monto: recibo.totalPago,
                                documento: recibo.numeroFactura,
                                tipo: 'Ingreso',
                                fecha: recibo.fecha
                            });
                        }
                    }
                }

                // Obtener compras relacionadas con esta subcuenta
                const comprasSnapshot = await getDocs(query(collection(db, "RegistroDeCompras"), where("cuenta", "==", cuentaId)));
                for (const doc of comprasSnapshot.docs) {
                    const compra = doc.data();
                    const pagos = compra.pagos || [];

                    // Verificar si la compra pertenece a la subcuenta
                    if (compra.subcuenta && compra.subcuenta.codigo === subcuentaCodigo) {
                        if (pagos.length === 0) {
                            transacciones.push({
                                desde: subcuenta.nombre,
                                hacia: compra.suplidorNombre,
                                concepto: compra.tipoGasto,
                                monto: compra.montoApagar,
                                documento: compra.nombreFactura,
                                tipo: 'Gasto',
                                fecha: compra.fecha
                            });
                        } else if (compra.estatus === 'Abierta' && pagos.length > 0) {
                            pagos.forEach(pago => {
                                if (pago.estatus === 'Pagado') {
                                    transacciones.push({
                                        desde: subcuenta.nombre,
                                        hacia: compra.suplidorNombre,
                                        concepto: `${compra.tipoGasto} - Pago No. ${pago.numeroPago}`,
                                        monto: pago.monto,
                                        documento: compra.nombreFactura,
                                        tipo: 'Gasto',
                                        fecha: pago.fechapago
                                    });
                                }
                            });
                        }
                    }
                }

                const transaccionesSnapshot = await getDocs(query(collection(db, "transacciones"),
                    where("cuentaOrigen", "==", `${cuentaId}-${subcuentaIndex}`)));
                for (const doc of transaccionesSnapshot.docs) {
                    const transaccion = doc.data();
                    const nombreCuentaDestino = await obtenerNombreCuenta(transaccion.cuentaDestino);
                    transacciones.push({
                        desde: subcuenta.nombre,
                        hacia: nombreCuentaDestino,
                        concepto: `Transferencia a ${nombreCuentaDestino}`,
                        monto: transaccion.monto,
                        documento: '',
                        tipo: 'Gasto',
                        fecha: transaccion.fecha
                    });
                }

                // Obtener transacciones de transferencia donde la subcuenta es destino
                const transaccionesDestinoSnapshot = await getDocs(query(collection(db, "transacciones"),
                    where("cuentaDestino", "==", `${cuentaId}-${subcuentaIndex}`)));
                for (const doc of transaccionesDestinoSnapshot.docs) {
                    const transaccion = doc.data();
                    const nombreCuentaOrigen = await obtenerNombreCuenta(transaccion.cuentaOrigen);
                    transacciones.push({
                        desde: nombreCuentaOrigen,
                        hacia: subcuenta.nombre,
                        concepto: `Transferencia desde ${nombreCuentaOrigen}`,
                        monto: transaccion.monto,
                        documento: 'N/A',
                        tipo: 'Ingreso',
                        fecha: transaccion.fecha
                    });
                }

                filtrarTransaccionesPorMes();

            } catch (error) {
                console.error("Error al cargar transacciones:", error);
            } finally {
                // Ocultar el loader y mostrar el botón de "Transacciones" nuevamente
                document.getElementById(loaderId).style.display = 'none';
                document.getElementById(`transaccionesButton-${cuentaId}-${subcuentaCodigo}`).style.display = 'inline-block';
            }

            // Mostrar el historial de transacciones
            document.getElementById('HistorialTransacciones').style.display = 'block';
            document.getElementById('fondoDesenfocado3').style.display = 'block';
        };




        const pageSize = 10; // Número de transacciones por página
        let currentPage = 1; // Página actual

        async function mostrarHistorial(transacciones) {
            const transaccionesTableBody = document.getElementById('historialTable');
            const paginationContainer = document.getElementById('paginationTransacciones');

            // Limpiar la tabla y la paginación antes de actualizar
            transaccionesTableBody.innerHTML = '';
            paginationContainer.innerHTML = '';

            // Calcular el número total de páginas
            const totalPages = Math.ceil(transacciones.length / pageSize);

            // Calcular el índice de inicio y fin para la página actual
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, transacciones.length);

            // Mostrar solo las transacciones de la página actual
            const transaccionesPagina = transacciones.slice(startIndex, endIndex);

            transaccionesPagina.forEach((transaccion) => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${transaccion.desde}</td>
            <td>${transaccion.hacia}</td>
            <td>${transaccion.concepto}</td>
            <td>${parseFloat(transaccion.monto).toFixed(2)} DOP</td>
            <td>${transaccion.documento}</td>
            <td>${transaccion.tipo}</td>
            <td>${transaccion.fecha}</td>
        `;
                transaccionesTableBody.appendChild(row);
            });

            // Crear botones de paginación
            actualizarPaginacionTransacciones(totalPages);
        }

        function actualizarPaginacionTransacciones(totalPages) {
            const paginationContainer = document.getElementById('paginationTransacciones');
            paginationContainer.innerHTML = '';

            // Botón anterior
            const prevButton = document.createElement('li');
            prevButton.classList.add('page-item');
            if (currentPage === 1) {
                prevButton.classList.add('disabled'); // Deshabilitar si es la primera página
            }
            const prevLink = document.createElement('a');
            prevLink.classList.add('page-link');
            prevLink.href = '#';
            prevLink.textContent = '«';
            prevLink.addEventListener('click', (event) => {
                event.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    mostrarHistorial(transacciones); // Actualiza la tabla con la página anterior
                }
            });
            prevButton.appendChild(prevLink);
            paginationContainer.appendChild(prevButton);

            // Botones de páginas numeradas
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('li');
                pageButton.classList.add('page-item');
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                const pageLink = document.createElement('a');
                pageLink.classList.add('page-link');
                pageLink.href = '#';
                pageLink.textContent = i;
                pageLink.addEventListener('click', (event) => {
                    event.preventDefault();
                    currentPage = i; // Cambiar la página actual
                    mostrarHistorial(transacciones); // Actualizar la tabla con la página seleccionada
                });
                pageButton.appendChild(pageLink);
                paginationContainer.appendChild(pageButton);
            }

            // Botón siguiente
            const nextButton = document.createElement('li');
            nextButton.classList.add('page-item');
            if (currentPage === totalPages) {
                nextButton.classList.add('disabled'); // Deshabilitar si es la última página
            }
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.href = '#';
            nextLink.textContent = '»';
            nextLink.addEventListener('click', (event) => {
                event.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    mostrarHistorial(transacciones); // Actualizar la tabla con la página siguiente
                }
            });
            nextButton.appendChild(nextLink);
            paginationContainer.appendChild(nextButton);
        }
        // Función para cerrar el historial
        document.getElementById('closeHistorialButton').addEventListener('click', function () {
            document.getElementById('HistorialTransacciones').style.display = 'none';
            document.getElementById('fondoDesenfocado3').style.display = 'none';
            document.getElementById('historialTable').innerHTML = '';
            currentPage = 1;
            transacciones = [];
            const fechaActual = new Date();
            const mesActual = fechaActual.toISOString().slice(0, 7); // Formato YYYY-MM
            document.getElementById('filterMonth').value = mesActual;
            document.getElementById('endMonth').value = mesActual;
            document.getElementById('startMonth').value = mesActual;

            const generateExcelButton = document.getElementById('generateExcel');
            generateExcelButton.removeAttribute('data-cuenta-id');
            generateExcelButton.removeAttribute('data-subcuenta-codigo');
        });

        document.getElementById('transferenciaForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const cuentaOrigenId = document.getElementById('cuentaOrigen').value;
            const cuentaDestinoId = document.getElementById('cuentaDestino').value;
            const monto = parseFloat(document.getElementById('montoTransferencia').value);

            // Validaciones iniciales
            if (!cuentaOrigenId || !cuentaDestinoId || isNaN(monto) || monto <= 0) {
                showAlert2('Por favor, complete todos los campos.', 'alert-warning');
                return;
            }

            if (cuentaOrigenId === cuentaDestinoId) {
                showAlert2('La cuenta de origen no puede ser igual a la cuenta de destino.', 'alert-warning');
                return;
            }

            try {
                // Iniciar la transacción
                await runTransaction(db, async (transaction) => {
                    
                    const origenEsSubcuenta = cuentaOrigenId.includes('-');
                    const destinoEsSubcuenta = cuentaDestinoId.includes('-');

                    let cuentaOrigenData, cuentaDestinoData, subcuentaOrigen, subcuentaDestino;

                    // Manejo de la cuenta origen
                    const [cuentaOrigenRealId, subcuentaOrigenIndex] = origenEsSubcuenta ? cuentaOrigenId.split('-') : [cuentaOrigenId, null];
                    const cuentaOrigenRef = doc(db, 'CatalogoCuentas', cuentaOrigenRealId);
                    const cuentaOrigenDoc = await transaction.get(cuentaOrigenRef);

                    if (!cuentaOrigenDoc.exists()) {
                        throw new Error('No se encontró la cuenta origen.');
                    }

                    cuentaOrigenData = cuentaOrigenDoc.data();
                    console.log('Datos de la cuenta de origen:', cuentaOrigenData);

                    // Verificar el monto en la subcuenta o cuenta madre
                    if (origenEsSubcuenta) {
                        subcuentaOrigen = cuentaOrigenData.subcuentas[parseInt(subcuentaOrigenIndex)];

                        // Verificar si la subcuenta existe y tiene fondos suficientes
                        if (!subcuentaOrigen) {
                            throw new Error('La subcuenta de origen no existe.');
                        }

                        if (subcuentaOrigen.monto < monto) {
                            throw new Error('La subcuenta de origen no tiene suficientes fondos.');
                        }

                        // Restar el monto de la subcuenta
                        subcuentaOrigen.monto -= monto;
                    } else {
                        // Verificar si la cuenta madre tiene fondos suficientes
                        if (cuentaOrigenData.monto < monto) {
                            throw new Error('La cuenta de origen no tiene suficientes fondos.');
                        }

                        // Restar el monto de la cuenta madre
                        cuentaOrigenData.monto -= monto;
                    }


                    // Manejo de la cuenta destino
                    const [cuentaDestinoRealId, subcuentaDestinoIndex] = destinoEsSubcuenta ? cuentaDestinoId.split('-') : [cuentaDestinoId, null];
                    const cuentaDestinoRef = doc(db, 'CatalogoCuentas', cuentaDestinoRealId);
                    const cuentaDestinoDoc = await transaction.get(cuentaDestinoRef);

                    if (!cuentaDestinoDoc.exists()) {
                        throw new Error('No se encontró la cuenta destino.');
                    }

                    cuentaDestinoData = cuentaDestinoDoc.data();
                    console.log('Datos de la cuenta de destino:', cuentaDestinoData);

                    // Sumar el monto a la subcuenta o cuenta madre
                    if (destinoEsSubcuenta) {
                        subcuentaDestino = cuentaDestinoData.subcuentas[subcuentaDestinoIndex];
                        if (!subcuentaDestino) {
                            throw new Error('La subcuenta de destino no existe.');
                        }
                        subcuentaDestino.monto += monto; // Sumar el monto a la subcuenta
                    } else {
                        cuentaDestinoData.monto += monto; // Sumar el monto a la cuenta madre
                    }

                    // Actualizar las cuentas en Firestore
                    if (origenEsSubcuenta) {
                        transaction.update(cuentaOrigenRef, {
                            subcuentas: cuentaOrigenData.subcuentas
                        });
                    } else {
                        transaction.update(cuentaOrigenRef, {
                            monto: cuentaOrigenData.monto
                        });
                    }

                    if (destinoEsSubcuenta) {
                        transaction.update(cuentaDestinoRef, {
                            subcuentas: cuentaDestinoData.subcuentas
                        });
                    } else {
                        transaction.update(cuentaDestinoRef, {
                            monto: cuentaDestinoData.monto
                        });
                    }

                    const fechaActual = obtenerFechaActual();

                    // Create a new transaction document
                    const transaccionData = {
                        cuentaOrigen: cuentaOrigenId,
                        cuentaDestino: cuentaDestinoId,
                        monto: monto,
                        fecha: fechaActual
                    };

                    const transaccionRef = collection(db, 'transacciones');
                    await addDoc(transaccionRef, transaccionData);

                    showAlert2('Transferencia realizada con éxito.', 'alert-success');
                    document.getElementById('transferenciaForm').reset();
                });
            } catch (error) {
                console.error(error);
                showAlert2('Error al realizar la transferencia: ' + error.message, 'alert-danger');
            }
        });


        // Función para cargar las cuentas y subcuentas en los dropdowns
        async function cargarCuentasEnDropdowns() {
            const cuentasSnapshot = await getDocs(collection(db, 'CatalogoCuentas'));
            const cuentaOrigenDropdown = document.getElementById('cuentaOrigen');
            const cuentaDestinoDropdown = document.getElementById('cuentaDestino');

            cuentasSnapshot.forEach((doc) => {
                const cuentaData = doc.data();
                // Agregar cuentas principales
                const optionOrigen = document.createElement('option');
                const optionDestino = document.createElement('option');

                optionOrigen.value = doc.id;
                optionOrigen.textContent = `${cuentaData.codigo} - ${cuentaData.nombre}`;
                optionDestino.value = doc.id;
                optionDestino.textContent = `${cuentaData.codigo} - ${cuentaData.nombre}`;

                cuentaOrigenDropdown.appendChild(optionOrigen);
                cuentaDestinoDropdown.appendChild(optionDestino);

                // Agregar subcuentas si existen
                if (cuentaData.subcuentas && cuentaData.subcuentas.length > 0) {
                    cuentaData.subcuentas.forEach((subcuenta, index) => {
                        const optionSubOrigen = document.createElement('option');
                        const optionSubDestino = document.createElement('option');

                        optionSubOrigen.value = `${doc.id}-${index}`;
                        optionSubOrigen.textContent = `${subcuenta.codigo} - ${subcuenta.nombre} (Subcuenta)`;
                        optionSubDestino.value = `${doc.id}-${index}`;
                        optionSubDestino.textContent = `${subcuenta.codigo} - ${subcuenta.nombre} (Subcuenta)`;

                        cuentaOrigenDropdown.appendChild(optionSubOrigen);
                        cuentaDestinoDropdown.appendChild(optionSubDestino);
                    });
                }
            });
        }

        // Llamar a la función para cargar las cuentas y subcuentas
        cargarCuentasEnDropdowns();



        document.getElementById('transferir').addEventListener('click', () => {
            document.getElementById('transferenciaContainer').style.display = 'block';
            document.getElementById('fondoDesenfocado2').style.display = 'block';
        });

        document.getElementById('closeTransferenciaButton').addEventListener('click', () => {
            document.getElementById('transferenciaContainer').style.display = 'none';
            document.getElementById('fondoDesenfocado2').style.display = 'none';
            document.getElementById('transferenciaForm').reset();
        });



        function showAlert2(message, alertType) {
            const alertBox = document.createElement('div');
            alertBox.className = `alert ${alertType} position-fixed top-50 start-50 translate-middle`;
            alertBox.style.zIndex = '1050'; // Asegurar que el z-index sea alto para estar encima de otros elementos

            let heading;
            if (alertType === 'alert-success') {
                heading = '¡Bien hecho!';
            } else if (alertType === 'alert-danger') {
                heading = '¡Advertencia!';
            } else {
                heading = '¡Atención!';
            }

            alertBox.innerHTML = `
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <strong>${heading}</strong> ${message}
    `;

            document.body.appendChild(alertBox);
            setTimeout(() => {
                alertBox.remove();
            }, 3000);
        }

        function obtenerFechaActual() {
            const fecha = new Date();
            const dia = String(fecha.getDate()).padStart(2, '0'); // Obtener el día, y asegurarse de que tenga 2 dígitos
            const mes = String(fecha.getMonth() + 1).padStart(2, '0'); // Obtener el mes (los meses van de 0 a 11 en JavaScript)
            const año = fecha.getFullYear(); // Obtener el año

            return `${dia}/${mes}/${año}`;
        }

        function obtenerMesActual() {
            const fecha = new Date();
            const year = fecha.getFullYear();
            const month = String(fecha.getMonth() + 1).padStart(2, '0'); // Mes actual
            return `${year}-${month}`;
        }


        document.getElementById('applyFilter').addEventListener('click', filtrarTransaccionesPorMes);

        // Al cargar la página, se aplicará automáticamente el filtro por el mes actual
        document.addEventListener('DOMContentLoaded', () => {
            const fechaActual = new Date();
            const mesActual = fechaActual.toISOString().slice(0, 7); // Formato YYYY-MM
            document.getElementById('filterMonth').value = mesActual;
            document.getElementById('endMonth').value = mesActual;
            document.getElementById('startMonth').value = mesActual;
            filtrarTransaccionesPorMes();
        });

        function filtrarTransaccionesPorMes() {
            const filterMonth = document.getElementById('filterMonth').value; // Obtener mes en formato YYYY-MM
            const [year, month] = filterMonth.split('-'); // Extraer año y mes
            const transaccionesFiltradas = transacciones.filter(transaccion => {
                const [dia, mes, año] = transaccion.fecha.split('/'); // Convertir la fecha a dd/mm/yyyy
                return año === year && mes === month;
            });

            // Ordenar transacciones de forma descendente por fecha
            transaccionesFiltradas.sort((a, b) => {
                const [diaA, mesA, añoA] = a.fecha.split('/');
                const [diaB, mesB, añoB] = b.fecha.split('/');
                const fechaA = new Date(`${añoA}-${mesA}-${diaA}`);
                const fechaB = new Date(`${añoB}-${mesB}-${diaB}`);
                return fechaB - fechaA;
            });

            mostrarHistorial(transaccionesFiltradas); // Mostrar las transacciones filtradas
        }

        // Función para convertir un mes (YYYY-MM) a un objeto Date
        // Función para convertir una fecha en formato dd/mm/yyyy a un objeto Date
        function convertirFecha(fechaStr) {
            const [dia, mes, año] = fechaStr.split('/').map(Number);
            return new Date(año, mes - 1, dia); // Crear un objeto Date
        }

        // Función para convertir un mes (YYYY-MM) a un objeto Date
        function convertirMesAFecha(mesStr) {
            const [year, month] = mesStr.split('-').map(Number);
            return new Date(year, month - 1, 1); // Primer día del mes
        }

        document.getElementById('generateExcel').addEventListener('click', async () => {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;

            if (!startMonth || !endMonth) {
                showAlert2('Por favor, selecciona un rango de meses.', 'alert-danger');
                return;
            }

            // Obtener cuentaId y subcuentaCodigo desde los atributos del botón
            const cuentaId = document.getElementById('generateExcel').getAttribute('data-cuenta-id');
            const subcuentaCodigo = document.getElementById('generateExcel').getAttribute('data-subcuenta-codigo');

            // Convertir los meses seleccionados a fechas
            const fechaInicio = convertirMesAFecha(startMonth);
            const fechaFin = new Date(convertirMesAFecha(endMonth).setMonth(convertirMesAFecha(endMonth).getMonth() + 1));

            try {
                // Obtener el nombre de la cuenta o subcuenta
                const cuentaNombre = await obtenerNombreCuenta(cuentaId, subcuentaCodigo);

                // Seleccionar la función de transacciones según sea una cuenta o subcuenta
                const transacciones = subcuentaCodigo
                    ? await obtenerTransaccionesFiltradasSUBCUENTA(cuentaId, subcuentaCodigo, fechaInicio, fechaFin)
                    : await obtenerTransaccionesFiltradas(cuentaId, fechaInicio, fechaFin);

                if (transacciones.length === 0) {
                    showAlert2('No se encontraron transacciones en el rango de meses seleccionado.', 'alert-danger');
                    return;
                }

                // Generar y descargar el reporte Excel
                generarExcel(transacciones, cuentaNombre);
            } catch (error) {
                console.error('Error al generar el reporte:', error);
                alert(`Error al generar el reporte: ${error.message}`);
            }
        });

        async function obtenerTransaccionesFiltradas(cuentaId, fechaInicio, fechaFin) {
            const transacciones = [];

            const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
            if (!cuentaDoc.exists()) {
                throw new Error("Cuenta no encontrada");
            }

            const cuentaData = cuentaDoc.data();
            const pacientes = cuentaData.pacientes || [];

            async function obtenerNombreCuenta(cuentaId) {
                if (cuentaId.includes('-')) {
                    const [cuentaPrincipalId, subcuentaIndex] = cuentaId.split('-');
                    const cuentaPrincipalDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaPrincipalId));
                    if (cuentaPrincipalDoc.exists()) {
                        const subcuentas = cuentaPrincipalDoc.data().subcuentas || [];
                        return subcuentas[subcuentaIndex]?.nombre || 'Subcuenta desconocida';
                    }
                } else {
                    const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
                    return cuentaDoc.exists() ? cuentaDoc.data().nombre : 'Cuenta desconocida';
                }
            }

            // Facturas relacionadas con los pacientes
            if (pacientes.length > 0) {
                const facturasSnapshot = await getDocs(
                    query(collection(db, "facturas"), where("paciente", "in", pacientes))
                );
                for (const doc of facturasSnapshot.docs) {
                    const factura = doc.data();
                    const fechaFactura = convertirFecha(factura.fecha);
                    if (factura.estatus === 'Cerrada' && fechaFactura >= fechaInicio && fechaFactura < fechaFin) {
                        const pagosSnapshot = await getDocs(collection(db, `facturas/${doc.id}/pagos`));
                        if (pagosSnapshot.empty) {
                            transacciones.push({
                                desde: factura.paciente,
                                hacia: cuentaData.nombre,
                                concepto: `Pago total a la Factura No. ${factura.numeroFactura}`,
                                monto: factura.total,
                                documento: factura.numeroFactura,
                                tipo: 'Ingreso',
                                fecha: factura.fecha
                            });
                        }
                    }
                }
            }

            // Recibos relacionados con los pacientes
            const recibosSnapshot = await getDocs(
                query(collection(db, "recibos"), where("paciente", "in", pacientes))
            );
            for (const doc of recibosSnapshot.docs) {
                const recibo = doc.data();
                const fechaRecibo = convertirFecha(recibo.fecha);
                if ((!recibo.items || recibo.items.length === 0) && fechaRecibo >= fechaInicio && fechaRecibo < fechaFin) {
                    transacciones.push({
                        desde: recibo.paciente,
                        hacia: cuentaData.nombre,
                        concepto: `Pago parcial a la Factura No. ${recibo.numeroFactura}`,
                        monto: recibo.totalPago,
                        documento: recibo.numeroFactura,
                        tipo: 'Ingreso',
                        fecha: recibo.fecha
                    });
                }
            }

            // Compras relacionadas con la cuenta
            const comprasSnapshot = await getDocs(
                query(collection(db, "RegistroDeCompras"), where("cuenta", "==", cuentaId))
            );
            for (const doc of comprasSnapshot.docs) {
                const compra = doc.data();
                const fechaCompra = convertirFecha(compra.fecha);
                if (fechaCompra >= fechaInicio && fechaCompra < fechaFin) {
                    const pagos = compra.pagos || [];
                    if (pagos.length === 0) {
                        transacciones.push({
                            desde: cuentaData.nombre,
                            hacia: compra.suplidorNombre,
                            concepto: compra.tipoGasto,
                            monto: compra.montoApagar,
                            documento: compra.nombreFactura,
                            tipo: 'Gasto',
                            fecha: compra.fecha
                        });
                    } else {
                        pagos.forEach(pago => {
                            if (pago.estatus === 'Pagado') {
                                transacciones.push({
                                    desde: cuentaData.nombre,
                                    hacia: compra.suplidorNombre,
                                    concepto: `${compra.tipoGasto} - Pago No. ${pago.numeroPago}`,
                                    monto: pago.monto,
                                    documento: compra.nombreFactura,
                                    tipo: 'Gasto',
                                    fecha: pago.fechapago
                                });
                            }
                        });
                    }
                }
            }

            // Transacciones de la cuenta como origen
            const transaccionesSnapshot = await getDocs(
                query(collection(db, "transacciones"), where("cuentaOrigen", "==", cuentaId))
            );
            for (const doc of transaccionesSnapshot.docs) {
                const transaccion = doc.data();
                const fechaTransaccion = convertirFecha(transaccion.fecha);
                if (fechaTransaccion >= fechaInicio && fechaTransaccion < fechaFin) {
                    const nombreCuentaDestino = await obtenerNombreCuenta(transaccion.cuentaDestino);
                    transacciones.push({
                        desde: cuentaData.nombre,
                        hacia: nombreCuentaDestino,
                        concepto: `Transferencia a ${nombreCuentaDestino}`,
                        monto: transaccion.monto.toFixed(2) + ' DOP',
                        documento: 'N/A',
                        tipo: 'Gasto',
                        fecha: transaccion.fecha
                    });
                }
            }

            // Transacciones de la cuenta como destino
            const transaccionesDestinoSnapshot = await getDocs(
                query(collection(db, "transacciones"), where("cuentaDestino", "==", cuentaId))
            );
            for (const doc of transaccionesDestinoSnapshot.docs) {
                const transaccion = doc.data();
                const fechaTransaccion = convertirFecha(transaccion.fecha);
                if (fechaTransaccion >= fechaInicio && fechaTransaccion < fechaFin) {
                    const nombreCuentaOrigen = await obtenerNombreCuenta(transaccion.cuentaOrigen);
                    transacciones.push({
                        desde: nombreCuentaOrigen,
                        hacia: cuentaData.nombre,
                        concepto: `Transferencia desde ${nombreCuentaOrigen}`,
                        monto: transaccion.monto.toFixed(2) + ' DOP',
                        documento: 'N/A',
                        tipo: 'Ingreso',
                        fecha: transaccion.fecha
                    });
                }
            }

            return transacciones;
        }

        async function obtenerNombreCuenta(cuentaId, subcuentaCodigo = null) {
            const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
            if (!cuentaDoc.exists()) {
                throw new Error("Cuenta no encontrada");
            }

            const cuentaData = cuentaDoc.data();

            if (subcuentaCodigo) {
                const subcuenta = cuentaData.subcuentas.find(s => s.codigo === subcuentaCodigo);
                if (!subcuenta) {
                    throw new Error("Subcuenta no encontrada");
                }
                return subcuenta.nombre;
            } else {
                return cuentaData.nombre;
            }
        }

        async function obtenerTransaccionesFiltradasSUBCUENTA(cuentaId, subcuentaCodigo, fechaInicio, fechaFin) {
            const transacciones = [];

            const cuentaDoc = await getDoc(doc(db, "CatalogoCuentas", cuentaId));
            if (!cuentaDoc.exists()) {
                throw new Error("Cuenta no encontrada");
            }

            const cuentaData = cuentaDoc.data();
            const subcuentaIndex = cuentaData.subcuentas.findIndex(s => s.codigo === subcuentaCodigo);
            if (subcuentaIndex === -1) {
                throw new Error("Subcuenta no encontrada");
            }
            const subcuenta = cuentaData.subcuentas[subcuentaIndex];
            const pacientes = subcuenta.pacientes || [];

            // Obtener facturas relacionadas con los pacientes de la subcuenta
            if (pacientes.length > 0) {
                const facturasSnapshot = await getDocs(
                    query(collection(db, "facturas"), where("paciente", "in", pacientes))
                );
                for (const doc of facturasSnapshot.docs) {
                    const factura = doc.data();
                    const fechaFactura = convertirFecha(factura.fecha);
                    if (factura.estatus === 'Cerrada' && fechaFactura >= fechaInicio && fechaFactura < fechaFin) {
                        const pagosSnapshot = await getDocs(collection(db, `facturas/${doc.id}/pagos`));
                        if (pagosSnapshot.empty) {
                            transacciones.push({
                                desde: factura.paciente,
                                hacia: subcuenta.nombre,
                                concepto: `Pago total a la Factura No. ${factura.numeroFactura}`,
                                monto: factura.total,
                                documento: factura.numeroFactura,
                                tipo: 'Ingreso',
                                fecha: factura.fecha
                            });
                        }
                    }
                }

                // Obtener recibos relacionados con los pacientes de la subcuenta
                const recibosSnapshot = await getDocs(
                    query(collection(db, "recibos"), where("paciente", "in", pacientes))
                );
                for (const doc of recibosSnapshot.docs) {
                    const recibo = doc.data();
                    const fechaRecibo = convertirFecha(recibo.fecha);
                    if ((!recibo.items || recibo.items.length === 0) && fechaRecibo >= fechaInicio && fechaRecibo < fechaFin) {
                        transacciones.push({
                            desde: recibo.paciente,
                            hacia: subcuenta.nombre,
                            concepto: `Pago parcial a la Factura No. ${recibo.numeroFactura}`,
                            monto: recibo.totalPago,
                            documento: recibo.numeroFactura,
                            tipo: 'Ingreso',
                            fecha: recibo.fecha
                        });
                    }
                }
            }

            // Obtener compras relacionadas con la subcuenta
            const comprasSnapshot = await getDocs(
                query(collection(db, "RegistroDeCompras"), where("cuenta", "==", cuentaId))
            );
            for (const doc of comprasSnapshot.docs) {
                const compra = doc.data();
                const pagos = compra.pagos || [];
                const fechaCompra = convertirFecha(compra.fecha);

                if (compra.subcuenta?.codigo === subcuentaCodigo && fechaCompra >= fechaInicio && fechaCompra < fechaFin) {
                    if (pagos.length === 0) {
                        transacciones.push({
                            desde: subcuenta.nombre,
                            hacia: compra.suplidorNombre,
                            concepto: compra.tipoGasto,
                            monto: compra.montoApagar,
                            documento: compra.nombreFactura,
                            tipo: 'Gasto',
                            fecha: compra.fecha
                        });
                    } else {
                        pagos.forEach(pago => {
                            if (pago.estatus === 'Pagado') {
                                transacciones.push({
                                    desde: subcuenta.nombre,
                                    hacia: compra.suplidorNombre,
                                    concepto: `${compra.tipoGasto} - Pago No. ${pago.numeroPago}`,
                                    monto: pago.monto,
                                    documento: compra.nombreFactura,
                                    tipo: 'Gasto',
                                    fecha: pago.fechapago
                                });
                            }
                        });
                    }
                }
            }

            // Obtener transacciones de origen de la subcuenta
            const transaccionesSnapshot = await getDocs(
                query(collection(db, "transacciones"), where("cuentaOrigen", "==", `${cuentaId}-${subcuentaIndex}`))
            );
            for (const doc of transaccionesSnapshot.docs) {
                const transaccion = doc.data();
                const nombreCuentaDestino = await obtenerNombreCuenta(transaccion.cuentaDestino);
                const fechaTransaccion = convertirFecha(transaccion.fecha);
                if (fechaTransaccion >= fechaInicio && fechaTransaccion < fechaFin) {
                    transacciones.push({
                        desde: subcuenta.nombre,
                        hacia: nombreCuentaDestino,
                        concepto: `Transferencia a ${nombreCuentaDestino}`,
                        monto: transaccion.monto.toFixed(2) + ' DOP',
                        documento: 'N/A',
                        tipo: 'Gasto',
                        fecha: transaccion.fecha
                    });
                }
            }

            // Obtener transacciones de destino de la subcuenta
            const transaccionesDestinoSnapshot = await getDocs(
                query(collection(db, "transacciones"), where("cuentaDestino", "==", `${cuentaId}-${subcuentaIndex}`))
            );
            for (const doc of transaccionesDestinoSnapshot.docs) {
                const transaccion = doc.data();
                const nombreCuentaOrigen = await obtenerNombreCuenta(transaccion.cuentaOrigen);
                const fechaTransaccion = convertirFecha(transaccion.fecha);
                if (fechaTransaccion >= fechaInicio && fechaTransaccion < fechaFin) {
                    transacciones.push({
                        desde: nombreCuentaOrigen,
                        hacia: subcuenta.nombre,
                        concepto: `Transferencia desde ${nombreCuentaOrigen}`,
                        monto: transaccion.monto.toFixed(2) + ' DOP',
                        documento: 'N/A',
                        tipo: 'Ingreso',
                        fecha: transaccion.fecha
                    });
                }
            }

            return transacciones;
        }


        async function generarExcel(transacciones, cuentaNombre) {
            try {
                const workbook = new ExcelJS.Workbook();

                // Crear hoja para transacciones
                const transaccionesSheet = workbook.addWorksheet('Transacciones', {
                    properties: { tabColor: { argb: 'FFFF00' } } // Color amarillo para la hoja
                });

                // Definir encabezados de las transacciones
                const headers = [
                    'Desde', 'Hacia', 'Concepto', 'Monto', 'Documento', 'Tipo', 'Fecha'
                ];
                transaccionesSheet.addRow(headers);

                // Ordenar las transacciones por fecha de forma ASCENDENTE
                transacciones.sort((a, b) => {
                    const fechaA = new Date(a.fecha.split('/').reverse().join('-')); // Convertir dd/mm/yyyy a yyyy-mm-dd
                    const fechaB = new Date(b.fecha.split('/').reverse().join('-')); // Convertir dd/mm/yyyy a yyyy-mm-dd
                    return fechaA - fechaB; // Orden ascendente
                });

                // Agregar filas de transacciones
                transacciones.forEach((transaccion) => {
                    const {
                        desde, hacia, concepto, monto, documento, tipo, fecha
                    } = transaccion;

                    transaccionesSheet.addRow([desde, hacia, concepto, monto, documento, tipo, fecha]);
                });

                // Aplicar estilo al encabezado
                const headerRow = transaccionesSheet.getRow(1);
                headerRow.eachCell((cell) => {
                    cell.font = { bold: true };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: '0074D9' } }; // Azul
                });

                // Aplicar estilo a las filas de contenido
                transaccionesSheet.eachRow((row, rowNumber) => {
                    if (rowNumber > 1) { // Evitar el encabezado
                        row.eachCell((cell) => {
                            cell.alignment = { horizontal: 'left', vertical: 'middle' }; // Justificado a la izquierda
                            cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' } };
                        });
                    }
                });

                // Ajustar ancho de columnas dinámicamente
                transaccionesSheet.columns.forEach((column) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell) => {
                        const cellValue = cell.value ? cell.value.toString() : '';
                        maxLength = Math.max(maxLength, cellValue.length);
                    });
                    column.width = maxLength + 2;
                });

                // Generar el buffer y descargar el archivo Excel
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                });

                const nombreArchivo = `reporte_transacciones_${cuentaNombre}.xlsx`;
                saveAs(blob, nombreArchivo);

                // Mostrar alerta de éxito
                showAlert2('Archivo de Excel generado correctamente.', 'alert-success');
            } catch (error) {
                console.error('Error al generar el archivo de Excel:', error);
                showAlert2(`Error al generar el archivo de Excel: ${error.message}`, 'alert-danger');
            }
        }






    </script>

    <script src="popper.min.js"></script>
    <script src="simplebar.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="custom-font.js"></script>
    <script src="pcoded.js"></script>
    <script src="feather.min.js"></script>

</body>

</html>