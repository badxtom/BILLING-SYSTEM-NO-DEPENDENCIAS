<!DOCTYPE html>
<html lang="es">


<head>
    <title>Facturar</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="Luz Collado" content="codedthemes">


    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
        id="main-font-link">

    <link rel="stylesheet" href="tabler-icons.min.css">

    <link rel="stylesheet" href="feather.css">

    <link rel="stylesheet" href="fontawesome.css">

    <link rel="stylesheet" href="material.css">

    <link rel="stylesheet" href="style.css" id="main-style-link">
    <link rel="stylesheet" href="style-preset.css">

    <style>
        .text-dark-blue {
            color: darkblue;
        }

        .btn-dark-blue {
            background-color: darkblue;
            color: white;
            border: none;
            transition: background-color 0.3s ease;

        }

        .btn-dark-red {
            background-color: rgb(180, 13, 13);
            color: white;
            border: none;
            transition: background-color 0.3s ease;

        }

        .btn-dark-red:hover {
            background-color: rgb(148, 15, 15);

        }

        .btn-dark-blue:hover {
            background-color: navy;

        }

        .formulario-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            width: 600px;

            max-height: 80%;

            overflow-y: auto;

        }



        #fondoDesenfocado {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;

        }

        #progress-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 50%;
            /* Ajusta este valor según tus necesidades */
        }

        @media only screen and (max-width: 768px) {
            table {
                font-size: 0.8em;
            }

            .form-control {
                font-size: 0.8em;
            }
        }

        @media only screen and (max-width: 480px) {
            table {
                font-size: 0.6em;
            }

            .form-control {
                font-size: 0.6em;
            }
        }

        @media (max-width: 768px) {
            .formulario-container {
                width: 100%;
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }

            .col-md-6 {
                width: 100%;
            }

            .form-floating {
                width: 100%;
            }

            .form-check {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .form-control {
                font-size: 16px;
                padding: 10px;
            }

            .form-label {
                font-size: 16px;
            }
        }

        @media (max-width: 768px) {
            .card-header form {
                flex-direction: column;
            }

            .card-header input[type="search"] {
                width: 100%;
                margin-bottom: 10px;
            }

            .card-header button[type="button"] {
                width: 100%;
                margin-bottom: 10px;
            }
        }


        @media (max-width: 768px) {
            .card-header input[type="search"] {
                font-size: 16px;
                padding: 10px;
            }

            .card-header button[type="button"] {
                font-size: 16px;
                padding: 10px;
            }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

</head>
<script>

</script>

<body data-pc-preset="preset-1" data-pc-sidebar-theme="light" data-pc-sidebar-caption="true" data-pc-direction="ltr"
    data-pc-theme="light">

    <div class="loader-bg">
        <div class="loader-track">
            <div class="loader-fill"></div>
        </div>
    </div>

    <nav class="pc-sidebar">
        <div class="navbar-wrapper">
            <div class="m-header">
                <a href="home" class="b-brand text-primary">
                    <img src="Designer (7).jpeg" style="width: 90px; height: 90px; border-radius: 5px;" alt="...">
                </a>
            </div>

            <div class="navbar-content">
                <ul class="pc-navbar">
                    <li class="pc-item pc-caption">
                        <label>Dashboard</label>
                        <i class="ti ti-dashboard"></i>
                    </li>
                    <li class="pc-item">
                        <a href="home" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-dashboard"></i></span>
                            <span class="pc-mtext">Sistema</span>
                        </a>
                    </li>
                    <li class="pc-item pc-caption">
                        <label>Empresa</label>
                        <i class="ti ti-dashboard"></i>
                    </li>
                    <li class="pc-item">
                        <a href="info" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-clipboard-list"></i></span>
                            <span class="pc-mtext">Datos</span>
                        </a>
                    </li>
                    <li class="pc-item">
                        <a href="employees" class="pc-link">
                            <span class="pc-micon"><i class="ti ti-friends"></i></span>
                            <span class="pc-mtext">Empleados</span>
                        </a>
                    </li>
                    <li class="pc-item">
                        <a href="finanzas" class="pc-link disabled" id="finanzas">
                            <span class="pc-micon"><i class="ti ti-report-money"></i></span>
                            <span class="pc-mtext">Finanzas</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="pc-header">
        <div class="header-wrapper">

            <div class="ms-auto">
                <ul class="list-unstyled">
                    <li class="pc-h-item header-mobile-collapse">
                        <a href="#" class="pc-head-link head-link-secondary ms-0" id="sidebar-hide">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <li class="pc-h-item pc-sidebar-popup">
                        <a href="#" class="pc-head-link head-link-secondary ms-0" id="mobile-collapse">
                            <i class="ti ti-menu-2"></i>
                        </a>
                    </li>
                    <!-- <li class="dropdown pc-h-item">
                        <a class="pc-head-link head-link-secondary dropdown-toggle arrow-none me-0"
                            data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false"
                            aria-expanded="false">
                            <i class="ti ti-bell"></i>
                        </a>
                        <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown">
                            <div class="dropdown-header">
                                <a href="#!" class="link-primary float-end text-decoration-underline">Mark as all
                                    read</a>
                                <h5>All Notification <span class="badge bg-warning rounded-pill ms-1">01</span></h5>
                            </div>
                            <div class="dropdown-header px-0 text-wrap header-notification-scroll position-relative"
                                style="max-height: calc(100vh - 215px)">
                                <div class="list-group list-group-flush w-100">
                                    <div class="list-group-item list-group-item-action">
                                        <div class="d-flex">
                                            <div class="flex-shrink-0">
                                                <div class="user-avtar bg-light-success"><i
                                                        class="ti ti-building-store"></i></div>
                                            </div>
                                            <div class="flex-grow-1 ms-1">
                                                <span class="float-end text-muted">3 min ago</span>
                                                <h5>Store Verification Done</h5>
                                                <p class="text-body fs-6">We have successfully received your request.
                                                </p>
                                                <div class="badge rounded-pill bg-light-danger">Unread</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="list-group-item list-group-item-action">
                                        <div class="d-flex">
                                            <div class="flex-shrink-0">
                                                <img src="../assets/images/user/avatar-3.jpg" alt="user-image"
                                                    class="user-avtar">
                                            </div>
                                            <div class="flex-grow-1 ms-1">
                                                <span class="float-end text-muted">10 min ago</span>
                                                <h5>Joseph William</h5>
                                                <p class="text-body fs-6">It is a long established fact that a reader
                                                    will be distracted </p>
                                                <div class="badge rounded-pill bg-light-success">Confirmation of Account
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="text-center py-2">
                                <a href="#!" class="link-primary">Mark as all read</a>
                            </div>
                        </div>
                    </li> -->
                    <li class="dropdown pc-h-item header-user-profile">
                        <a class="pc-head-link head-link-primary dropdown-toggle arrow-none me-0"
                            data-bs-toggle="dropdown" href="#" role="button" aria-haspopup="false"
                            aria-expanded="false">
                            <img src="Designer (7).jpeg" style="width: 50px; height: 50px; border-radius: 50%;" />
                            <span>
                                <i class="ti ti-settings"></i>
                            </span>
                        </a>
                        <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown">
                            <div class="dropdown-header">
                                <h4>Hola, <span class="small text-muted" id="username"> Name</span></h4>
                                <p class="text-muted" id="role">Rol</p>
                                <hr>
                                <div class="profile-notification-scroll position-relative"
                                    style="max-height: calc(100vh - 280px)">
                                    <hr>
                                    <button id="settingsButton" type="submit" class="dropdown-item">
                                        <i class="ti ti-settings"></i>
                                        <span>Configuración</span>
                                    </button>
                                    <button id="registerButton" type="submit" class="dropdown-item">
                                        <i class="ti ti-user-plus"></i>
                                        <span>Registro</span>
                                    </button>
                                    <button class="dropdown-item" id="signoutbutton">
                                        <i class="ti ti-logout"></i>
                                        <span>Cerrar Sesión</span>
                                    </button>

                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </header>

    <div class="pc-container">
        <div class="pc-content">

            <div class="row">
                <div class="col">
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item"><a href="home">Sistema</a></li>
                        <li class="breadcrumb-item" aria-current="page">Facturar</li>
                    </ul>
                </div>
            </div>

            <div class="row">
                <div class="col-sm-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Facturación</h5>
                            <div class="card-header" style="margin-top: 10px;">
                                <form id="MainFormSE" class="d-flex" style="max-width: 400px; margin-bottom: 10px;">
                                    <input id="searchInput" class="form-control me-sm-2" type="search"
                                        placeholder="Buscar producto" style="flex: 1 0 auto;">
                                </form>
                                <div id="searchResults" class="dropdown-menu" style="display: none;"></div>
                                <form id="MainFormPE" class="d-flex" style="max-width: 400px; margin-bottom: 20px;">
                                    <input id="searchPatientInput" class="form-control me-sm-2" type="search"
                                        placeholder="Buscar paciente" style="flex: 1 0 auto;">
                                </form>
                                <div id="searchPatientResults" class="dropdown-menu" style="display: none;"></div>
                                <form id="MainFormDO" class="d-flex" style="max-width: 400px; margin-bottom: 20px;">
                                    <input id="searchDoctorInput" class="form-control me-sm-2" type="search"
                                        placeholder="Buscar médico" style="flex: 1 0 auto;">
                                </form>
                                <div id="searchDoctorResults" class="dropdown-menu" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="desp" placeholder="Descripción">
                                        <label for="desp">*Descripción</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="disp" placeholder="Disponible">
                                        <label for="disp">*Disponible</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="precio" placeholder="Precio">
                                        <label for="precio">*Precio</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="itbis" placeholder="ITBIS">
                                        <label for="itbis">*ITBIS</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control" id="cantidadFacturar"
                                            placeholder="Cantidad a facturar">
                                        <label for="cantidadFacturar">*Cantidad a facturar</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating mb-3">
                                        <select class="form-control" id="formaDePago" aria-label="Forma de Pago">
                                            <option selected>Seleccionar Forma de Pago</option>
                                            <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                                            <option value="Tarjeta de Débito">Tarjeta de Débito</option>
                                            <option value="Efectivo">Efectivo</option>
                                        </select>
                                        <label for="formaDePago">*Forma de Pago</label>
                                    </div>
                                </div>
                            </div>
                            <button id="addToListButton" type="button" class="btn btn-success">Agregar a la
                                lista</button>
                            <hr>
                            <div class="table-responsive">
                                <table id="facturaTable" class="table" style="overflow-x: auto;">
                                    <thead>
                                        <tr>
                                            <th scope="col">Descripción</th>
                                            <th scope="col">Cantidad</th>
                                            <th scope="col">Precio Unitario</th>
                                            <th scope="col">ITBIS</th>
                                            <th scope="col">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="facturaTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div id="totalsContainer" class="mt-3">
                                <label id="totalLabel">Total a pagar:$0.00</label>
                                <br>
                            </div>
                            <button id="generatePDFButton" type="button" class="btn btn-primary mr-3">Generar
                                Factura</button>
                            <div class="form-check d-inline-block">
                                <input class="form-check-input" type="checkbox" id="comprobanteCheckbox">
                                <label class="form-check-label" for="comprobanteCheckbox">
                                    Comprobante Fiscal
                                </label>
                            </div>
                            <div class="form-check d-inline-block">
                                <input class="form-check-input mr-3" type="checkbox" id="EstatusCheckbox">
                                <label class="form-check-label" for="EstatusCheckbox">
                                    Abierta
                                </label>
                            </div>
                            <div id="condicionPagoContainer" style="display: none;">
                                <label for="condicionPago">Condición de Pago</label>
                                <input type="number" class="form-control" id="condicionPago" min="1"
                                    placeholder="Número de pagos" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="progress-container" style="display:none;">
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                    aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 75%;"></div>
            </div>
        </div>
    </div>
    <div id="fondoDesenfocado"></div>
    <footer class="pc-footer">
        <div class="footer-wrapper container-fluid">
            <div class="row">
                <div class="col-sm-6 my-1">
                    <p class="m-0">By: Luz Collado<a target="_blank"></a></p>
                </div>
            </div>
        </div>
    </footer>


    <script type="module">
        window.addEventListener('DOMContentLoaded', () => {
            const userCreds = sessionStorage.getItem("user-creds");

            if (!userCreds && window.location.pathname.includes('facturar')) {
                window.location.href = 'login';
                return; // Agrega return para detener la ejecución
            }

            if (userCreds && window.location.pathname.includes('facturar')) {
                const UserCreds = JSON.parse(userCreds);
                const userId = UserCreds.uid;

                const dbRef = ref(db);
                get(child(dbRef, `UsersAuthList/${userId}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const role = userData.roleselect;
                        const roleElement = document.getElementById('role');

                        if (role === 'Administrador de Almacén') {
                            window.location.href = 'home';
                        } else {
                            // roleElement.textContent = role;
                        }
                    } else {
                        console.log("No data available");
                    }
                }).catch((error) => {
                    console.error(error);
                });
            }
        });

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";
        import { getDatabase, set, ref, get, child, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, orderBy, addDoc, query, limit, getDocs, getDoc, doc, setDoc, serverTimestamp, deleteDoc, Timestamp, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, uploadBytesResumable, listAll } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCknSaxVHB10B_v-4yD9UtNj1dmZZKVRe4",
            authDomain: "billing-system-fbfb3.firebaseapp.com",
            projectId: "billing-system-fbfb3",
            storageBucket: "billing-system-fbfb3.appspot.com",
            messagingSenderId: "906484441227",
            appId: "1:906484441227:web:7b486131ad930a7b03b48e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const auth = getAuth();
        const storage = getStorage(app);
        const dba = getFirestore(app);

        const generatePdfButton = document.getElementById('generatePDFbutton');

        const form = document.getElementById('MainForm');
        const formE = document.getElementById('MainFormE');

        const usernameElement = document.getElementById('username');
        const roleElement = document.getElementById('role');
        const registerButton = document.getElementById('registerButton');
        const settingsButton = document.getElementById('settingsButton');
        const nuevoFormulario = document.getElementById('nuevoFormulario');
        const Nuevo = document.getElementById('nuevo');
        const Editar = document.getElementById('editar');
        const fondoDesenfocado = document.getElementById('fondoDesenfocado');
        const closeButton = document.getElementById('closeButton');

        let FnameInp = document.getElementById('fnameInp');
        const numberInput = document.getElementById('number');
        const locationInput = document.getElementById('location');

        const searchPatientInput = document.getElementById('searchPatientInput');
        const searchPatientResults = document.getElementById('searchPatientResults');

        function showUserData(userId) {
            const dbRef = ref(db);
            get(child(dbRef, `UsersAuthList/${userId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    usernameElement.textContent = `${userData.firstname} ${userData.lastname}`;
                    roleElement.textContent = userData.roleselect;

                    if (userData.roleselect === 'Asistente') {
                        registerButton.disabled = true;
                    }
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                showUserData(user.uid);
            } else {
                console.log("User is not signed in");
            }
        });

        let UserCreds = JSON.parse(sessionStorage.getItem("user-creds"));
        let UserInfo = JSON.parse(sessionStorage.getItem("user-info"));
        let UserName = JSON.parse(sessionStorage.getItem("username"));
        let Role = JSON.parse(sessionStorage.getItem("role"));
        let MainForm = document.getElementById('MainForm');
        let MainFormE = document.getElementById('MainFormE');
        let MainFormSE = document.getElementById('MainFormSE');
        const searchInput = document.getElementById('searchInput');

        let SignoutBtn = document.getElementById('signoutbutton');



        const totalLabel = document.getElementById('totalLabel');
        const totalWithITBISLabel = document.getElementById('totalWithITBISLabel');
        const generatePDFButton = document.getElementById('generatePDFButton');

        let Signout = () => {
            sessionStorage.removeItem("user-creds");
            sessionStorage.removeItem("user-info");

            window.location.href = 'login';
        }

        let CheckCred = () => {
            if (!sessionStorage.getItem("user-creds"))
                window.location.href = 'login';
            else {
                UserName.innerText = ` ${UserName.firstname}`
                Role.innerText = ` ${UserName.roleselect}`
            }
        }

        document.getElementById('registerButton').addEventListener('click', () => {
            window.location.href = 'register';
        });

        document.getElementById('settingsButton').addEventListener('click', () => {
            window.location.href = 'settings';
        });
        SignoutBtn.addEventListener('click', Signout);

        function validatePhoneNumber(event) {
            const input = event.target;
            const inputValue = input.value;

            const numericValue = inputValue.replace(/\D/g, '');
            const trimmedValue = numericValue.slice(0, 10);
            input.value = trimmedValue;
        }

        cantidadFacturar.addEventListener('input', validatePhoneNumber);


        document.addEventListener('DOMContentLoaded', function () {
            const db = getFirestore(app);

            const searchInput = document.getElementById('searchInput');
            const descripcionInput = document.getElementById('desp');
            const disponibleInput = document.getElementById('disp');
            const precioInput = document.getElementById('precio');
            const ITBISInput = document.getElementById('itbis');
            const cantidadFacturarInput = document.getElementById('cantidadFacturar');
            const addToListButton = document.getElementById('addToListButton');
            const facturaTableBody = document.getElementById('facturaTableBody');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');
            const totalLabel = document.getElementById('totalLabel');

            const searchDoctorInput = document.getElementById('searchDoctorInput');
            const searchDoctorResults = document.getElementById('searchDoctorResults');

            descripcionInput.disabled = true;
            disponibleInput.disabled = true;
            // precioInput.disabled = true;
            ITBISInput.disabled = true;

            let productos = [];
            let pacientes = [];
            let empleados = [];



            function updateDropdown(query, resultsElement, items, isProduct, callback) {
                resultsElement.innerHTML = '';
                resultsElement.style.display = 'none';

                items.forEach(item => {
                    if (isProduct) {
                        // Para productos, buscar por descripción
                        const searchField = item.descripcion;
                        if (searchField.toLowerCase().includes(query.toLowerCase())) {
                            const dropdownItem = document.createElement('button');
                            dropdownItem.classList.add('dropdown-item');
                            dropdownItem.type = 'button';
                            dropdownItem.textContent = searchField;
                            dropdownItem.addEventListener('click', function () {
                                callback(item);
                                resultsElement.style.display = 'none';
                            });
                            resultsElement.appendChild(dropdownItem);
                            resultsElement.style.display = 'block';
                        }
                    } else {
                        // Para pacientes y médicos, buscar por nombre completo (fname + lname)
                        const searchField = `${item.fname} ${item.lname}`;
                        if (searchField.toLowerCase().includes(query.toLowerCase())) {
                            const dropdownItem = document.createElement('button');
                            dropdownItem.classList.add('dropdown-item');
                            dropdownItem.type = 'button';
                            dropdownItem.textContent = searchField;
                            dropdownItem.addEventListener('click', function () {
                                callback(item);
                                resultsElement.style.display = 'none';
                            });
                            resultsElement.appendChild(dropdownItem);
                            resultsElement.style.display = 'block';
                        }
                    }
                });
            }



            async function getAllProductos() {
                const querySnapshot = await getDocs(collection(db, 'productos'));
                productos = querySnapshot.docs.map(doc => doc.data());
            }

            async function getAllPacientes() {
                const querySnapshot = await getDocs(collection(db, 'pacientes'));
                pacientes = querySnapshot.docs.map(doc => doc.data());
            }

            async function getAllEmpleados() {
                const querySnapshot = await getDocs(collection(db, 'empleados'));
                empleados = querySnapshot.docs.filter(doc => doc.data().role === 'Doctor').map(doc => doc.data());
            }


            function updateTotals() {
                let total = 0;
                let moneda = '';

                const rows = facturaTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 5) {
                        const cantidad = parseFloat(cells[1].textContent);
                        const precioUnitarioTexto = cells[2].textContent.trim();
                        const [precioUnitario, monedaLocal] = precioUnitarioTexto.split(' ');
                        moneda = monedaLocal;
                        const precioUnitarioNum = parseFloat(precioUnitario);
                        const itbis = cells[3].textContent === '18%' ? 0.18 : 0;
                        const subtotal = cantidad * precioUnitarioNum * (1 + itbis);
                        cells[4].textContent = `${subtotal.toFixed(2)} ${moneda}`;  // Actualizar la celda de total con el subtotal calculado y la moneda
                        total += subtotal;
                    } else {
                        console.error('Unexpected number of cells in row:', cells.length);
                    }
                });
                if (totalLabel) {
                    totalLabel.textContent = `Total a pagar: ${total.toFixed(2)} ${moneda}`;
                } else {
                    console.error('totalLabel not found in the DOM');
                }
            }


            function addToFactura() {
                const descripcion = descripcionInput.value;
                const cantidad = parseInt(cantidadFacturarInput.value);
                const precioMoneda = precioInput.value.split(' ');
                const moneda = precioMoneda[1];
                const precio = parseFloat(precioMoneda[0]);
                const disponible = parseInt(disponibleInput.value);
                const itbis = ITBISInput.value === '18%' ? '18%' : 'N/A';

                if (!descripcion || isNaN(cantidad) || cantidad <= 0 || isNaN(precio) || precio <= 0) {
                    showAlert('Por favor, complete todos los campos.', 'alert-warning');
                    return;
                }

                if (cantidad > disponible) {
                    showAlert('No hay suficiente stock disponible.', 'alert-danger');
                    return;
                }

                if (!isNaN(cantidad) && cantidad > 0) {
                    const itbisFactor = itbis === '18%' ? 1.18 : 1;
                    const total = cantidad * precio * itbisFactor;
                    const row = document.createElement('tr');

                    row.innerHTML = `
            <td>${descripcion}</td>
            <td>${cantidad}</td>
            <td>${precio.toFixed(2)} ${moneda}</td>
            <td>${itbis}</td>
            <td>${total.toFixed(2)} ${moneda}</td>
            <td><button class="btn btn-danger btn-sm delete-button">Eliminar</button></td>
        `;

                    facturaTableBody.appendChild(row);

                    row.querySelector('.delete-button').addEventListener('click', function () {
                        row.remove();
                        updateTotals();
                    });
                    updateTotals();
                } else {
                    showAlert('Ingrese una cantidad válida.', 'alert-warning');
                }
            }



            searchInput.addEventListener('input', function () {
                const query = searchInput.value.trim();
                updateDropdown(query, searchResults, productos, true, function (producto) {
                    searchInput.value = producto.descripcion;
                    descripcionInput.value = producto.descripcion;
                    disponibleInput.value = producto.disponible;
                    precioInput.value = `${producto.precioVenta} ${producto.moneda}`;
                    ITBISInput.value = producto.itbis;
                    cantidadFacturarInput.value = '';
                });
            });

            searchPatientInput.addEventListener('input', function () {
                const query = searchPatientInput.value.trim();
                updateDropdown(query, searchPatientResults, pacientes, false, function (paciente) {
                    searchPatientInput.value = `${paciente.fname} ${paciente.lname}`;
                });
            });

            searchDoctorInput.addEventListener('input', function () {
                const query = searchDoctorInput.value.trim();
                updateDropdown(query, searchDoctorResults, empleados, false, function (doctor) {
                    searchDoctorInput.value = `${doctor.fname} ${doctor.lname}`;
                    // You can also populate other fields with the doctor's information
                });
            });


            document.addEventListener('click', function (event) {
                if (!searchResults.contains(event.target) && !searchInput.contains(event.target)) {
                    searchResults.style.display = 'none';
                }
                if (!searchPatientResults.contains(event.target) && !searchPatientInput.contains(event.target)) {
                    searchPatientResults.style.display = 'none';
                }
                if (!searchDoctorResults.contains(event.target) && !searchDoctorInput.contains(event.target)) {
                    searchDoctorResults.style.display = 'none';
                }
            });


            addToListButton.addEventListener('click', addToFactura);

            cantidadFacturarInput.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    addToFactura();
                }
            });


            getAllProductos();
            getAllPacientes();
            getAllEmpleados();


        });


        function showSuccessAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.classList.add('alert', 'alert-dismissible', 'alert-success', 'position-fixed', 'top-50', 'start-50', 'translate-middle');
            alertDiv.innerHTML = `
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <strong>¡Bien hecho!</strong> ${message}
  `;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }


        async function obtenerNumeroFactura() {

            const facturaRef = ref(db, 'numerosFactura/ultimoNumero');
            const facturaSnapshot = await get(facturaRef);
            const ultimoNumero = facturaSnapshot.val();

            const nuevoNumero = ultimoNumero + 1;


            await set(facturaRef, nuevoNumero);

            return nuevoNumero;
        }

        async function obtenerNumeroRecibo() {
            try {
                const reciboRef = ref(db, 'numerosRecibo/ultimoNumero'); // Referencia al documento que contiene el último número de recibo
                const reciboSnapshot = await get(reciboRef); // Obtener el snapshot del documento

                let ultimoNumero = 0;
                if (reciboSnapshot.exists()) {
                    ultimoNumero = reciboSnapshot.val(); // Obtener el último número de recibo
                }

                const nuevoNumero = ultimoNumero + 1; // Generar el nuevo número de recibo

                await set(reciboRef, nuevoNumero); // Actualizar el número de recibo en Firestore

                return nuevoNumero; // Devolver el nuevo número de recibo generado
            } catch (error) {
                console.error('Error al obtener o actualizar el número de recibo:', error);
                return null; // Manejar errores retornando null o un valor predeterminado
            }
        }




        function obtenerFechaActual() {
            const fecha = new Date();
            const dia = String(fecha.getDate()).padStart(2, '0'); // Obtener el día, y asegurarse de que tenga 2 dígitos
            const mes = String(fecha.getMonth() + 1).padStart(2, '0'); // Obtener el mes (los meses van de 0 a 11 en JavaScript)
            const año = fecha.getFullYear(); // Obtener el año

            return `${dia}/${mes}/${año}`;
        }


        function obtenerFechaActualF() {
            const fecha = new Date();
            const dia = fecha.getDate();
            const mes = fecha.getMonth() + 1;
            const año = fecha.getFullYear();
            return `${dia}-${mes}-${año}`;
        }

        function showAlert(message, alertType) {
            const alertDiv = document.createElement('div');
            alertDiv.classList.add('alert', 'alert-dismissible', alertType, 'position-fixed', 'top-50', 'start-50', 'translate-middle');
            alertDiv.innerHTML = `
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    <h4 class="alert-heading">¡Advertencia!</h4>
    <p class="mb-0">${message}</p>
  `;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        document.getElementById('EstatusCheckbox').addEventListener('change', function () {
            const condicionPagoContainer = document.getElementById('condicionPagoContainer');
            if (this.checked) {
                condicionPagoContainer.style.display = 'block';
            } else {
                condicionPagoContainer.style.display = 'none';
            }
        });

        let numeroFacturaGlobal = '';

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const progressContainer = document.getElementById('progress-container');

            const searchInput = document.getElementById('searchInput');
            const descripcionInput = document.getElementById('desp');
            const disponibleInput = document.getElementById('disp');
            const precioInput = document.getElementById('precio');
            const ITBISInput = document.getElementById('itbis');
            const cantidadFacturarInput = document.getElementById('cantidadFacturar');
            const facturaTableBody = document.getElementById('facturaTableBody');
            const searchResults = document.getElementById('searchResults');
            const totalLabel = document.getElementById('totalLabel');
            const searchDoctorInput = document.getElementById('searchDoctorInput');
            const comprobanteCheckbox = document.getElementById('comprobanteCheckbox');
            const estatusCheckbox = document.getElementById('EstatusCheckbox');
            const formaDePagoSelect = document.getElementById('formaDePago');

            let numeroFactura = '';
            let numeroComprobante = '';
            let fechaVencimiento = '';
            let gananciaTotal = 0;
            let totalFactura = 0;
            let moneda = '';

            if (facturaTableBody.querySelectorAll('tr').length === 0) {
                showAlert('La tabla está vacía. Por favor, agregue productos antes de generar la factura.', 'alert-warning');
                return;
            }

            const pacienteSeleccionado = document.getElementById('searchPatientInput').value;
            if (pacienteSeleccionado.trim() === '') {
                showAlert('El campo del paciente está vacío. Por favor, seleccione un paciente antes de generar la factura.', 'alert-warning');
                return;
            }

            const DoctorSeleccionado = document.getElementById('searchDoctorInput').value;
            if (DoctorSeleccionado.trim() === '') {
                showAlert('El campo del médico está vacío. Por favor, seleccione un médico antes de generar la factura.', 'alert-warning');
                return;
            }

            const formaDePagoSeleccionada = formaDePagoSelect.value;
            if (formaDePagoSeleccionada === 'Seleccionar Forma de Pago') {
                showAlert('Por favor, seleccione una forma de pago.', 'alert-warning');
                return;
            }

            // Obtener información del paciente (dirección y teléfono)
            const pacienteInfo = await getPacienteInfoFromDatabase(pacienteSeleccionado);
            if (!pacienteInfo) {
                showAlert('Paciente no encontrado en la base de datos. Verifique el nombre e inténtelo nuevamente.', 'alert-danger');
                return;
            }

            doc.setFontSize(12);

            // Obtener datos del comprobante fiscal si está seleccionado
            if (comprobanteCheckbox.checked) {
                try {
                    const comprobantesSnapshot = await get(ref(db, 'comprobantes/'));
                    if (comprobantesSnapshot.exists()) {
                        const comprobantesData = comprobantesSnapshot.val();
                        const desde = comprobantesData.desde || '';
                        const hasta = comprobantesData.hasta || '';
                        fechaVencimiento = comprobantesData.fechaVencimiento || '';

                        // Obtener el último número de factura generado
                        let lastFacturaNumber = await getLastFacturaNumber();

                        // Generar el próximo número de factura
                        let nextFacturaNumber = lastFacturaNumber + 1;

                        // Validar que el próximo número esté dentro del rango permitido
                        if (nextFacturaNumber > parseInt(hasta.substring(1))) {
                            showAlert('Se ha alcanzado el límite máximo de facturas para este comprobante.', 'alert-warning');
                            return;
                        }

                        // Formatear el número de factura
                        const formattedNextFacturaNumber = `${desde.substring(0, 1)}${nextFacturaNumber.toString().padStart(hasta.length - 1, '0')}`;

                        // Guardar el nuevo número de factura en la base de datos
                        await updateLastFacturaNumber(nextFacturaNumber);

                        // Asignar el número de factura al documento PDF
                        numeroFactura = formattedNextFacturaNumber;
                        numeroComprobante = formattedNextFacturaNumber;
                    } else {
                        showAlert('No se encontraron datos de comprobantes válidos.', 'alert-danger');
                        return;
                    }
                } catch (error) {
                    console.error('Error al obtener datos de comprobantes:', error);
                    showAlert('Error al obtener datos de comprobantes.', 'alert-danger');
                    return;
                }
            }

            if (numeroFactura !== '') {
                const facturaX = 200 - doc.getTextWidth(`NCF: ${numeroFactura}`);
                doc.text(`NCF: ${numeroFactura}`, facturaX, 40);

                const fechaVencimientoX = 200 - doc.getTextWidth(`Vencimiento Secuencia: ${fechaVencimiento}`);
                doc.text(`Vencimiento Secuencia: ${fechaVencimiento}`, fechaVencimientoX, 45);
            }

            const productosEnFactura = facturaTableBody.querySelectorAll('tr');

            for (let i = 0; i < productosEnFactura.length; i++) {
                const descripcionProducto = productosEnFactura[i].querySelector('td:nth-child(1)').textContent;
                const cantidadProducto = parseInt(productosEnFactura[i].querySelector('td:nth-child(2)').textContent);

                try {
                    const querySnapshot = await getDocs(query(collection(dba, 'productos'), where('descripcion', '==', descripcionProducto)));
                    querySnapshot.forEach(doc => {
                        const productoData = doc.data();
                        const precioCompra = productoData.precio; // Precio de compra del producto
                        const precioVenta = productoData.precioVenta; // Precio de venta del producto

                        if (precioVenta !== precioCompra) {
                            gananciaTotal += (precioVenta - precioCompra) * cantidadProducto;
                        }
                    });
                } catch (error) {
                    console.error('Error al obtener datos del producto:', error);
                }
            }

            const rows = facturaTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const totalProducto = parseFloat(row.cells[4].textContent);
                totalFactura += totalProducto;
                moneda = row.cells[4].textContent.split(' ')[1]; // Obtener la moneda del total
            });

            progressContainer.style.display = 'block';
            fondoDesenfocado.style.display = 'block';

            const logoImage = new Image();
            logoImage.src = 'unoin.png';

            logoImage.onload = async () => {
                const logoWidth = 20;
                const logoHeight = (logoWidth / logoImage.width) * logoImage.height;
                const marginRight = 15;
                const marginTop = 5;
                doc.addImage(logoImage, 'PNG', doc.internal.pageSize.width - logoWidth - marginRight, marginTop, logoWidth, logoHeight);

                doc.setFontSize(18);
                doc.text("FACTURA", 14, 15);

                doc.setFontSize(12);
                const empresaSnapshot = await get(ref(db, 'datos/'));
                const empresaData = empresaSnapshot.val();

                if (empresaData) {
                    doc.text(`${empresaData.name}`, 15, 25);
                    doc.text(`RNC: ${empresaData.rnc}`, 15, 30);
                    doc.text(`Teléfono: ${empresaData.number}`, 15, 35);

                    const location = empresaData.location;
                    if (location.length > 15) {
                        const firstLine = location.substring(0, 23);
                        let secondLine = location.substring(23);
                        if (secondLine.length > 35) {
                            const secondLineFirstPart = secondLine.substring(0, 35);
                            const secondLineSecondPart = secondLine.substring(35);
                            secondLine = secondLineFirstPart + '\n' + secondLineSecondPart;
                        }
                        doc.text(`Dirección: ${firstLine}`, 15, 40);
                        doc.text(`${secondLine}`, 15, 45);
                    } else {
                        doc.text(`Dirección: ${empresaData.location}`, 17, 40);
                    }
                }
                const marginLeft = 15;
                const numeroFactura = await obtenerNumeroFactura();
                const facturaX = marginLeft; // Ajusta la posición X para alinear a la izquierda
                doc.text(`No. Factura: ${numeroFactura}`, facturaX, 60);

                numeroFacturaGlobal = numeroFactura;

                const fechaActual = obtenerFechaActual();
                const fechaActualF = obtenerFechaActualF();
                const fechaX = marginLeft; // Ajusta la posición X para alinear a la izquierda
                doc.text(`Fecha: ${fechaActual}`, fechaX, 65);

                const nombreDoctorX = marginLeft; // Ajusta la posición X para alinear a la izquierda
                const nombreDoctorWidth = doc.getTextWidth(DoctorSeleccionado);

                doc.text("Doctor:", nombreDoctorX, 75);
                const nombreDoctorStartX = nombreDoctorX + doc.getTextWidth("Doctor:");
                const nombreDoctorEndX = nombreDoctorStartX + nombreDoctorWidth;

                if (nombreDoctorEndX > marginLeft) {
                    doc.text(`${DoctorSeleccionado}`, marginLeft, 80);
                } else {
                    doc.text(`${DoctorSeleccionado}`, nombreDoctorStartX, 80);
                }

                const nombrePacienteX = marginLeft; // Ajusta la posición X para alinear a la izquierda
                const nombrePacienteWidth = doc.getTextWidth(pacienteSeleccionado);

                doc.text("Facturado a:", nombrePacienteX, 90);
                const nombrePacienteStartX = nombrePacienteX + doc.getTextWidth("Facturado a:");
                const nombrePacienteEndX = nombrePacienteStartX + nombrePacienteWidth;

                if (nombrePacienteEndX > marginLeft) {
                    doc.text(`${pacienteSeleccionado}`, marginLeft, 95);
                } else {
                    doc.text(`${pacienteSeleccionado}`, nombrePacienteStartX, 95);
                }

                // Agregar dirección y teléfono del paciente
                doc.text(`Dirección: ${pacienteInfo.direccion}`, nombrePacienteX, 100);
                doc.text(`Teléfono: ${pacienteInfo.telefono}`, nombrePacienteX, 105);

                doc.line(14, 115, 200, 115);

                doc.autoTable({
                    head: [['Descripción', 'Cantidad', 'Precio Unitario', 'ITBIS', 'Total']],
                    body: Array.from(facturaTableBody.querySelectorAll('tr')).map(row => Array.from(row.querySelectorAll('td')).slice(0, 5).map(cell => cell.textContent)),
                    startY: 125
                });

                doc.text(totalLabel.textContent, 14, doc.lastAutoTable.finalY + 10);

                // Agregar la forma de pago al documento PDF
                doc.text(`Forma de Pago: ${formaDePagoSeleccionada}`, 14, doc.lastAutoTable.finalY + 20);

                const finalY = doc.internal.pageSize.height - 10; // Posición Y para la línea y texto
                const lineaWidth = (doc.internal.pageSize.width - 100) / 2; // Longitud de la línea reducida a la mitad
                const lineaX1 = (doc.internal.pageSize.width / 2) - (lineaWidth / 2); // Coordenada X inicial de la línea
                const lineaX2 = lineaX1 + lineaWidth; // Coordenada X final de la línea
                doc.setLineWidth(0.5);
                doc.line(lineaX1, finalY, lineaX2, finalY);

                // Texto "Firma y Sello"
                const textoFirmaCelloX = doc.internal.pageSize.width / 2;
                const textoFirmaCelloY = finalY + 5; // Ajusta la posición vertical según necesites
                doc.setFontSize(10);
                doc.text("Firma y Sello", textoFirmaCelloX, textoFirmaCelloY, { align: "center" });

                const pdfBlob = doc.output('blob');

                try {
                    const storage = getStorage(app);

                    // Guardar en Storage usando el ID del paciente como carpeta
                    const pacienteFolderRef = storageRef(storage, `facturas/${pacienteInfo.id}/`);
                    let facturaStorageRef = storageRef(pacienteFolderRef, `${fechaActualF}.pdf`);

                    // Verificar si ya existe un archivo con el mismo nombre
                    let i = 1;
                    while (await getDownloadURL(facturaStorageRef).then(() => true).catch(() => false)) {
                        facturaStorageRef = storageRef(pacienteFolderRef, `${fechaActualF} (${i}).pdf`);
                        i++;
                    }

                    await uploadBytes(facturaStorageRef, pdfBlob);

                    const facturaURL = await getDownloadURL(facturaStorageRef);

                    const facturaData = {
                        paciente: pacienteSeleccionado,
                        doctor: DoctorSeleccionado,
                        numeroFactura: numeroFactura,
                        fecha: fechaActual,
                        items: Array.from(facturaTableBody.querySelectorAll('tr')).map(row => ({
                            descripcion: row.cells[0].textContent,
                            cantidad: parseInt(row.cells[1].textContent),
                            precioUnitario: parseFloat(row.cells[2].textContent),
                            itbis: row.cells[3].textContent,
                            total: parseFloat(row.cells[4].textContent)
                        })),
                        total: `${totalFactura.toFixed(2)} ${moneda}`,
                        estatus: estatusCheckbox.checked ? 'Abierta' : 'Cerrada',
                        comprobante: comprobanteCheckbox.checked ? numeroComprobante : null,
                        ganancia: `${gananciaTotal.toFixed(2)}`,
                        formaDePago: formaDePagoSeleccionada,
                        urlFactura: facturaURL
                    };

                    const facturaRef = await addDoc(collection(dba, 'facturas'), facturaData);

                    // Actualizar la cantidad disponible del producto en la base de datos
                    const rows = facturaTableBody.querySelectorAll('tr');
                    rows.forEach(async (row) => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 5) {
                            const descripcion = cells[0].textContent;
                            const cantidadFacturada = parseInt(cells[1].textContent);

                            const querySnapshot = await getDocs(query(collection(dba, 'productos'), where('descripcion', '==', descripcion)));
                            querySnapshot.forEach(async (doc) => {
                                const productoId = doc.id;
                                const productoData = doc.data();
                                const disponible = productoData.disponible;

                                // Verificar si disponible es numérico
                                let nuevaCantidadDisponible;
                                if (isNaN(disponible)) {
                                    nuevaCantidadDisponible = 'N/A';
                                } else {
                                    nuevaCantidadDisponible = disponible - cantidadFacturada;
                                }

                                await updateDoc(doc.ref, { disponible: nuevaCantidadDisponible });
                            });
                        }
                    });

                    if (estatusCheckbox.checked) {
                        const condicionPago = parseInt(document.getElementById('condicionPago').value);
                        if (isNaN(condicionPago) || condicionPago <= 0) {
                            showAlert('Ingrese una condición de pago válida.', 'alert-danger');
                            return;
                        }

                        const totalPorPago = parseFloat((totalFactura / condicionPago).toFixed(2));
                        const gananciaPorPago = parseFloat((gananciaTotal / condicionPago).toFixed(2));
                        let pagos = [];
                        for (let j = 1; j <= condicionPago; j++) {
                            pagos.push({
                                numeroPago: j,
                                total: totalPorPago,
                                ganancia: gananciaPorPago,
                                estatus: 'Pendiente'
                            });
                        }

                        const diferenciaTotal = parseFloat((totalFactura - pagos.reduce((acc, pago) => acc + pago.total, 0)).toFixed(2));
                        const diferenciaGanancia = parseFloat((gananciaTotal - pagos.reduce((acc, pago) => acc + pago.ganancia, 0)).toFixed(2));

                        if (diferenciaTotal !== 0) {
                            pagos[0].total += diferenciaTotal;
                        }

                        if (diferenciaGanancia !== 0) {
                            pagos[0].ganancia += diferenciaGanancia;
                        }

                        pagos = pagos.map(pago => ({
                            ...pago,
                            total: `${pago.total.toFixed(2)} ${moneda}` // Añadir moneda en esta etapa
                        }));

                        for (const pagoData of pagos) {
                            await addDoc(collection(dba, `facturas/${facturaRef.id}/pagos`), pagoData);
                        }
                    }

                    if (!estatusCheckbox.checked) {
                        await generatePDFHorizontal(numeroFacturaGlobal, totalFactura);
                    } else {
                        facturaTableBody.innerHTML = '';
                        document.getElementById('searchPatientInput').value = '';
                        searchInput.value = '';
                        descripcionInput.value = '';
                        disponibleInput.value = '';
                        precioInput.value = '';
                        ITBISInput.value = '';
                        cantidadFacturarInput.value = '';
                        searchResults.innerHTML = '';
                        searchDoctorInput.value = '';
                        document.getElementById('condicionPago').value = '';
                        document.getElementById('comprobanteCheckbox').checked = false;
                        document.getElementById('EstatusCheckbox').checked = false;
                        totalLabel.innerText = 'Total a pagar: RD$0.00';
                    }
                } catch (error) {
                    console.error('Error al guardar la factura en Storage:', error);
                } finally {
                    progressContainer.style.display = 'none';
                    fondoDesenfocado.style.display = 'none';
                }

                showSuccessAlert('La factura se ha generado y guardado exitosamente.', 'alert-success');
                doc.save('factura.pdf');
            };
        }



        async function getLastFacturaNumber() {
            try {
                const facturaSnapshot = await get(ref(db, 'facturaNumber'));
                if (facturaSnapshot.exists()) {
                    const facturaData = facturaSnapshot.val();
                    return facturaData.lastNumber || 0;
                } else {
                    console.warn('No se encontró un número de factura previo.');
                    return 0;
                }
            } catch (error) {
                console.error('Error al obtener el último número de factura:', error);
                return 0;
            }
        }

        async function updateLastFacturaNumber(newNumber) {
            try {
                const facturaRef = ref(db, 'facturaNumber/lastNumber');
                await set(facturaRef, newNumber);
                // console.log('Número de factura actualizado correctamente:', newNumber);
            } catch (error) {
                console.error('Error al actualizar el número de factura:', error);
            }
        }


        async function getPacienteInfoFromDatabase(pacienteName) {
            const pacientesSnapshot = await getDocs(collection(getFirestore(), 'pacientes'));

            const nombreNormalizado = pacienteName.trim().toLowerCase();

            const pacienteDoc = pacientesSnapshot.docs.find(doc => {
                const { fname, lname, direccion, telefono } = doc.data();
                const nombreCompleto = `${fname} ${lname}`.toLowerCase().trim();
                return nombreCompleto === nombreNormalizado;
            });

            if (pacienteDoc) {
                const data = pacienteDoc.data();
                return { id: pacienteDoc.id, direccion: data.location, telefono: data.number };
            } else {
                console.error(`Paciente no encontrado en la base de datos: ${pacienteName}`);
                return null;
            }
        }


        generatePDFButton.addEventListener('click', generatePDF);


        async function generatePDFHorizontal(numeroFacturaR, totalFactura) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); // Crear documento PDF en formato horizontal
            const progressContainer = document.getElementById('progress-container');
            const fondoDesenfocado = document.getElementById('fondoDesenfocado');
            const descripcionInput = document.getElementById('desp');

            const facturaTableBody = document.getElementById('facturaTableBody');
            const totalLabel = document.getElementById('totalLabel');
            const searchPatientInput = document.getElementById('searchPatientInput');
            const searchDoctorInput = document.getElementById('searchDoctorInput');
            const formaDePagoSelect = document.getElementById('formaDePago');

            const pacienteSeleccionado = searchPatientInput.value;
            const DoctorSeleccionado = searchDoctorInput.value;
            const formaDePagoSeleccionada = formaDePagoSelect.value;

            const searchInput = document.getElementById('searchInput');
            const disponibleInput = document.getElementById('disp');
            const precioInput = document.getElementById('precio');
            const ITBISInput = document.getElementById('itbis');
            const cantidadFacturarInput = document.getElementById('cantidadFacturar');
            const addToListButton = document.getElementById('addToListButton');
            const searchButton = document.getElementById('searchButton');
            const searchResults = document.getElementById('searchResults');
            const searchDoctorResults = document.getElementById('searchDoctorResults');

            // Obtener información del paciente (dirección y teléfono)
            const pacienteInfo = await getPacienteInfoFromDatabase(pacienteSeleccionado);
            if (!pacienteInfo) {
                showAlert('Paciente no encontrado en la base de datos. Verifique el nombre e inténtelo nuevamente.', 'alert-danger');
                return;
            }

            doc.setFontSize(12);

            progressContainer.style.display = 'block';
            fondoDesenfocado.style.display = 'block';

            const logoImage = new Image();
            logoImage.src = 'unoin.png';

            logoImage.onload = async () => {
                const logoWidth = 20;
                const logoHeight = (logoWidth / logoImage.width) * logoImage.height;
                const marginRight = 15;
                const marginTop = 5;
                doc.addImage(logoImage, 'PNG', doc.internal.pageSize.width - logoWidth - marginRight, marginTop, logoWidth, logoHeight);

                doc.setFontSize(18);
                doc.text("RECIBO", 14, 15);

                doc.setFontSize(12);
                const empresaSnapshot = await get(ref(db, 'datos/'));
                const empresaData = empresaSnapshot.val();

                if (empresaData) {
                    doc.text(`${empresaData.name}`, 15, 25);
                    doc.text(`RNC: ${empresaData.rnc}`, 15, 30);
                    doc.text(`Teléfono: ${empresaData.number}`, 15, 35);

                    const location = empresaData.location;
                    if (location.length > 15) {
                        const firstLine = location.substring(0, 23);
                        let secondLine = location.substring(23);
                        if (secondLine.length > 35) {
                            const secondLineFirstPart = secondLine.substring(0, 35);
                            const secondLineSecondPart = secondLine.substring(35);
                            secondLine = secondLineFirstPart + '\n' + secondLineSecondPart;
                        }
                        doc.text(`Dirección: ${firstLine}`, 15, 40);
                        doc.text(`${secondLine}`, 15, 45);
                    } else {
                        doc.text(`Dirección: ${empresaData.location}`, 17, 40);
                    }
                }

                const marginLeft = 15;
                const numeroRecibo = await obtenerNumeroRecibo();
                doc.text(`No. Recibo: ${numeroRecibo}`, marginLeft, 60);
                doc.text(`Referencia a Factura No. ${numeroFacturaR}`, marginLeft, 65);

                const fechaActual = obtenerFechaActual();
                const fechaActualF = obtenerFechaActualF();
                const fechaX = marginLeft;
                doc.text(`Fecha: ${fechaActual}`, fechaX, 70);

                doc.text(`Doctor: ${DoctorSeleccionado}`, marginLeft, 80);
                doc.text(`Facturado a: ${pacienteSeleccionado}`, marginLeft, 90);

                // Agregar dirección y teléfono del paciente
                doc.text(`Dirección: ${pacienteInfo.direccion}`, marginLeft, 95);
                doc.text(`Teléfono: ${pacienteInfo.telefono}`, marginLeft, 100);

                doc.line(14, 105, 280, 105); // Ajusta la longitud de la línea horizontal

                let moneda = '';
                doc.autoTable({
                    head: [['Descripción', 'Cantidad', 'Precio Unitario', 'ITBIS', 'Total']],
                    body: Array.from(facturaTableBody.querySelectorAll('tr')).map(row => {
                        const cells = row.querySelectorAll('td');
                        const totalCell = cells[4].textContent.trim();
                        moneda = totalCell.split(' ')[1]; // Asumimos que la moneda es la misma para todos los productos
                        return Array.from(cells).map(cell => cell.textContent);
                    }),
                    startY: 110
                });

                doc.text(totalLabel.textContent, 14, doc.lastAutoTable.finalY + 10);

                // Agregar la forma de pago al documento PDF
                doc.text(`Forma de Pago: ${formaDePagoSeleccionada}`, 14, doc.lastAutoTable.finalY + 20);

                const pdfBlob = doc.output('blob');

                try {
                    const storage = getStorage(app);

                    // Guardar en Storage usando el ID del paciente como carpeta
                    const pacienteFolderRef = storageRef(storage, `recibos/${pacienteInfo.id}/`);
                    let facturaStorageRef = storageRef(pacienteFolderRef, `${fechaActualF}.pdf`);

                    // Verificar si ya existe un archivo con el mismo nombre
                    let i = 1;
                    while (await getDownloadURL(facturaStorageRef).then(() => true).catch(() => false)) {
                        facturaStorageRef = storageRef(pacienteFolderRef, `${fechaActualF} (${i}).pdf`);
                        i++;
                    }

                    await uploadBytes(facturaStorageRef, pdfBlob);

                    const reciboURL = await getDownloadURL(facturaStorageRef);

                    const reciboData = {
                        paciente: pacienteSeleccionado,
                        doctor: DoctorSeleccionado,
                        numeroRecibo: numeroRecibo,
                        numeroFactura: numeroFacturaR,
                        fecha: fechaActual,
                        items: Array.from(facturaTableBody.querySelectorAll('tr')).map(row => ({
                            descripcion: row.cells[0].textContent,
                            cantidad: parseInt(row.cells[1].textContent),
                            precioUnitario: parseFloat(row.cells[2].textContent),
                            itbis: row.cells[3].textContent,
                            total: row.cells[4].textContent
                        })),
                        total: totalLabel.textContent.split(': ')[1],
                        formaDePago: formaDePagoSeleccionada,
                        urlRecibo: reciboURL
                    };

                    await addDoc(collection(dba, 'recibos'), reciboData);

                    // Limpiar campos y tabla
                    facturaTableBody.innerHTML = '';
                    searchPatientInput.value = '';
                    searchInput.value = '';
                    descripcionInput.value = '';
                    disponibleInput.value = '';
                    precioInput.value = '';
                    ITBISInput.value = '';
                    cantidadFacturarInput.value = '';
                    searchResults.innerHTML = '';
                    searchDoctorInput.value = '';
                    comprobanteCheckbox.checked = false;
                    totalLabel.innerText = 'Total a pagar: RD$0.00';

                } catch (error) {
                    console.error('Error al guardar el recibo en Storage:', error);
                } finally {
                    progressContainer.style.display = 'none';
                    fondoDesenfocado.style.display = 'none';
                }

                showSuccessAlert('El recibo se ha generado y guardado exitosamente.', 'alert-success');
                doc.save('recibo.pdf');
            };
        }












    </script>

    <script src="popper.min.js"></script>
    <script src="simplebar.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="custom-font.js"></script>
    <script src="pcoded.js"></script>
    <script src="feather.min.js"></script>




    <script>layout_change('light');</script>




    <script>font_change("Roboto");</script>


    <script>change_box_container('false');</script>


    <script>layout_caption_change('true');</script>




    <script>layout_rtl_change('false');</script>


    <script>preset_change("preset-1");</script>


</body>


</html>